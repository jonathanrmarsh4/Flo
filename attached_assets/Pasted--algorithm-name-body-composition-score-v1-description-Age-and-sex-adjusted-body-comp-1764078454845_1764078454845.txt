{
  "algorithm_name": "body_composition_score_v1",
  "description": "Age- and sex-adjusted body composition score from 0–100 based on lean body mass and weight. Uses estimated body fat percentage and compares it to an ideal range for the user’s age and sex.",
  "inputs": {
    "age": {
      "type": "number",
      "units": "years",
      "constraints": {
        "min": 18,
        "max": 100
      },
      "notes": "If age < 18, you may choose to not compute a score or treat as age = 18."
    },
    "sex": {
      "type": "string",
      "allowed_values": ["male", "female"],
      "notes": "Biological sex used for body fat reference ranges."
    },
    "leanBodyMassKg": {
      "type": "number",
      "units": "kg",
      "constraints": {
        "min": 20,
        "max": 200
      },
      "notes": "Lean body mass in kilograms."
    },
    "weightKg": {
      "type": "number",
      "units": "kg",
      "constraints": {
        "min": 20,
        "max": 300
      },
      "notes": "Total body weight in kilograms."
    }
  },
  "output": {
    "score": {
      "type": "number",
      "range": [0, 100],
      "description": "Body composition quality score from 0 (very poor) to 100 (optimal for age and sex)."
    },
    "estimatedBodyFatPercent": {
      "type": "number",
      "units": "%",
      "description": "Derived from lean body mass and weight, clamped to a reasonable range (3–60%)."
    }
  },
  "parameters": {
    "minBodyFatPercent": 3,
    "maxBodyFatPercent": 60,
    "underSpanPercent": 5,
    "overSpanPercent": 20,
    "insideRangeMinScore": 80,
    "insideRangeMaxScore": 100
  },
  "age_sex_ideal_body_fat_ranges": {
    "male": [
      {
        "age_min": 18,
        "age_max": 39.999,
        "ideal_min_bf_percent": 8,
        "ideal_max_bf_percent": 18
      },
      {
        "age_min": 40,
        "age_max": 59.999,
        "ideal_min_bf_percent": 11,
        "ideal_max_bf_percent": 21
      },
      {
        "age_min": 60,
        "age_max": 120,
        "ideal_min_bf_percent": 13,
        "ideal_max_bf_percent": 24
      }
    ],
    "female": [
      {
        "age_min": 18,
        "age_max": 39.999,
        "ideal_min_bf_percent": 21,
        "ideal_max_bf_percent": 32
      },
      {
        "age_min": 40,
        "age_max": 59.999,
        "ideal_min_bf_percent": 23,
        "ideal_max_bf_percent": 33
      },
      {
        "age_min": 60,
        "age_max": 120,
        "ideal_min_bf_percent": 24,
        "ideal_max_bf_percent": 35
      }
    ]
  },
  "algorithm_steps": [
    "1) Validate inputs: weightKg > 0, leanBodyMassKg > 0, leanBodyMassKg <= weightKg. If invalid, return score = 0.",
    "2) Compute raw body fat percentage as: bf = 100 * (1 - leanBodyMassKg / weightKg).",
    "3) Clamp bf to a reasonable range: bodyFatPercent = clamp(bf, minBodyFatPercent, maxBodyFatPercent).",
    "4) Look up the ideal body fat percentage range (idealMin, idealMax) based on age and sex using the age_sex_ideal_body_fat_ranges table.",
    "5) Compute idealMid = (idealMin + idealMax) / 2.",
    "6) If bodyFatPercent is between idealMin and idealMax (inclusive):",
    "   - Compute halfRange = (idealMax - idealMin) / 2.",
    "   - Compute distanceFromMid = abs(bodyFatPercent - idealMid).",
    "   - Compute centralness = 1 - distanceFromMid / halfRange  (centralness = 1 at mid, 0 at edges).",
    "   - Score = insideRangeMinScore + (insideRangeMaxScore - insideRangeMinScore) * centralness (default 80–100).",
    "7) Else if bodyFatPercent < idealMin (too lean):",
    "   - deficit = idealMin - bodyFatPercent.",
    "   - normalizedDeficit = clamp(deficit / underSpanPercent, 0, 1).",
    "   - Score = insideRangeMinScore * (1 - normalizedDeficit) (default 0–80).",
    "8) Else (bodyFatPercent > idealMax, too much fat):",
    "   - excess = bodyFatPercent - idealMax.",
    "   - normalizedExcess = clamp(excess / overSpanPercent, 0, 1).",
    "   - Score = insideRangeMinScore * (1 - normalizedExcess) (default 0–80).",
    "9) Clamp the final score to [0, 100] and round to nearest integer.",
    "10) Return both: { score, estimatedBodyFatPercent: bodyFatPercent }."
  ],
  "pseudocode": [
    "function clamp(x, minVal, maxVal):",
    "    return max(minVal, min(maxVal, x))",
    "",
    "function getIdealBodyFatRange(age, sex):",
    "    ranges = age_sex_ideal_body_fat_ranges[sex]",
    "    for each r in ranges:",
    "        if age >= r.age_min and age <= r.age_max:",
    "            return (r.ideal_min_bf_percent, r.ideal_max_bf_percent)",
    "    # fallback: return last range",
    "    return (ranges[-1].ideal_min_bf_percent, ranges[-1].ideal_max_bf_percent)",
    "",
    "function scoreBodyComposition(age, sex, leanBodyMassKg, weightKg):",
    "    if weightKg <= 0 or leanBodyMassKg <= 0 or leanBodyMassKg > weightKg:",
    "        return { score: 0, estimatedBodyFatPercent: null }",
    "",
    "    bf = 100 * (1 - leanBodyMassKg / weightKg)",
    "    bodyFatPercent = clamp(bf, minBodyFatPercent, maxBodyFatPercent)",
    "",
    "    (idealMin, idealMax) = getIdealBodyFatRange(age, sex)",
    "    idealMid = (idealMin + idealMax) / 2",
    "",
    "    if bodyFatPercent >= idealMin and bodyFatPercent <= idealMax:",
    "        halfRange = (idealMax - idealMin) / 2",
    "        if halfRange == 0:",
    "            score = insideRangeMaxScore",
    "        else:",
    "            distanceFromMid = abs(bodyFatPercent - idealMid)",
    "            centralness = 1 - distanceFromMid / halfRange",
    "            score = insideRangeMinScore + (insideRangeMaxScore - insideRangeMinScore) * centralness",
    "",
    "    else if bodyFatPercent < idealMin:",
    "        deficit = idealMin - bodyFatPercent",
    "        normalizedDeficit = clamp(deficit / underSpanPercent, 0, 1)",
    "        score = insideRangeMinScore * (1 - normalizedDeficit)",
    "",
    "    else:",
    "        excess = bodyFatPercent - idealMax",
    "        normalizedExcess = clamp(excess / overSpanPercent, 0, 1)",
    "        score = insideRangeMinScore * (1 - normalizedExcess)",
    "",
    "    score = clamp(round(score), 0, 100)",
    "    return { score: score, estimatedBodyFatPercent: bodyFatPercent }"
  ],
  "typescript_reference_implementation": "type Sex = 'male' | 'female';\n\ninterface BodyCompositionInput {\n  age: number;\n  sex: Sex;\n  leanBodyMassKg: number;\n  weightKg: number;\n}\n\ninterface BodyCompositionOutput {\n  score: number;\n  estimatedBodyFatPercent: number | null;\n}\n\nconst BODY_COMP_PARAMS = {\n  minBodyFatPercent: 3,\n  maxBodyFatPercent: 60,\n  underSpanPercent: 5,\n  overSpanPercent: 20,\n  insideRangeMinScore: 80,\n  insideRangeMaxScore: 100\n} as const;\n\nconst IDEAL_BF_RANGES: Record<Sex, { ageMin: number; ageMax: number; idealMin: number; idealMax: number; }[]> = {\n  male: [\n    { ageMin: 18, ageMax: 39.999, idealMin: 8,  idealMax: 18 },\n    { ageMin: 40, ageMax: 59.999, idealMin: 11, idealMax: 21 },\n    { ageMin: 60, ageMax: 120,   idealMin: 13, idealMax: 24 }\n  ],\n  female: [\n    { ageMin: 18, ageMax: 39.999, idealMin: 21, idealMax: 32 },\n    { ageMin: 40, ageMax: 59.999, idealMin: 23, idealMax: 33 },\n    { ageMin: 60, ageMax: 120,   idealMin: 24, idealMax: 35 }\n  ]\n};\n\nfunction clamp(x: number, minVal: number, maxVal: number
