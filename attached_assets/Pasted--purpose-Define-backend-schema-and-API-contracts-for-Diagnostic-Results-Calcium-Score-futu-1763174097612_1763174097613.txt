{
  "purpose": "Define backend schema and API contracts for Diagnostic Results (Calcium Score + future diagnostics) to feed the DiagnosticResultsScreen and CalciumScoreTile.",
  "database": {
    "dialect": "postgres",
    "tables": [
      {
        "name": "diagnostics_studies",
        "description": "Root table for all diagnostic studies (coronary calcium score, carotid IMT, DEXA, VO2, brain MRI, etc). One row per study.",
        "columns": [
          {
            "name": "id",
            "type": "uuid",
            "primaryKey": true,
            "default": "uuid_generate_v4()"
          },
          {
            "name": "user_id",
            "type": "uuid",
            "notNull": true,
            "references": "users.id"
          },
          {
            "name": "type",
            "type": "text",
            "notNull": true,
            "description": "Diagnostic type, e.g. 'coronary_calcium_score', 'carotid_imt', 'dexa_scan', 'vo2_max', 'brain_mri'."
          },
          {
            "name": "source",
            "type": "text",
            "notNull": true,
            "default": "uploaded_pdf",
            "description": "'uploaded_pdf' | 'manual_entry' | 'api'."
          },
          {
            "name": "study_date",
            "type": "date",
            "notNull": true
          },
          {
            "name": "age_at_scan",
            "type": "integer",
            "notNull": false
          },
          {
            "name": "total_score_numeric",
            "type": "numeric",
            "notNull": false,
            "description": "For CAC this is total Agatston score; for other diagnostics can be main numeric summary."
          },
          {
            "name": "risk_category",
            "type": "text",
            "notNull": false,
            "description": "Normalized risk bucket e.g. 'zero', 'minimal', 'mild', 'moderate', 'severe'."
          },
          {
            "name": "age_percentile",
            "type": "integer",
            "notNull": false,
            "description": "Age-matched percentile if available, 0–100."
          },
          {
            "name": "ai_payload",
            "type": "jsonb",
            "notNull": true,
            "description": "Full structured JSON output from the AI extraction step for this study."
          },
          {
            "name": "status",
            "type": "text",
            "notNull": true,
            "default": "parsed",
            "description": "'parsed' | 'needs_review' | 'failed'."
          },
          {
            "name": "created_at",
            "type": "timestamp",
            "notNull": true,
            "default": "now()"
          },
          {
            "name": "updated_at",
            "type": "timestamp",
            "notNull": true,
            "default": "now()"
          }
        ],
        "indexes": [
          {
            "name": "diagnostics_studies_user_type_date_idx",
            "columns": ["user_id", "type", "study_date"],
            "unique": false
          }
        ]
      },
      {
        "name": "diagnostic_metrics",
        "description": "Flexible key/value metrics table per diagnostic study (e.g. per-vessel CAC scores, IMT left/right, etc.).",
        "columns": [
          {
            "name": "id",
            "type": "uuid",
            "primaryKey": true,
            "default": "uuid_generate_v4()"
          },
          {
            "name": "study_id",
            "type": "uuid",
            "notNull": true,
            "references": "diagnostics_studies.id",
            "onDelete": "cascade"
          },
          {
            "name": "code",
            "type": "text",
            "notNull": true,
            "description": "Machine-friendly metric code, e.g. 'total_agatston', 'lad_score', 'rca_score', 'imt_left'."
          },
          {
            "name": "label",
            "type": "text",
            "notNull": true,
            "description": "Human-readable label for display."
          },
          {
            "name": "value_numeric",
            "type": "numeric",
            "notNull": false
          },
          {
            "name": "unit",
            "type": "text",
            "notNull": false
          },
          {
            "name": "extra",
            "type": "jsonb",
            "notNull": false,
            "description": "Optional additional metadata for the metric."
          }
        ],
        "indexes": [
          {
            "name": "diagnostic_metrics_study_code_idx",
            "columns": ["study_id", "code"],
            "unique": false
          }
        ]
      }
    ]
  },
  "typescriptTypes": {
    "CalciumScoreSummary": {
      "description": "Shape used by the CalciumScoreTile in the DiagnosticResultsScreen.",
      "definition": "export interface CalciumScoreSummary { studyId: string; studyDate: string; source: 'uploaded_pdf' | 'manual_entry' | 'api'; totalAgatston: number; ageAtScan: number | null; riskCategory: 'zero' | 'minimal' | 'mild' | 'moderate' | 'severe'; agePercentile: number | null; riskColor: 'green' | 'yellow' | 'orange' | 'red'; oneLineInsight: string; perVesselScores?: { lad?: number | null; lcx?: number | null; rca?: number | null; lm?: number | null; other?: Record<string, number | null>; }; }"
    },
    "DiagnosticResultsSummary": {
      "description": "Top-level API shape returned to populate DiagnosticResultsScreen.",
      "definition": "export interface DiagnosticResultsSummary { cardiovascular: { calciumScore: CalciumScoreSummary | null; carotidImt: GenericDiagnosticSummary | null; }; metabolic: { dexaScan: GenericDiagnosticSummary | null; vo2MaxTest: GenericDiagnosticSummary | null; }; cognitive: { brainMri: GenericDiagnosticSummary | null; }; }"
    },
    "GenericDiagnosticSummary": {
      "description": "Simple summary for non-implemented diagnostics (Carotid IMT, DEXA, VO2, Brain MRI, etc.).",
      "definition": "export interface GenericDiagnosticSummary { studyId: string; studyDate: string; type: string; title: string; subtitle?: string; mainValue?: string | number | null; unit?: string | null; status: 'available' | 'coming_soon' | 'not_uploaded'; }"
    }
  },
  "aiPayloadContract": {
    "description": "Exact JSON structure expected from the AI extractor for a coronary calcium score report. This payload is stored in diagnostics_studies.ai_payload and then normalised into columns.",
    "type": "coronary_calcium_score",
    "version": "1.0",
    "example": {
      "type": "coronary_calcium_score",
      "version": "1.0",
      "source_document": {
        "filename": "calcium_score_example.pdf",
        "page_numbers": [1],
        "lab_name": "Example Radiology Group",
        "report_id": "ABC12345"
      },
      "patient_context": {
        "reported_age": 51,
        "reported_sex": "male"
      },
      "study": {
        "study_date": "2024-10-05",
        "scanner_type": "CT",
        "calcium_score_method": "Agatston"
      },
      "results": {
        "total_agatston": 12,
        "per_vessel": {
          "lad": 8,
          "rca": 4,
          "lcx": 0,
          "lm": 0,
          "other": {}
        },
        "age_matched_percentile": 25,
        "risk_category": "minimal",
        "risk_category_human": "Minimal plaque burden",
        "reference_ranges": {
          "zero": "0",
          "minimal": "1–10",
          "mild": "11–100",
          "moderate": "101–400",
          "severe": ">400"
        }
      },
      "interpretation": {
        "one_liner": "Minimal coronary artery calcification, low risk compared to age-matched peers.",
        "detail": "A total Agatston score of 12 indicates minimal calcified plaque. This is associated with low short-term risk of coronary events, especially when blood pressure, lipids and lifestyle are well controlled.",
        "clinical_flags": [
          "continue_lifestyle_optimisation",
          "review_lipids_and_bp",
          "reassess_in_3_to_5_years_if_risk_profile_changes"
        ]
      },
      "quality": {
        "confidence": 0.96,
        "extraction_issues": []
      }
    },
    "normalisationRules": [
      {
        "from": "ai_payload.study.study_date",
        "to": "diagnostics_studies.study_date"
      },
      {
        "from": "ai_payload.patient_context.reported_age",
        "to": "diagnostics_studies.age_at_scan"
      },
      {
        "from": "ai_payload.results.total_agatston",
        "to": "diagnostics_studies.total_score_numeric"
      },
      {
        "from": "ai_payload.results.risk_category",
        "to": "diagnostics_studies.risk_category"
      },
      {
        "from": "ai_payload.results.age_matched_percentile",
        "to": "diagnostics_studies.age_percentile"
      }
    ],
    "metricMappingExamples": [
      {
        "study_type": "coronary_calcium_score",
        "metrics": [
          {
            "code": "total_agatston",
            "label": "Total Agatston Score",
            "source_path": "results.total_agatston",
            "unit": "Agatston"
          },
          {
            "code": "lad_score",
            "label": "LAD Score",
            "source_path": "results.per_vessel.lad",
            "unit": "Agatston"
          },
          {
            "code": "rca_score",
            "label": "RCA Score",
            "source_path": "results.per_vessel.rca",
            "unit": "Agatston"
          },
          {
            "code": "lcx_score",
            "label": "LCx Score",
            "source_path": "results.per_vessel.lcx",
            "unit": "Agatston"
          },
          {
            "code": "lm_score",
            "label": "Left Main Score",
            "source_path": "results.per_vessel.lm",
            "unit": "Agatston"
          }
        ]
      }
    ]
  },
  "apiContracts": {
    "getDiagnosticsSummary": {
      "method": "GET",
      "path": "/api/diagnostics/summary",
      "description": "Return the latest diagnostic results per category for the authenticated user to populate DiagnosticResultsScreen.",
      "responseExample": {
        "cardiovascular": {
          "calciumScore": {
            "studyId": "c9f4b7e8-1234-4321-9999-abcabcabcabc",
            "studyDate": "2024-10-05",
            "source": "uploaded_pdf",
            "totalAgatston": 12,
            "ageAtScan": 51,
            "riskCategory": "minimal",
            "agePercentile": 25,
            "riskColor": "green",
            "oneLineInsight": "Minimal coronary calcification, low age-adjusted risk.",
            "perVesselScores": {
              "lad": 8,
              "rca": 4,
              "lcx": 0,
              "lm": 0,
              "other": {}
            }
          },
          "carotidImt": null
        },
        "metabolic": {
          "dexaScan": null,
          "vo2MaxTest": null
        },
        "cognitive": {
          "brainMri": null
        }
      }
    }
  }
}
