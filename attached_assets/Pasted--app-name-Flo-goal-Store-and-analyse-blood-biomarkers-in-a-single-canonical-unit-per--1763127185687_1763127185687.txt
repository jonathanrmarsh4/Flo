{
  "app_name": "Flo",
  "goal": "Store and analyse blood biomarkers in a single canonical unit per biomarker, while supporting different lab units and reference ranges by country/lab in a simple, scalable way.",
  "data_model": {
    "tables": [
      {
        "name": "biomarkers",
        "purpose": "Master list of biomarkers and their canonical units and default reference ranges.",
        "columns": [
          { "name": "id", "type": "string", "notes": "Primary key (UUID)." },
          { "name": "name", "type": "string", "notes": "Standard biomarker name, e.g. 'Testosterone Total'." },
          { "name": "short_name", "type": "string", "notes": "Optional short code, e.g. 'TESTO_T'." },
          { "name": "canonical_unit", "type": "string", "notes": "Single internal unit used everywhere in the system, e.g. 'nmol/L'." },
          { "name": "global_default_ref_min", "type": "number|null", "notes": "Default lower ref limit in canonical_unit, null if not defined." },
          { "name": "global_default_ref_max", "type": "number|null", "notes": "Default upper ref limit in canonical_unit, null if not defined." },
          { "name": "category", "type": "string", "notes": "E.g. 'Hormones', 'Lipids', 'Metabolic', 'Renal', etc." },
          { "name": "notes", "type": "string", "notes": "Optional notes for medical context or display." }
        ]
      },
      {
        "name": "reference_profiles",
        "purpose": "Profiles for country / lab / sex / age specific ranges.",
        "columns": [
          { "name": "id", "type": "string", "notes": "Primary key (UUID)." },
          { "name": "name", "type": "string", "notes": "Human readable, e.g. 'Australia – Adult Male 18–65'." },
          { "name": "country_code", "type": "string", "notes": "ISO country code, e.g. 'AU', 'US'." },
          { "name": "lab_name", "type": "string|null", "notes": "Optional lab name, e.g. 'Sullivan Nicolaides', 'LabCorp'." },
          { "name": "sex", "type": "string", "notes": "E.g. 'M', 'F', 'Any'." },
          { "name": "age_min", "type": "number|null", "notes": "Minimum age in years, inclusive, null if not constrained." },
          { "name": "age_max", "type": "number|null", "notes": "Maximum age in years, inclusive, null if not constrained." },
          { "name": "is_default_for_country", "type": "boolean", "notes": "True if this is the default profile for that country when nothing else matches." }
        ]
      },
      {
        "name": "reference_profile_ranges",
        "purpose": "Per-biomarker reference ranges tied to a specific profile and unit as reported by that lab/country.",
        "columns": [
          { "name": "id", "type": "string", "notes": "Primary key (UUID)." },
          { "name": "profile_id", "type": "string", "notes": "FK → reference_profiles.id." },
          { "name": "biomarker_id", "type": "string", "notes": "FK → biomarkers.id." },
          { "name": "unit", "type": "string", "notes": "Unit used in that lab/profile, e.g. 'ng/dL', 'mmol/L'." },
          { "name": "ref_min", "type": "number", "notes": "Lower ref limit in the profile-specific unit." },
          { "name": "ref_max", "type": "number", "notes": "Upper ref limit in the profile-specific unit." }
        ]
      },
      {
        "name": "unit_conversion_rules",
        "purpose": "Centralised, biomarker-specific unit conversions.",
        "columns": [
          { "name": "id", "type": "string", "notes": "Primary key (UUID)." },
          { "name": "biomarker_id", "type": "string", "notes": "FK → biomarkers.id. Needed because some biomarkers have biomarker-specific conversion factors." },
          { "name": "from_unit", "type": "string", "notes": "E.g. 'ng/dL'." },
          { "name": "to_unit", "type": "string", "notes": "E.g. 'nmol/L'." },
          { "name": "multiplier", "type": "number", "notes": "Value * multiplier + offset = converted value." },
          { "name": "offset", "type": "number", "notes": "Usually 0, included for completeness." }
        ]
      },
      {
        "name": "lab_reports",
        "purpose": "Top-level record per uploaded lab report.",
        "columns": [
          { "name": "id", "type": "string", "notes": "Primary key (UUID)." },
          { "name": "user_id", "type": "string", "notes": "FK → users.id." },
          { "name": "source_filename", "type": "string", "notes": "Original filename of the uploaded PDF or file." },
          { "name": "lab_name_detected", "type": "string|null", "notes": "Lab name extracted from document if detected." },
          { "name": "country_code_detected", "type": "string|null", "notes": "Country code inferred from lab or user profile." },
          { "name": "report_date", "type": "string", "notes": "ISO date of the sample/collection." },
          { "name": "raw_text", "type": "string", "notes": "Optional: full or partial raw text extracted from PDF for audit/debug." },
          { "name": "gpt_parse_payload", "type": "json", "notes": "Raw output from ChatGPT parsing before normalisation." }
        ]
      },
      {
        "name": "lab_results",
        "purpose": "Individual biomarker results from a report, stored in canonical units plus raw values for audit.",
        "columns": [
          { "name": "id", "type": "string", "notes": "Primary key (UUID)." },
          { "name": "lab_report_id", "type": "string", "notes": "FK → lab_reports.id." },
          { "name": "biomarker_id", "type": "string", "notes": "FK → biomarkers.id." },
          { "name": "biomarker_name_raw", "type": "string", "notes": "Name as it appeared on the report." },
          { "name": "value_raw", "type": "number", "notes": "Numeric value as reported by the lab." },
          { "name": "unit_raw", "type": "string", "notes": "Unit as reported by the lab, e.g. 'ng/dL'." },
          { "name": "ref_range_raw", "type": "string", "notes": "Original ref range text, e.g. '300–1000 ng/dL'." },
          { "name": "canonical_value", "type": "number", "notes": "Value converted into the canonical_unit from biomarkers." },
          { "name": "canonical_unit", "type": "string", "notes": "Copy of biomarkers.canonical_unit for convenience." },
          { "name": "canonical_ref_min", "type": "number|null", "notes": "Ref min converted into canonical_unit (from profile or default)." },
          { "name": "canonical_ref_max", "type": "number|null", "notes": "Ref max converted into canonical_unit (from profile or default)." },
          { "name": "profile_id_used", "type": "string|null", "notes": "Which reference profile was used, if any." }
        ]
      },
      {
        "name": "user_settings",
        "purpose": "Per-user preferences, including preferred display units.",
        "columns": [
          { "name": "user_id", "type": "string", "notes": "Primary key / FK → users.id." },
          { "name": "country_code", "type": "string", "notes": "User’s primary country, e.g. 'AU'." },
          { "name": "default_display_unit_mode", "type": "string", "notes": "Either 'canonical' or 'profile'. 'canonical' = show canonical units; 'profile' = show units used by their local lab/country profile if available." },
          { "name": "preferred_units_overrides", "type": "json", "notes": "Optional per-biomarker overrides, e.g. { 'TESTO_T': 'ng/dL' }." }
        ]
      }
    ]
  },
  "business_logic": {
    "unit_conversion": {
      "description": "All unit conversions are handled by a single function using unit_conversion_rules.",
      "function_signature_example": "convert(value: number, fromUnit: string, toUnit: string, biomarkerId: string): number",
      "rules": "Look up a row in unit_conversion_rules by biomarker_id + from_unit + to_unit. If found, apply value * multiplier + offset."
    },
    "reference_profile_selection": {
      "description": "Select the best matching reference profile for a given result.",
      "inputs": [
        "user.country_code",
        "user.sex",
        "user.age",
        "lab_reports.country_code_detected",
        "lab_reports.lab_name_detected"
      ],
      "steps": [
        "Try to find a profile with matching lab_name, country_code, sex, and age range.",
        "If none, try country_code + sex + age range.",
        "If none, use country default where is_default_for_country = true.",
        "If still none, fall back to global_default_ref_min and global_default_ref_max from biomarkers."
      ]
    },
    "normalisation_pipeline": {
      "description": "Convert GPT-parsed lab results into canonical units and store them.",
      "steps": [
        "Receive GPT output: an array of parsed results with biomarker_name_raw, value_raw, unit_raw, ref_range_raw.",
        "For each result, map biomarker_name_raw to biomarkers.id using string matching and a mapping dictionary.",
        "Convert value_raw (unit_raw) to canonical_value (canonical_unit) via unit_conversion_rules.",
        "Select the appropriate reference profile using reference_profile_selection.",
        "If reference_profile_ranges exists for that biomarker_id and profile_id, parse its ref_min/ref_max and convert them to canonical_unit.",
        "If no profile range exists, use biomarkers.global_default_ref_min/max.",
        "Store a row in lab_results with raw values, canonical values, and which profile was used."
      ]
    },
    "display_logic": {
      "description": "Decide what the user sees in the app, without changing storage.",
      "modes": [
        "canonical: show canonical_value and canonical_unit with canonical_ref_min/max.",
        "profile: convert canonical_value and canonical_ref_min/max into the profile’s or user’s preferred display unit (using unit_conversion_rules)."
      ],
      "example_display_fields": [
        "display_value",
        "display_unit",
        "display_ref_min",
        "display_ref_max",
        "is_high_or_low_flag"
      ]
    }
  }
}
