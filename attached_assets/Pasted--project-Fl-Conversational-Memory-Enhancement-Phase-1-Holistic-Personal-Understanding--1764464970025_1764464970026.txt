{
  "project": "Flō – Conversational Memory Enhancement (Phase 1 – Holistic Personal Understanding)",
  "goal": "Give the AI perfect, persistent memory of everything the user says, including mental wellbeing, habits, personal life, and broader context that impacts health — without touching existing health tables",
  "risk_level": "Zero risk to current data",
  "delivery_timeline": "Shippable in <7 days",
  "success_metric": "User says: 'How did you remember that from two weeks ago?!' — with AI showing empathy for mental states or personal habits",

  "database": {
    "table_name": "user_memory",
    "sql_schema": [
      "create table user_memory (",
      "  id           bigint primary key generated by default as identity,",
      "  user_id      uuid not null references auth.users on delete cascade,",
      "  session_id   uuid,",
      "  occurred_at  timestamptz default now(),",
      "  memory       jsonb not null default '{}'::jsonb,",
      "  tags         text[] default '{}',",
      "  created_at   timestamptz default now()",
      ");",
      "",
      "alter table user_memory enable row level security;",
      "",
      "create policy \"owner only\" on user_memory",
      "  for all using (user_id = auth.uid()) with check (user_id = auth.uid());",
      "",
      "create index idx_user_memory_user_time on user_memory(user_id, occurred_at desc);",
      "create index idx_user_memory_tags on user_memory using gin(tags);",
      "create index idx_user_memory_json on user_memory using gin(memory jsonb_path_ops);"
    ]
  },

  "memory_payload_examples": [
    {
      "type": "goal_set",
      "raw": "I want to run a half-marathon by June and get my fasting insulin below 8",
      "extracted": {
        "goals": ["half_marathon", "fasting_insulin < 8"],
        "target_date": "2026-06-30",
        "metrics": ["fasting_insulin"]
      },
      "importance": "high",
      "tags": ["goal", "fitness", "blood_sugar"]
    },
    {
      "type": "symptom",
      "raw": "I still crash every day at 3pm if I don’t eat protein in the morning",
      "extracted": {
        "symptom": "afternoon_energy_crash",
        "trigger": "low_morning_protein",
        "time": "15:00"
      },
      "linked_to": ["blood_glucose", "hrv"],
      "importance": "high"
    },
    {
      "type": "mood_report",
      "raw": "I've been feeling really stressed at work lately, it's making me skip workouts",
      "extracted": {
        "mood": "stressed",
        "trigger": "work",
        "impact": "skipping_workouts"
      },
      "importance": "high",
      "tags": ["mental_health", "habit", "stress"]
    },
    {
      "type": "personal_interest",
      "raw": "I love reading sci-fi books to unwind after a long day",
      "extracted": {
        "interest": "sci-fi_books",
        "purpose": "unwind",
        "frequency": "after_long_day"
      },
      "importance": "medium",
      "tags": ["relaxation", "habit", "mental_wellbeing"]
    },
    {
      "type": "life_context",
      "raw": "My family is planning a trip next month, excited but worried about my diet",
      "extracted": {
        "event": "family_trip",
        "emotions": ["excited", "worried"],
        "concerns": ["diet_maintenance"]
      },
      "importance": "medium",
      "tags": ["personal_life", "emotions", "habits"]
    }
  ],

  "extraction_prompt": {
    "system": "You are an expert personal context extractor. Extract every concrete fact, goal, preference, symptom, mood, habit, interest, relationship, stress factor, life event, or other personal detail from the conversation below. Include aspects of mental wellbeing, daily habits, and broader life context that could influence health or behavior.\n\nReturn valid JSON only (no markdown). Use this exact schema:\n\n{\n  \"memories\": [\n    {\n      \"type\": \"goal_set|goal_update|symptom|preference|mood_report|habit|personal_interest|life_context|relationship|stress_factor|treatment|supplement|trigger|other\",\n      \"raw\": \"exact user quote that contains the fact\",\n      \"extracted\": { \"key-value representation of the detail\" },\n      \"importance\": \"high|medium|low\",\n      \"tags\": [\"goal\", \"sleep\", \"blood_sugar\", \"mental_health\", \"habit\", ...]\n    }\n  ]\n}\n\nIf nothing meaningful → return { \"memories\": [] }\n\nConversation:\n{conversation}"
  },

  "retrieval": {
    "simple_recent": "SELECT memory, occurred_at FROM user_memory WHERE user_id = $1 ORDER BY occurred_at DESC LIMIT 25;",
    "injection_format": "Past context about this user (most recent first):\n{memories_bullets}"
  },

  "code_snippets": {
    "typescript_retrieval": "async function getUserMemories(userId: string, limit = 25) {\n  const { data } = await supabase\n    .from('user_memory')\n    .select('memory, occurred_at')\n    .eq('user_id', userId)\n    .order('occurred_at', { ascending: false })\n    .limit(limit);\n\n  if (!data?.length) return '';\n\n  return data.map(row => {\n    const m = row.memory;\n    return `- ${m.raw || JSON.stringify(m.extracted)}`;\n  }).join('\\n');\n}",
    
    "typescript_chat_loop": "async function handleChat(userId: string, userMessage: string) {\n  const memories = await getUserMemories(userId);\n  const systemPrompt = `You are a helpful, friendly assistant.\\n${memories ? 'Past context about this user (use naturally):\\n' + memories : ''}`;\n\n  const response = await openai.chat.completions.create({\n    model: 'gpt-4o-mini', // or your model\n    messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userMessage }]\n  });\n\n  const aiText = response.choices[0].message.content;\n  await storeConversationMemory(userId, `User: ${userMessage}\\nAI: ${aiText}`);\n  return aiText;\n}",

    "store_function_stub": "async function storeConversationMemory(userId: string, conversation: string) {\n  const result = await openai.chat.completions.create({\n    model: 'gpt-4o-mini',\n    temperature: 0,\n    messages: [{ role: 'system', content: EXTRACT_PROMPT }, { role: 'user', content: conversation }]\n  });\n  const parsed = JSON.parse(result.choices[0].message.content);\n  for (const mem of parsed.memories) {\n    await supabase.from('user_memory').insert({ user_id: userId, memory: mem, tags: mem.tags || [] });\n  }\n}"
  },

  "rollout_plan": [
    "Day 1: Run SQL → create table + RLS + indexes",
    "Day 2: Implement extraction + insert after every turn (use updated broad prompt)",
    "Day 3: Add retrieval + inject into prompt (start with minimal test AI)",
    "Day 4–5: Test cross-session recall with your unguarded AI, focusing on mental/personal details",
    "Week 2: Port to health-guarded AI (just swap system prompt)",
    "Future: Add pgvector embeddings on same table for semantic search"
  ],

  "notes_for_dev": [
    "Extraction is now broadened to capture holistic personal details, including mental wellbeing and life context — test with non-health chats to verify",
    "Start testing on the minimal-guardrail AI first — you’ll see the magic instantly, e.g., recalling moods or interests",
    "Keep prompt injection <500 tokens (25 memories max)",
    "No changes to existing health tables or RAG system required",
    "This is fully reversible — just stop writing to user_memory if needed"
  ]
}