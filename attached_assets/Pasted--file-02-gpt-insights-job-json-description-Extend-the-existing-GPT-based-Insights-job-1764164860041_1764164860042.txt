{
  "file": "02_gpt_insights_job.json",
  "description": "Extend the existing GPT-based Insights job so that, after generating insights, it also writes them into user_insights and the vector index. This does NOT change the current user-facing insights output.",
  "input_contract": {
    "user_snapshot": {
      "description": "The same data structure currently used by the GPT Insights job.",
      "fields": {
        "user_id": "uuid",
        "demographics": "age, sex, etc.",
        "labs": "normalised biomarkers, trends, flags",
        "diagnostics": "DEXA, CAC, etc.",
        "wearable": "sleep, HRV, HR, steps, workouts, etc.",
        "time_window": "e.g. last_90_days, last_6_months"
      }
    }
  },
  "llm_call": {
    "model": "gpt-X-insights-model",
    "temperature": 0.3,
    "max_tokens": 1200,
    "system_prompt": "You are Fl≈ç's analytical health engine. You receive a rich JSON snapshot of a single user's biomarker trends, diagnostics, and wearable data. Your job is to identify the most important health insights and express them as short, human-readable notes plus simple tags. Each insight must:\n- Be grounded in the data you see\n- Explain what is happening and why it matters\n- Be written as if speaking to a smart, motivated adult\nYou are NOT a doctor and must not provide diagnoses. Focus on patterns, trends and behaviour-linked observations.",
    "user_prompt_template": "Here is a JSON snapshot of a single user's health data and trends over the last {{time_window}}:\n\n```json\n{{user_snapshot_json}}\n```\n\nBased on this, output between 1 and 5 of the MOST IMPORTANT insights right now.\n\nRespond ONLY with a JSON array of objects in this exact format:\n[\n  {\n    \"text\": \"<short paragraph describing the insight in natural language>\",\n    \"tags\": [\"tag1\", \"tag2\", \"tag3\"],\n    \"importance\": <integer 1-5, where 5 is critical or high impact>\n  }\n]\n\nRules:\n- tags must be lowercase, short, and generic (e.g. \"lipids\", \"sleep\", \"hrv\", \"training-load\", \"blood-pressure\", \"metabolic\", \"alcohol\", \"shift-work\").\n- Do NOT include user identifiers in text or tags.\n- Do NOT mention that you are an AI.",
    "expected_output_schema": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "text",
          "tags",
          "importance"
        ],
        "properties": {
          "text": {
            "type": "string"
          },
          "tags": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "importance": {
            "type": "integer",
            "minimum": 1,
            "maximum": 5
          }
        }
      }
    }
  },
  "post_processing": {
    "steps": [
      "Parse the JSON array returned by the model.",
      "For each item, insert a row into user_insights with: user_id, text, tags, importance, source = 'gpt_insights_job', status = 'active'.",
      "Generate an embedding from `text` using the standard embedding model and upsert into the `user_insights_embedding` index with metadata { user_id, insight_id, importance, tags, created_at }.",
      "This write is fire-and-forget or performed in a background worker so it does not slow down existing insight rendering."
    ]
  },
  "non_blocking_principles": [
    "Do NOT alter the existing user-visible insights output path.",
    "If this new persistence step fails, the original insights flow must still succeed.",
    "Batch database and vector writes where possible to minimise load."
  ]
}
