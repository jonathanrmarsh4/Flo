{
  "file": "05_chat_summary_job.json",
  "description": "Nightly (or periodic) GPT job that scans recent Flo chat transcripts for a user and distills new, durable health insights into user_insights. This is additive, low-frequency, and must not impact real-time chat performance.",
  "schedule": {
    "recommended_frequency": "daily",
    "recommended_window": "off-peak hours per user timezone",
    "batching_strategy": "process users in small batches to avoid load spikes"
  },
  "input_contract": {
    "user_id": "uuid",
    "chat_transcripts": {
      "description": "Recent chat messages between user and Flo within a defined window (e.g. last 24–72 hours).",
      "structure": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "timestamp": {
              "type": "timestamptz"
            },
            "sender": {
              "type": "string",
              "enum": [
                "user",
                "flo"
              ]
            },
            "message": {
              "type": "string"
            }
          },
          "required": [
            "timestamp",
            "sender",
            "message"
          ]
        }
      }
    },
    "key_metrics_snapshot": {
      "description": "Optional but recommended: compact JSON summary of current relevant metrics.\nThis is the same or a subset of what is used by the GPT Insights job.",
      "example_fields": {
        "latest_labs": "high-level lipid, glucose, inflammation markers",
        "recent_trends": "HRV trend, sleep duration trend, resting HR trend, steps trend, etc.",
        "active_flags": "any notable risk flags or important changes"
      }
    },
    "time_window": {
      "description": "Defines how far back chats are included (e.g. last_24h, last_72h).",
      "type": "string"
    }
  },
  "llm_call": {
    "model": "gpt-X-summary-model",
    "temperature": 0.3,
    "max_tokens": 1000,
    "system_prompt": "You are Flō's long-term memory curator. You review recent conversations between Flō and a single user, plus a lightweight snapshot of their health metrics.\n\nYour job:\n- Detect any NEW, PERSISTENT, or IMPORTANT patterns, habits, life events, goals, or concerns the user has mentioned that should be remembered.\n- Express these as short natural-language insights, each with a few simple tags and an importance rating.\n\nWhat to extract:\n- New or changed habits (sleep, training, alcohol, work schedule, nutrition, medications, supplements, etc.)\n- Long-term goals or priorities the user clearly cares about\n- Repeated concerns or themes (e.g. anxiety about specific markers, difficulty with sleep, shift work)\n- Explicit cause-effect ideas the user is testing or believes (e.g. \"night shifts destroyed my HRV\")\n\nWhat NOT to extract:\n- One-off small talk\n- Temporary feelings that are unlikely to matter beyond today\n- Short-lived events that won't affect health longer term\n\nYou are not a doctor. Do not create diagnoses or treatment plans. Focus on patterns, behaviours, and things the system should remember.",
    "user_prompt_template": "Here is a JSON array of recent chat messages between Flō and this user for the last {{time_window}}:\n\n```json\n{{chat_transcripts_json}}\n```\n\nHere is a compact snapshot of their current health metrics (optional, may be empty):\n\n```json\n{{key_metrics_snapshot_json}}\n```\n\nFrom this, extract ONLY the most important NEW or REINFORCED insights that should be stored as part of the user's long-term health memory.\n\nRespond ONLY with a JSON array of 0 to 5 objects in this exact format:\n[\n  {\n    \"text\": \"<short paragraph describing the insight in natural language>\",\n    \"tags\": [\"tag1\", \"tag2\", \"tag3\"],\n    \"importance\": <integer 1-5, where 5 is highly important for this user's health journey>\n  }\n]\n\nRules:\n- If there is nothing genuinely worth remembering, return an empty array [].\n- tags must be lowercase, short, and generic (e.g. \"sleep\", \"hrv\", \"shift-work\", \"alcohol\", \"training\", \"stress\", \"goal\", \"nutrition\").\n- Do NOT include names, emails, or identifiers.\n- Do NOT mention that you are summarising chat; just describe the insight itself.",
    "expected_output_schema": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "text",
          "tags",
          "importance"
        ],
        "properties": {
          "text": {
            "type": "string"
          },
          "tags": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "importance": {
            "type": "integer",
            "minimum": 1,
            "maximum": 5
          }
        }
      }
    }
  },
  "deduplication_and_conflict_handling": {
    "description": "We must avoid spamming user_insights with near-duplicate content from repeated chats.",
    "strategies": [
      "Before inserting a new insight, compute a hash (e.g. stable hash of normalised text) and/or perform a short vector similarity search against existing user_insights for the same user.",
      "If a new candidate is highly similar to an existing active insight (above a defined similarity threshold), you may either:\n- Skip inserting it, OR\n- Incrementally \"reinforce\" the existing one (e.g. bump importance, update updated_at).",
      "If an insight appears to contradict an existing one, prefer the most recent and change the older one's status to 'resolved' if appropriate."
    ]
  },
  "post_processing": {
    "steps": [
      "1. Parse the JSON array from the model. If parsing fails, log and abort without affecting other systems.",
      "2. If the array is empty, do nothing.",
      "3. For each item in the array, apply deduplication logic as described above.",
      "4. For each genuinely new insight, insert a row into user_insights with: user_id, text, tags, importance, source = 'chat_summary_job', status = 'active'.",
      "5. Generate an embedding from text and upsert into the user_insights_embedding index with appropriate metadata.",
      "6. All DB and vector writes should occur in a background context; this job is offline and must not affect real-time chat responses."
    ]
  },
  "non_blocking_principles": [
    "This job is entirely offline and asynchronous; failure must not affect live chat or existing insights.",
    "If the chat volume is high, the system can skip or throttle this job; functional correctness is more important than perfect coverage.",
    "No changes are required to existing chat or insights rendering paths; user_insights is a shared, additive memory layer.",
    "Resource use should be controlled via batching, rate limits, and model quotas to avoid impacting primary workloads."
  ]
}
