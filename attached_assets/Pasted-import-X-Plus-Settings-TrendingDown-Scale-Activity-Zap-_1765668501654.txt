import { X, Plus, Settings, TrendingDown, Scale, Activity, Zap, Calendar, Target, Moon, Footprints, Drumstick, Info } from 'lucide-react';
import { useState } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import { LineChart, Line, Area, AreaChart, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } from 'recharts';
import { ManualWeighInSheet } from './ManualWeighInSheet';
import { BodyCompSheet } from './BodyCompSheet';
import { GoalSetupFlow } from './GoalSetupFlow';

interface WeightModuleScreenProps {
  isDark: boolean;
  onClose: () => void;
}

type Tab = 'overview' | 'history' | 'setup';

export function WeightModuleScreen({ isDark, onClose }: WeightModuleScreenProps) {
  const [activeTab, setActiveTab] = useState<Tab>('overview');
  const [showWeighInSheet, setShowWeighInSheet] = useState(false);
  const [showBodyCompSheet, setShowBodyCompSheet] = useState(false);
  const [showGoalSetup, setShowGoalSetup] = useState(false);
  const [timeRange, setTimeRange] = useState<'30' | '90' | '180'>('30');

  // Mock data - in production this would come from backend
  const latestWeight = 75.2; // Current weight from latest measurement
  const goalWeight = 72.0;
  const currentBodyFat = 18.5; // Current body fat percentage
  const goalBodyFat = 15.0; // Target body fat %
  const currentLeanMass = 61.3; // kg of lean mass
  const goalLeanMass = 62.0; // Target lean mass (maintain/gain)
  
  // Weight chart data - 30 days historical + 60 days forecast
  const weightChartData = Array.from({ length: 90 }, (_, i) => {
    const daysAgo = 30 - i;
    const isHistorical = daysAgo >= 0;
    const isForecast = daysAgo < 0;
    const forecastDay = Math.abs(daysAgo);
    
    // Historical weight with natural variation
    let actualWeight = null;
    if (isHistorical) {
      actualWeight = 76.5 - (daysAgo * 0.045) + (Math.random() * 0.4 - 0.2);
    }
    
    // Forecast boundaries (fan out over time)
    let forecastLow = null;
    let forecastHigh = null;
    if (isForecast) {
      const trendWeight = latestWeight - (forecastDay * 0.04); // Losing 0.28kg/week
      const uncertainty = forecastDay * 0.015; // Uncertainty grows over time
      forecastLow = trendWeight - uncertainty;
      forecastHigh = trendWeight + uncertainty;
    }
    
    return {
      date: new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      dayIndex: i,
      actualWeight,
      forecastLow,
      forecastHigh,
      forecastRange: forecastLow && forecastHigh ? forecastHigh - forecastLow : null,
      forecastMid: forecastLow && forecastHigh ? (forecastLow + forecastHigh) / 2 : null,
      goal: goalWeight
    };
  });

  // Body composition data - 30 days historical + 60 days forecast
  const bodyCompData = Array.from({ length: 90 }, (_, i) => {
    const daysAgo = 30 - i;
    const isHistorical = daysAgo >= 0;
    const isForecast = daysAgo < 0;
    const forecastDay = Math.abs(daysAgo);
    
    // Historical body fat % with variation
    let actualBodyFat = null;
    let actualLeanMass = null;
    if (isHistorical) {
      actualBodyFat = 19.8 - (daysAgo * 0.045) + (Math.random() * 0.3 - 0.15);
      const historicalWeight = 76.5 - (daysAgo * 0.045);
      actualLeanMass = historicalWeight * (1 - actualBodyFat / 100);
    }
    
    // Forecast boundaries for body fat %
    let bodyFatLow = null;
    let bodyFatHigh = null;
    let leanMassLow = null;
    let leanMassHigh = null;
    if (isForecast) {
      const trendBodyFat = currentBodyFat - (forecastDay * 0.04);
      const uncertainty = forecastDay * 0.012;
      bodyFatLow = trendBodyFat - uncertainty;
      bodyFatHigh = trendBodyFat + uncertainty;
      
      const forecastWeight = latestWeight - (forecastDay * 0.04);
      leanMassLow = forecastWeight * (1 - bodyFatHigh / 100);
      leanMassHigh = forecastWeight * (1 - bodyFatLow / 100);
    }
    
    return {
      date: new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      dayIndex: i,
      actualBodyFat,
      actualLeanMass,
      bodyFatLow,
      bodyFatHigh,
      bodyFatRange: bodyFatLow && bodyFatHigh ? bodyFatHigh - bodyFatLow : null,
      bodyFatMid: bodyFatLow && bodyFatHigh ? (bodyFatLow + bodyFatHigh) / 2 : null,
      leanMassLow,
      leanMassHigh,
      leanMassMid: leanMassLow && leanMassHigh ? (leanMassLow + leanMassHigh) / 2 : null,
      goalBodyFat: goalBodyFat,
      goalLeanMass: goalLeanMass
    };
  });

  // Y-axis domain centered on current weight with ±5kg range
  const weightYDomain = [latestWeight - 5, latestWeight + 5];
  
  // Body fat Y-axis domain centered on current with ±5% range
  const bodyFatYDomain = [currentBodyFat - 5, currentBodyFat + 5];
  
  // Lean mass Y-axis domain
  const leanMassYDomain = [currentLeanMass - 5, currentLeanMass + 5];

  const mockHistory = [
    { id: '1', date: '2025-12-13', time: '07:15', weight: 75.2, bodyFat: 15.1, source: 'Apple Health', device: 'Withings Scale', editable: false },
    { id: '2', date: '2025-12-12', time: '07:20', weight: 75.3, bodyFat: null, source: 'Manual', device: null, editable: true },
    { id: '3', date: '2025-12-11', time: '07:10', weight: 75.4, bodyFat: 15.2, source: 'Apple Health', device: 'Withings Scale', editable: false },
    { id: '4', date: '2025-12-10', time: '07:25', weight: 75.6, bodyFat: null, source: 'Manual', device: null, editable: true },
  ];

  const mockDrivers = [
    { id: '1', title: 'Sleep consistency improving', subtitle: '7.5h avg last 7d', confidence: 'HIGH', icon: 'moon' },
    { id: '2', title: 'Step count up 15%', subtitle: '9,200 daily avg', confidence: 'MEDIUM', icon: 'footprints' },
    { id: '3', title: 'Protein intake steady', subtitle: '1.8g/kg body weight', confidence: 'HIGH', icon: 'drumstick' },
  ];

  const mockLevers = [
    { id: '1', title: 'Increase daily steps', subtitle: '+2,000 steps/day', effort: 'Low', effect: '±0.3 kg' },
    { id: '2', title: 'Add 1 strength session', subtitle: '30min, 2x/week', effort: 'Medium', effect: '±0.5 kg' },
    { id: '3', title: 'Earlier dinner time', subtitle: 'Shift to 6pm', effort: 'Low', effect: '±0.2 kg' },
  ];

  return (
    <div className="fixed inset-0 z-50 overflow-hidden">
      {/* Backdrop */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="absolute inset-0 bg-black/60 backdrop-blur-sm"
        onClick={onClose}
      />

      {/* Screen */}
      <motion.div
        initial={{ x: '100%' }}
        animate={{ x: 0 }}
        exit={{ x: '100%' }}
        transition={{ type: 'spring', damping: 30, stiffness: 300 }}
        className={`absolute inset-0 ${
          isDark 
            ? 'bg-gradient-to-b from-slate-900 to-black' 
            : 'bg-gradient-to-b from-white to-gray-50'
        }`}
      >
        {/* Header */}
        <div className={`sticky top-0 z-10 backdrop-blur-xl border-b ${
          isDark ? 'bg-slate-900/90 border-white/10' : 'bg-white/90 border-black/10'
        }`}>
          <div className="px-6 py-4 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className={`p-2 rounded-xl ${
                isDark ? 'bg-gradient-to-br from-purple-500/20 to-blue-500/20' : 'bg-gradient-to-br from-purple-100 to-blue-100'
              }`}>
                <Scale className={`w-5 h-5 ${isDark ? 'text-purple-400' : 'text-purple-600'}`} />
              </div>
              <h1 className={`text-xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                Weight & Composition
              </h1>
            </div>
            
            <button
              onClick={onClose}
              className={`p-2 rounded-xl transition-all hover:scale-110 ${
                isDark ? 'hover:bg-white/10' : 'hover:bg-black/5'
              }`}
            >
              <X className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-gray-600'}`} />
            </button>
          </div>

          {/* Tabs */}
          <div className="px-6 pb-2">
            <div className={`flex gap-2 p-1 rounded-xl ${
              isDark ? 'bg-white/5' : 'bg-gray-100'
            }`}>
              {[
                { id: 'overview' as const, label: 'Overview' },
                { id: 'history' as const, label: 'History' },
                { id: 'setup' as const, label: 'Setup' }
              ].map((tab) => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`flex-1 py-2 px-4 rounded-lg text-sm transition-all ${
                    activeTab === tab.id
                      ? isDark
                        ? 'bg-white text-black'
                        : 'bg-white text-gray-900 shadow-sm'
                      : isDark
                        ? 'text-white/70 hover:text-white'
                        : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="overflow-y-auto px-6 py-6 space-y-6" style={{ height: 'calc(100vh - 140px)' }}>
          
          {/* OVERVIEW TAB */}
          {activeTab === 'overview' && (
            <>
              {/* Hero Stats */}
              <div className={`rounded-2xl p-6 ${
                isDark ? 'bg-gradient-to-br from-purple-500/10 to-blue-500/10 border border-white/10' : 'bg-gradient-to-br from-purple-50 to-blue-50 border border-purple-200'
              }`}>
                <div className="flex items-start justify-between mb-4">
                  <div>
                    <p className={`text-sm mb-1 ${isDark ? 'text-white/70' : 'text-gray-700'}`}>Current weight</p>
                    <div className="flex items-baseline gap-2">
                      <span className={`text-5xl ${isDark ? 'text-white' : 'text-gray-900'}`}>75.2</span>
                      <span className={`text-2xl ${isDark ? 'text-white/50' : 'text-gray-500'}`}>kg</span>
                    </div>
                    <p className={`text-xs mt-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Last weigh-in: 2h ago</p>
                  </div>
                  
                  <div className={`px-3 py-1.5 rounded-full text-xs ${
                    isDark ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-green-100 text-green-700 border border-green-200'
                  }`}>
                    On track
                  </div>
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={() => setShowWeighInSheet(true)}
                    className={`flex-1 py-3 rounded-xl text-sm transition-all active:scale-95 ${
                      isDark ? 'bg-white text-black hover:bg-white/90' : 'bg-gray-900 text-white hover:bg-gray-800'
                    }`}
                  >
                    <span className="flex items-center justify-center gap-2">
                      <Plus className="w-4 h-4" />
                      Log weigh-in
                    </span>
                  </button>
                  
                  <button
                    onClick={() => setShowGoalSetup(true)}
                    className={`flex-1 py-3 rounded-xl text-sm border transition-all active:scale-95 ${
                      isDark ? 'border-white/20 text-white hover:bg-white/5' : 'border-gray-300 text-gray-900 hover:bg-gray-50'
                    }`}
                  >
                    Edit goal
                  </button>
                </div>
              </div>

              {/* Trajectory Chart */}
              <div className={`rounded-2xl p-6 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <div className="flex items-center justify-between mb-4">
                  <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>Trajectory</h3>
                  
                  <div className={`flex gap-1 p-1 rounded-lg ${isDark ? 'bg-white/5' : 'bg-gray-100'}`}>
                    {['30', '90', '180'].map((range) => (
                      <button
                        key={range}
                        onClick={() => setTimeRange(range as any)}
                        className={`px-3 py-1 rounded text-xs transition-all ${
                          timeRange === range
                            ? isDark ? 'bg-white/10 text-white' : 'bg-white text-gray-900 shadow-sm'
                            : isDark ? 'text-white/50' : 'text-gray-500'
                        }`}
                      >
                        {range}d
                      </button>
                    ))}
                  </div>
                </div>

                <ResponsiveContainer width="100%" height={250}>
                  <AreaChart data={weightChartData}>
                    <defs>
                      <linearGradient id="weightGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.3}/>
                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                      </linearGradient>
                      <linearGradient id="projectionGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#94a3b8" stopOpacity={0.2}/>
                        <stop offset="95%" stopColor="#94a3b8" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke={isDark ? '#ffffff20' : '#00000010'} />
                    <XAxis 
                      dataKey="date" 
                      stroke={isDark ? '#ffffff40' : '#00000040'}
                      style={{ fontSize: '12px' }}
                      interval="preserveStartEnd"
                    />
                    <YAxis 
                      stroke={isDark ? '#ffffff40' : '#00000040'}
                      style={{ fontSize: '12px' }}
                      domain={weightYDomain}
                    />
                    <Tooltip
                      contentStyle={{
                        backgroundColor: isDark ? '#1e293b' : '#ffffff',
                        border: isDark ? '1px solid rgba(255,255,255,0.1)' : '1px solid rgba(0,0,0,0.1)',
                        borderRadius: '8px',
                        color: isDark ? '#ffffff' : '#000000'
                      }}
                    />
                    <ReferenceLine y={72.0} stroke="#8b5cf6" strokeDasharray="5 5" label="Goal" />
                    
                    {/* Historical weight data */}
                    <Area
                      type="monotone"
                      dataKey="actualWeight"
                      stroke="#8b5cf6"
                      strokeWidth={2}
                      fill="url(#weightGradient)"
                      connectNulls
                    />
                    
                    {/* Prediction range - using stacked areas to create the band */}
                    <Area
                      type="monotone"
                      dataKey="forecastLow"
                      stroke="none"
                      fill="transparent"
                      stackId="1"
                    />
                    <Area
                      type="monotone"
                      dataKey="forecastRange"
                      stroke="none"
                      fill="url(#projectionGradient)"
                      stackId="1"
                    />
                    
                    {/* Prediction boundary lines */}
                    <Line
                      type="monotone"
                      dataKey="forecastLow"
                      stroke={isDark ? '#94a3b8' : '#64748b'}
                      strokeWidth={1.5}
                      strokeDasharray="4 4"
                      dot={false}
                      connectNulls
                    />
                    <Line
                      type="monotone"
                      dataKey="forecastHigh"
                      stroke={isDark ? '#94a3b8' : '#64748b'}
                      strokeWidth={1.5}
                      strokeDasharray="4 4"
                      dot={false}
                      connectNulls
                    />
                  </AreaChart>
                </ResponsiveContainer>

                <div className="mt-4 flex flex-wrap gap-2">
                  <div className={`px-3 py-1.5 rounded-lg text-xs ${isDark ? 'bg-white/5' : 'bg-gray-50'}`}>
                    <span className={isDark ? 'text-white/70' : 'text-gray-700'}>Forecast (8w): </span>
                    <span className={isDark ? 'text-white' : 'text-gray-900'}>71.5–73.2 kg</span>
                  </div>
                  <div className={`px-3 py-1.5 rounded-lg text-xs ${isDark ? 'bg-white/5' : 'bg-gray-50'}`}>
                    <span className={isDark ? 'text-white/70' : 'text-gray-700'}>ETA: </span>
                    <span className={isDark ? 'text-white' : 'text-gray-900'}>~8 weeks (±2)</span>
                  </div>
                  <div className={`px-3 py-1.5 rounded-lg text-xs ${
                    isDark ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700'
                  }`}>
                    High confidence
                  </div>
                </div>

                <p className={`text-xs mt-3 ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
                  Ranges widen when weigh-ins are infrequent. More weigh-ins improves accuracy.
                </p>
              </div>

              {/* Body Fat Trajectory Chart */}
              <div className={`rounded-2xl p-6 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <div className="flex items-center justify-between mb-4">
                  <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>Body Fat %</h3>
                  
                  <div className={`px-3 py-1.5 rounded-full text-xs ${
                    isDark ? 'bg-orange-500/20 text-orange-400 border border-orange-500/30' : 'bg-orange-100 text-orange-700 border border-orange-200'
                  }`}>
                    Improving
                  </div>
                </div>

                <ResponsiveContainer width="100%" height={250}>
                  <AreaChart data={bodyCompData}>
                    <defs>
                      <linearGradient id="bodyFatGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#f97316" stopOpacity={0.3}/>
                        <stop offset="95%" stopColor="#fb923c" stopOpacity={0}/>
                      </linearGradient>
                      <linearGradient id="bodyFatProjectionGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#94a3b8" stopOpacity={0.2}/>
                        <stop offset="95%" stopColor="#94a3b8" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke={isDark ? '#ffffff20' : '#00000010'} />
                    <XAxis 
                      dataKey="date" 
                      stroke={isDark ? '#ffffff40' : '#00000040'}
                      style={{ fontSize: '12px' }}
                      interval="preserveStartEnd"
                    />
                    <YAxis 
                      stroke={isDark ? '#ffffff40' : '#00000040'}
                      style={{ fontSize: '12px' }}
                      domain={bodyFatYDomain}
                      tickFormatter={(value) => `${value}%`}
                    />
                    <Tooltip
                      contentStyle={{
                        backgroundColor: isDark ? '#1e293b' : '#ffffff',
                        border: isDark ? '1px solid rgba(255,255,255,0.1)' : '1px solid rgba(0,0,0,0.1)',
                        borderRadius: '8px',
                        color: isDark ? '#ffffff' : '#000000'
                      }}
                      formatter={(value: any) => [`${value?.toFixed(1)}%`, 'Body Fat']}
                    />
                    
                    {/* Historical body fat data */}
                    <Area
                      type="monotone"
                      dataKey="actualBodyFat"
                      stroke="#f97316"
                      strokeWidth={2}
                      fill="url(#bodyFatGradient)"
                      connectNulls
                    />
                    
                    {/* Body fat prediction range */}
                    <Area
                      type="monotone"
                      dataKey="bodyFatLow"
                      stroke="none"
                      fill="transparent"
                      stackId="2"
                    />
                    <Area
                      type="monotone"
                      dataKey="bodyFatRange"
                      stroke="none"
                      fill="url(#bodyFatProjectionGradient)"
                      stackId="2"
                    />
                    
                    {/* Body fat prediction boundary lines */}
                    <Line
                      type="monotone"
                      dataKey="bodyFatLow"
                      stroke={isDark ? '#94a3b8' : '#64748b'}
                      strokeWidth={1.5}
                      strokeDasharray="4 4"
                      dot={false}
                      connectNulls
                    />
                    <Line
                      type="monotone"
                      dataKey="bodyFatHigh"
                      stroke={isDark ? '#94a3b8' : '#64748b'}
                      strokeWidth={1.5}
                      strokeDasharray="4 4"
                      dot={false}
                      connectNulls
                    />
                  </AreaChart>
                </ResponsiveContainer>

                <div className="mt-4 flex flex-wrap gap-2">
                  <div className={`px-3 py-1.5 rounded-lg text-xs ${isDark ? 'bg-white/5' : 'bg-gray-50'}`}>
                    <span className={isDark ? 'text-white/70' : 'text-gray-700'}>Current: </span>
                    <span className={isDark ? 'text-white' : 'text-gray-900'}>15.1%</span>
                  </div>
                  <div className={`px-3 py-1.5 rounded-lg text-xs ${isDark ? 'bg-white/5' : 'bg-gray-50'}`}>
                    <span className={isDark ? 'text-white/70' : 'text-gray-700'}>Forecast (8w): </span>
                    <span className={isDark ? 'text-white' : 'text-gray-900'}>13.5–14.2%</span>
                  </div>
                  <div className={`px-3 py-1.5 rounded-lg text-xs ${
                    isDark ? 'bg-orange-500/20 text-orange-400' : 'bg-orange-100 text-orange-700'
                  }`}>
                    -1.0% trend
                  </div>
                </div>

                <p className={`text-xs mt-3 ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
                  Body composition data from smart scales. Maintain lean mass while losing fat.
                </p>
              </div>

              {/* Goal Card */}
              <div className={`rounded-2xl p-5 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <div className="flex items-start justify-between mb-4">
                  <div>
                    <h3 className={`mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>Goal</h3>
                    <p className={`text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                      Reach 72.0 kg by Mar 15, 2025
                    </p>
                  </div>
                  <Target className={`w-5 h-5 ${isDark ? 'text-purple-400' : 'text-purple-600'}`} />
                </div>

                <div className="space-y-3">
                  <div className="flex items-center justify-between text-sm">
                    <span className={isDark ? 'text-white/70' : 'text-gray-700'}>Required pace</span>
                    <span className={isDark ? 'text-white' : 'text-gray-900'}>0.4 kg/week</span>
                  </div>
                  <div className="flex items-center justify-between text-sm">
                    <span className={isDark ? 'text-white/70' : 'text-gray-700'}>Pace rating</span>
                    <span className={`px-2 py-0.5 rounded text-xs ${
                      isDark ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-700'
                    }`}>
                      Moderate
                    </span>
                  </div>
                </div>
              </div>

              {/* Body Composition Card */}
              <div className={`rounded-2xl p-5 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <div className="flex items-start justify-between mb-4">
                  <div>
                    <h3 className={`mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>Body Composition</h3>
                    <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                      Last updated: 2h ago
                    </p>
                  </div>
                  <Activity className={`w-5 h-5 ${isDark ? 'text-blue-400' : 'text-blue-600'}`} />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Body fat</p>
                    <p className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>15.1%</p>
                  </div>
                  <div>
                    <p className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Lean mass</p>
                    <p className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>63.8 kg</p>
                  </div>
                </div>

                <button
                  onClick={() => setShowBodyCompSheet(true)}
                  className={`w-full mt-4 py-2.5 rounded-xl text-sm border transition-all ${
                    isDark ? 'border-white/20 text-white hover:bg-white/5' : 'border-gray-300 text-gray-900 hover:bg-gray-50'
                  }`}
                >
                  Update composition
                </button>
              </div>

              {/* Key Drivers */}
              <div className={`rounded-2xl p-5 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <h3 className={`mb-4 ${isDark ? 'text-white' : 'text-gray-900'}`}>Key Drivers</h3>
                
                <div className="space-y-3">
                  {mockDrivers.map((driver) => {
                    const IconComponent = 
                      driver.icon === 'moon' ? Moon :
                      driver.icon === 'footprints' ? Footprints :
                      Drumstick;
                    
                    return (
                      <div
                        key={driver.id}
                        className={`p-4 rounded-xl border ${
                          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                        } transition-all cursor-pointer`}
                      >
                        <div className="flex items-start gap-3">
                          <div className={`p-2 rounded-lg ${
                            isDark ? 'bg-white/10' : 'bg-white'
                          }`}>
                            <IconComponent className={`w-5 h-5 ${
                              driver.icon === 'moon' 
                                ? isDark ? 'text-indigo-400' : 'text-indigo-600'
                                : driver.icon === 'footprints'
                                  ? isDark ? 'text-emerald-400' : 'text-emerald-600'
                                  : isDark ? 'text-orange-400' : 'text-orange-600'
                            }`} />
                          </div>
                          <div className="flex-1">
                            <p className={`text-sm mb-0.5 ${isDark ? 'text-white' : 'text-gray-900'}`}>
                              {driver.title}
                            </p>
                            <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                              {driver.subtitle}
                            </p>
                          </div>
                          <div className={`px-2 py-0.5 rounded text-xs ${
                            driver.confidence === 'HIGH'
                              ? isDark ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700'
                              : isDark ? 'bg-yellow-500/20 text-yellow-400' : 'bg-yellow-100 text-yellow-700'
                          }`}>
                            {driver.confidence.toLowerCase()}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Scenario Simulator */}
              <div className={`rounded-2xl p-5 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <div className="flex items-start justify-between mb-4">
                  <div>
                    <h3 className={`mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>What if...</h3>
                    <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                      Explore different scenarios
                    </p>
                  </div>
                  <Zap className={`w-5 h-5 ${isDark ? 'text-yellow-400' : 'text-yellow-600'}`} />
                </div>

                <div className="space-y-3">
                  {mockLevers.map((lever) => (
                    <div
                      key={lever.id}
                      className={`p-4 rounded-xl border ${
                        isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                      } transition-all cursor-pointer`}
                    >
                      <div className="flex items-start justify-between mb-2">
                        <div className="flex-1">
                          <p className={`text-sm mb-0.5 ${isDark ? 'text-white' : 'text-gray-900'}`}>
                            {lever.title}
                          </p>
                          <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                            {lever.subtitle}
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2 text-xs">
                        <span className={`px-2 py-0.5 rounded ${
                          isDark ? 'bg-white/10 text-white/70' : 'bg-gray-200 text-gray-700'
                        }`}>
                          {lever.effort} effort
                        </span>
                        <span className={isDark ? 'text-white/50' : 'text-gray-500'}>•</span>
                        <span className={isDark ? 'text-white/70' : 'text-gray-700'}>
                          Effect: {lever.effect}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </>
          )}

          {/* HISTORY TAB */}
          {activeTab === 'history' && (
            <>
              <div className={`rounded-2xl p-5 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className={`mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>Weigh-ins</h3>
                    <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                      Review imported and manual entries
                    </p>
                  </div>
                  
                  <button
                    onClick={() => setShowWeighInSheet(true)}
                    className={`px-4 py-2 rounded-xl text-sm transition-all ${
                      isDark ? 'bg-white text-black hover:bg-white/90' : 'bg-gray-900 text-white hover:bg-gray-800'
                    }`}
                  >
                    <span className="flex items-center gap-2">
                      <Plus className="w-4 h-4" />
                      Log weigh-in
                    </span>
                  </button>
                </div>

                <div className="space-y-2">
                  {mockHistory.map((entry) => (
                    <div
                      key={entry.id}
                      className={`p-4 rounded-xl border ${
                        isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <span className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
                              {entry.weight} kg
                            </span>
                            {entry.bodyFat && (
                              <span className={`text-sm ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                                • {entry.bodyFat}% BF
                              </span>
                            )}
                          </div>
                          <div className="flex items-center gap-2 text-xs">
                            <span className={isDark ? 'text-white/50' : 'text-gray-500'}>
                              {entry.date} at {entry.time}
                            </span>
                            <span className={isDark ? 'text-white/30' : 'text-gray-400'}>•</span>
                            <span className={`px-2 py-0.5 rounded ${
                              entry.source === 'Apple Health'
                                ? isDark ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-700'
                                : isDark ? 'bg-purple-500/20 text-purple-400' : 'bg-purple-100 text-purple-700'
                            }`}>
                              {entry.source}
                            </span>
                            {entry.device && (
                              <>
                                <span className={isDark ? 'text-white/30' : 'text-gray-400'}>•</span>
                                <span className={isDark ? 'text-white/50' : 'text-gray-500'}>
                                  {entry.device}
                                </span>
                              </>
                            )}
                          </div>
                        </div>
                        
                        {entry.editable && (
                          <div className="flex gap-2">
                            <button className={`text-xs px-3 py-1 rounded ${
                              isDark ? 'text-white/70 hover:bg-white/10' : 'text-gray-700 hover:bg-gray-200'
                            }`}>
                              Edit
                            </button>
                            <button className={`text-xs px-3 py-1 rounded ${
                              isDark ? 'text-red-400 hover:bg-red-500/10' : 'text-red-600 hover:bg-red-50'
                            }`}>
                              Delete
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </>
          )}

          {/* SETUP TAB */}
          {activeTab === 'setup' && (
            <>
              {/* Goal Setup */}
              <div className={`rounded-2xl p-5 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className={`mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>Goal</h3>
                    <p className={`text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                      Configured: Lose weight to 72 kg
                    </p>
                  </div>
                  <Target className={`w-5 h-5 ${isDark ? 'text-purple-400' : 'text-purple-600'}`} />
                </div>
                
                <button
                  onClick={() => setShowGoalSetup(true)}
                  className={`w-full py-3 rounded-xl text-sm border transition-all ${
                    isDark ? 'border-white/20 text-white hover:bg-white/5' : 'border-gray-300 text-gray-900 hover:bg-gray-50'
                  }`}
                >
                  Edit goal
                </button>
              </div>

              {/* Data Sources */}
              <div className={`rounded-2xl p-5 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className={`mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>Apple Health</h3>
                    <div className="flex items-center gap-2">
                      <div className={`w-2 h-2 rounded-full ${
                        isDark ? 'bg-green-400' : 'bg-green-500'
                      }`} />
                      <p className={`text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                        Connected
                      </p>
                    </div>
                  </div>
                  <Activity className={`w-5 h-5 ${isDark ? 'text-green-400' : 'text-green-600'}`} />
                </div>
                
                <p className={`text-sm mb-4 ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                  Last synced: 2h ago
                </p>

                <button
                  className={`w-full py-3 rounded-xl text-sm border transition-all ${
                    isDark ? 'border-white/20 text-white hover:bg-white/5' : 'border-gray-300 text-gray-900 hover:bg-gray-50'
                  }`}
                >
                  Manage permissions
                </button>
              </div>

              {/* Check-in Cadence */}
              <div className={`rounded-2xl p-5 ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <div className="flex items-center gap-3 mb-4">
                  <Calendar className={`w-5 h-5 ${isDark ? 'text-blue-400' : 'text-blue-600'}`} />
                  <div>
                    <h3 className={`mb-0.5 ${isDark ? 'text-white' : 'text-gray-900'}`}>Check-in cadence</h3>
                    <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                      More weigh-ins improves accuracy
                    </p>
                  </div>
                </div>

                <div className={`flex gap-2 p-1 rounded-lg ${isDark ? 'bg-white/5' : 'bg-gray-100'}`}>
                  {['Daily', '3×/week', 'Weekly'].map((cadence, idx) => (
                    <button
                      key={cadence}
                      className={`flex-1 py-2 rounded text-sm transition-all ${
                        idx === 1
                          ? isDark ? 'bg-white text-black' : 'bg-white text-gray-900 shadow-sm'
                          : isDark ? 'text-white/70' : 'text-gray-600'
                      }`}
                    >
                      {cadence}
                    </button>
                  ))}
                </div>
              </div>
            </>
          )}
        </div>
      </motion.div>

      {/* Sheets */}
      <AnimatePresence>
        {showWeighInSheet && (
          <ManualWeighInSheet
            isDark={isDark}
            onClose={() => setShowWeighInSheet(false)}
            onSave={(data) => {
              console.log('Weigh-in saved:', data);
              setShowWeighInSheet(false);
            }}
          />
        )}
        
        {showBodyCompSheet && (
          <BodyCompSheet
            isDark={isDark}
            onClose={() => setShowBodyCompSheet(false)}
            onSave={(data) => {
              console.log('Body comp saved:', data);
              setShowBodyCompSheet(false);
            }}
          />
        )}

        {showGoalSetup && (
          <GoalSetupFlow
            isDark={isDark}
            onClose={() => setShowGoalSetup(false)}
            onSave={(data) => {
              console.log('Goal saved:', data);
              setShowGoalSetup(false);
            }}
          />
        )}
      </AnimatePresence>
    </div>
  );
}