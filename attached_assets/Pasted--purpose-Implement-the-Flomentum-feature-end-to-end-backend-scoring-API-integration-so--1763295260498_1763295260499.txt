{
  "purpose": "Implement the Flomentum feature end-to-end (backend + scoring + API integration) so the app can show daily and weekly Flomentum scores using Apple HealthKit data. The UI HTML/CSS is supplied separately; this spec defines the data contracts and logic.",
  "scope": {
    "include": [
      "Daily Flomentum score calculation based on sleep, activity and recovery metrics from Apple HealthKit.",
      "Weekly aggregation of Flomentum for the Weekly screen.",
      "Postgres/Drizzle schema for storing daily health metrics and Flomentum results.",
      "Backend APIs for the dashboard hero tile, Today tab and Weekly tab.",
      "Background jobs/cron for daily and weekly computation.",
      "iOS HealthKit daily summary contract (what the native layer must send to the backend)."
    ],
    "exclude": [
      "Detailed UI layout (handled by existing HTML/CSS).",
      "Push notification scheduling (can be added later to consume the same APIs).",
      "Any clinical decision-making or medication advice."
    ]
  },
  "tech_assumptions": {
    "backend": "Node.js 20 with TypeScript, Express or Fastify style HTTP server, Drizzle ORM and PostgreSQL.",
    "frontend": "React + TypeScript app, wrapped in Capacitor for iOS.",
    "auth": "User is authenticated via existing JWT/session middleware; userId is available on the backend."
  },
  "core_concept": {
    "description": "Flomentum is a 0–100 daily score that reflects whether the previous day moved the user in a positive, neutral or negative direction for health and longevity. It is computed once per health day from aggregated HealthKit metrics, stored in the database, and surfaced via three main UI elements: dashboard hero tile, Flomentum Today screen, Flomentum Weekly screen.",
    "zones": [
      {
        "key": "BUILDING",
        "label": "Building",
        "range": "75–100"
      },
      {
        "key": "MAINTAINING",
        "label": "Maintaining",
        "range": "60–74"
      },
      {
        "key": "DRAINING",
        "label": "Draining",
        "range": "0–59"
      }
    ]
  },
  "health_day_definition": {
    "timezone": "Use the user’s saved timezone from user_settings; if missing, default to app-level timezone.",
    "window": "A health day is the local calendar day from 00:00 to 23:59 in the user’s timezone.",
    "sleep_assignment": "If a main sleep interval crosses midnight, assign it to the day on which the sleep started so that last night’s sleep contributes to yesterday’s Flomentum."
  },
  "data_model": {
    "tables": [
      {
        "name": "user_settings",
        "description": "Per-user configuration relevant to Flomentum.",
        "columns": [
          "id uuid primary key",
          "user_id uuid unique not null references users(id)",
          "timezone text not null default 'UTC'",
          "steps_target int not null default 7000",
          "sleep_target_minutes int not null default 480",
          "flomentum_enabled boolean not null default true",
          "created_at timestamptz not null default now()",
          "updated_at timestamptz not null default now()"
        ]
      },
      {
        "name": "health_daily_metrics",
        "description": "One row per user per health day aggregating HealthKit metrics.",
        "unique_constraint": "unique(user_id, date)",
        "columns": [
          "id uuid primary key",
          "user_id uuid not null references users(id)",
          "date date not null",
          "sleep_total_minutes int",
          "sleep_main_start timestamptz",
          "sleep_main_end timestamptz",
          "hrv_sdnn_ms int",
          "resting_hr int",
          "respiratory_rate numeric",
          "body_temp_deviation_c numeric",
          "oxygen_saturation_avg numeric",
          "steps int",
          "distance_meters int",
          "active_kcal int",
          "exercise_minutes int",
          "stand_hours int",
          "weight_kg numeric",
          "body_fat_pct numeric",
          "lean_mass_kg numeric",
          "bmi numeric",
          "waist_circumference_cm numeric",
          "source text not null default 'healthkit_v1'",
          "created_at timestamptz not null default now()",
          "updated_at timestamptz not null default now()"
        ]
      },
      {
        "name": "flomentum_daily",
        "description": "Computed daily Flomentum scores and explanations.",
        "unique_constraint": "unique(user_id, date)",
        "columns": [
          "id uuid primary key",
          "user_id uuid not null references users(id)",
          "date date not null",
          "score int not null",
          "zone text not null check (zone in ('BUILDING','MAINTAINING','DRAINING'))",
          "delta_vs_yesterday int",
          "factors jsonb not null",
          "daily_focus jsonb",
          "created_at timestamptz not null default now()",
          "updated_at timestamptz not null default now()"
        ]
      },
      {
        "name": "flomentum_weekly",
        "description": "Weekly aggregated Flomentum data for the Weekly screen.",
        "unique_constraint": "unique(user_id, week_start_date)",
        "columns": [
          "id uuid primary key",
          "user_id uuid not null references users(id)",
          "week_start_date date not null",
          "average_score int not null",
          "delta_vs_previous_week int",
          "daily_scores jsonb not null",
          "what_helped jsonb not null",
          "what_held_back jsonb not null",
          "focus_next_week text not null",
          "created_at timestamptz not null default now()",
          "updated_at timestamptz not null default now()"
        ]
      }
    ]
  },
  "ios_healthkit_daily_summary_contract": {
    "description": "The iOS/Capacitor layer must aggregate HealthKit samples for each completed health day and POST a single summary payload per day to the backend. This contract must match exactly.",
    "endpoint": "POST /api/health/daily-summary",
    "payload_shape": {
      "userId": "string; must match authenticated user",
      "date": "string; 'YYYY-MM-DD' in user’s local timezone representing the health day",
      "sleep": {
        "totalSleepMinutes": "number or null; total minutes asleep in main sleep interval for that health day",
        "mainSleepStart": "ISO 8601 string or null; start of main sleep",
        "mainSleepEnd": "ISO 8601 string or null; end of main sleep"
      },
      "recovery": {
        "hrvSdnnMs": "number or null; daily average HRV SDNN in ms",
        "restingHr": "number or null; daily average resting HR in bpm",
        "respiratoryRate": "number or null; daily average respiratory rate",
        "bodyTempDeviationC": "number or null; deviation from user’s 30-day rolling mean skin/wrist temp, or 0 if not computed on-device",
        "oxygenSaturationAvg": "number or null; average SpO2 in percent"
      },
      "activity": {
        "steps": "number or null; total steps",
        "distanceMeters": "number or null; total walking/running distance",
        "activeKcal": "number or null; total active energy burned",
        "exerciseMinutes": "number or null; Apple Exercise Time in minutes if available, else null",
        "standHours": "number or null; Apple Stand Time (stand hours)"
      },
      "bodyComposition": {
        "weightKg": "number or null",
        "bodyFatPercent": "number or null",
        "leanBodyMassKg": "number or null",
        "bmi": "number or null",
        "waistCircumferenceCm": "number or null"
      }
    }
  },
  "backend_api": {
    "endpoints": [
      {
        "method": "POST",
        "path": "/api/health/daily-summary",
        "auth": "Required",
        "description": "Upsert a daily HealthKit summary for the authenticated user.",
        "logic": [
          "Validate that userId in body matches the authenticated user.",
          "Convert date to a Date object and ensure it respects the user’s timezone definition.",
          "Upsert into health_daily_metrics on (user_id, date).",
          "Enqueue a background job 'calculate_flomentum_for_day' with { userId, date }."
        ]
      },
      {
        "method": "GET",
        "path": "/api/flomentum/today",
        "auth": "Required",
        "description": "Return the most recent Flomentum record for the user to power the hero tile and Today screen. By default this is yesterday’s completed health day; optionally allow a ?date=YYYY-MM-DD param.",
        "response_shape": {
          "date": "string; 'YYYY-MM-DD'",
          "score": "number; 0–100",
          "zone": "string; 'BUILDING' | 'MAINTAINING' | 'DRAINING'",
          "deltaVsYesterday": "number or null",
          "summaryLabel": "string; same as zone label for UI, e.g. 'Building'",
          "quickSnapshot": [
            {
              "status": "string; 'positive' | 'neutral' | 'negative'",
              "title": "string; short label, e.g. 'Hit your step target'",
              "detail": "string; metric detail, e.g. '12,847 steps (Goal: 10,000)'"
            }
          ],
          "whyThisScore": [
            {
              "status": "string; 'positive' | 'neutral' | 'negative'",
              "title": "string; same as factors title",
              "detail": "string; longer explanation for Today screen",
              "componentKey": "string; e.g. 'sleep' | 'steps' | 'intensity' | 'recovery'",
              "pointsContribution": "number; contribution to score from this factor"
            }
          ],
          "dailyFocus": {
            "title": "string; e.g. 'Boost your movement today'",
            "body": "string; e.g. 'Add a 15–20 min walk to reach your step target.'",
            "componentKey": "string; which lever this focus addresses"
          },
          "footerNote": "string; e.g. 'Flomentum updates daily from Apple Health.'"
        }
      },
      {
        "method": "GET",
        "path": "/api/flomentum/weekly",
        "auth": "Required",
        "description": "Return the latest completed Flomentum week for the user to power the Weekly tab.",
        "query_params": "Optional ?weekStart=YYYY-MM-DD to fetch a specific week; otherwise use the most recent completed week.",
        "response_shape": {
          "weekStartDate": "string; 'YYYY-MM-DD'",
          "weekEndDate": "string; 'YYYY-MM-DD'",
          "averageScore": "number",
          "deltaVsLastWeek": "number or null",
          "dailyScores": [
            {
              "date": "string; 'YYYY-MM-DD'",
              "label": "string; e.g. 'Mon'",
              "score": "number or null",
              "zone": "string or null"
            }
          ],
          "whatHelped": [
            "string; bullet list for 'What helped' card"
          ],
          "whatHeldBack": [
            "string; bullet list for 'What held you back' card"
          ],
          "focusNextWeek": "string; behaviour-focused recommendation, e.g. 'Aim for at least 20 minutes of intentional exercise on 4 days next week.'",
          "footerNote": "string; e.g. 'Flomentum updates daily from Apple Health.'"
        }
      }
    ]
  },
  "scoring_engine": {
    "function_signature": "calculateFlomentumScore(metrics, context) => { score, zone, factors, dailyFocus }",
    "inputs": {
      "metrics": {
        "sleep_total_minutes": "number or null",
        "hrv_sdnn_ms": "number or null",
        "resting_hr": "number or null",
        "respiratory_rate": "number or null",
        "body_temp_deviation_c": "number or null",
        "oxygen_saturation_avg": "number or null",
        "steps": "number or null",
        "active_kcal": "number or null",
        "exercise_minutes": "number or null",
        "stand_hours": "number or null"
      },
      "context": {
        "steps_target": "number; from user_settings",
        "sleep_target_minutes": "number; from user_settings",
        "resting_hr_baseline": "number or null; 30-day mean resting_hr",
        "hrv_baseline": "number or null; 30-day mean hrv_sdnn_ms",
        "resp_rate_baseline": "number or null; 30-day mean respiratory_rate"
      }
    },
    "general_rules": {
      "baseline": "Start each day at 50 points.",
      "clamp": "After adding all component scores, clamp final score to the range [0, 100]."
    },
    "components": {
      "sleep": {
        "description": "Compare total sleep minutes to target sleep window.",
        "rules": [
          "If sleep_total_minutes is null: 0 points, add neutral factor 'Sleep data missing'.",
          "Let target = sleep_target_minutes (default 480).",
          "Ideal range is [target - 60, target + 60] minutes.",
          "If within ideal range: +12 points, positive factor 'Sleep in your optimal range' with detail and values.",
          "If between target - 120 and target - 61: -4 points, negative factor 'Slightly short sleep'.",
          "If less than target - 120: -10 points, negative factor 'Very short sleep'.",
          "If greater than target + 120: -4 points, neutral/negative factor 'Long sleep, possible fatigue'."
        ]
      },
      "steps_and_activity": {
        "description": "Combine total steps and exercise/active kcal to reflect movement and intensity.",
        "step_rules": [
          "If steps is null: add neutral factor 'No step data' and 0 points.",
          "Else:",
          "If steps >= steps_target: +8 points, positive factor 'Hit your step target'.",
          "If steps between 0.7 * steps_target and steps_target: +4 points, positive factor 'Almost hit your step target'.",
          "If steps < 0.7 * steps_target: -6 points, negative factor 'Low movement today'."
        ],
        "intensity_rules": [
          "Prefer exercise_minutes; if null, derive a proxy from active_kcal (active_kcal / 5 ≈ minutes).",
          "If exercise_minutes (or proxy) >= 30: +6 points, positive factor 'Good workout / activity today'.",
          "If between 10 and 29 minutes: +3 points, neutral factor 'Light activity today'.",
          "If < 10 minutes and steps are also low: -4 points, negative factor 'Low exercise intensity'."
        ],
        "sedentary_rules": [
          "If stand_hours is not null:",
          "If stand_hours >= 10: +2 points, positive factor 'Low sedentary time'.",
          "If stand_hours <= 6: -2 points, negative factor 'High sedentary time'."
        ]
      },
      "recovery": {
        "description": "Use resting heart rate and HRV vs baselines to indicate recovery status.",
        "resting_hr_rules": [
          "If resting_hr or baseline missing: 0 points, no factor.",
          "Compute delta = resting_hr - resting_hr_baseline.",
          "If delta <= -3: +6 points, positive factor 'Resting HR improving vs baseline'.",
          "If delta between -2 and +2: +2 points, neutral factor 'Resting HR stable'.",
          "If delta >= +5: -6 points, negative factor 'Resting HR elevated vs baseline'."
        ],
        "hrv_rules": [
          "If hrv_sdnn_ms or baseline missing: 0 points.",
          "Compute delta = hrv_sdnn_ms - hrv_baseline.",
          "If delta >= +5 ms: +4 points, positive factor 'Heart rate variability stable or improving'.",
          "If delta <= -5 ms: -4 points, negative factor 'HRV suppressed vs baseline'."
        ]
      },
      "red_flags": {
        "description": "Penalise strong signs of illness or overreaching.",
        "rules": [
          "If respiratory_rate and resp_rate_baseline present and respiratory_rate >= resp_rate_baseline + 3: -4 points, negative factor 'Respiratory rate elevated (possible illness or overreaching)'.",
          "If body_temp_deviation_c is not null and body_temp_deviation_c >= 0.5: -6 points, negative factor 'Body temperature elevated (possible illness)'.",
          "If oxygen_saturation_avg not null and oxygen_saturation_avg < 94: -6 points, negative factor 'Low oxygen saturation – possible respiratory issue'."
        ]
      }
    },
    "zone_assignment": {
      "rules": [
        "If score >= 75: zone = 'BUILDING'.",
        "If 60 <= score < 75: zone = 'MAINTAINING'.",
        "If score < 60: zone = 'DRAINING'."
      ]
    },
    "factor_object_shape": {
      "status": "positive | neutral | negative",
      "title": "short label string for UI",
      "detail": "string including raw metric values and targets where relevant",
      "componentKey": "sleep | steps | intensity | sedentary | resting_hr | hrv | resp_rate | temp | spo2",
      "pointsContribution": "integer"
    },
    "daily_focus_logic": {
      "description": "Derive a single behavioural focus for the day based on the weakest component.",
      "steps": [
        "Group factors by componentKey and note which components have negative or low contributions.",
        "Rank components by severity: most negative total pointsContribution and most frequent negatives.",
        "Select the top one as the focus component.",
        "Map focus component to a library of canned messages, e.g.:",
        "If componentKey = 'steps' or 'intensity': title 'Boost your movement today', body 'Add a 15–20 min walk to reach your step target.'",
        "If componentKey = 'sleep': title 'Prioritise sleep tonight', body 'Aim for bed by a consistent time and target at least 7 hours of sleep.'",
        "If componentKey = 'resting_hr' or 'hrv': title 'Ease off and recover today', body 'Keep moving gently but avoid very intense sessions and focus on sleep.'",
        "If componentKey = 'temp' or 'resp_rate' or 'spo2': title 'Listen to your body', body 'Your vitals suggest possible strain or illness. Take it easy and rest if needed.'"
      ]
    }
  },
  "background_jobs": {
    "jobs": [
      {
        "name": "calculate_flomentum_for_day",
        "trigger": "Enqueued after /api/health/daily-summary upsert or via nightly cron for the previous day.",
        "logic": [
          "Load health_daily_metrics for (user_id, date).",
          "Load user_settings for user_id.",
          "Compute baselines (resting_hr_baseline, hrv_baseline, resp_rate_baseline) from previous 30 days of health_daily_metrics.",
          "Call calculateFlomentumScore(metrics, context) to obtain score, zone, factors, dailyFocus.",
          "Compute delta_vs_yesterday from the previous flomentum_daily row if it exists.",
          "Upsert into flomentum_daily on (user_id, date)."
        ]
      },
      {
        "name": "calculate_flomentum_weekly",
        "trigger": "Weekly cron job (e.g. early Monday morning for the previous week).",
        "logic": [
          "For each user with any flomentum_daily entries in the previous week:",
          "Determine week_start_date (e.g. Monday) and week_end_date.",
          "Load all flomentum_daily rows for that week.",
          "Compute average_score as mean of available daily scores.",
          "Load previous week’s flomentum_weekly if exists and compute delta_vs_previous_week.",
          "Build daily_scores array with date, day-of-week label and score/zone.",
          "Generate what_helped and what_held_back lists by scanning daily factors:",
          "Examples: if majority of days had positive sleep factors, add 'Consistent 7–8h sleep most nights.' to what_helped.",
          "If several days had 'Low movement today' or 'Low exercise intensity', add bullet(s) to what_held_back.",
          "Determine the weakest recurring component (e.g. sleep, movement, intensity, recovery) and generate focus_next_week text using a small rules library, e.g. movement focus: 'Aim for at least 20 minutes of intentional exercise on 4 days next week.'",
          "Upsert the record into flomentum_weekly for (user_id, week_start_date)."
        ]
      }
    ]
  },
  "testing": {
    "unit_tests": [
      "Test calculateFlomentumScore with: ideal day (good sleep, movement, recovery) → score in 80–95 range and zone BUILDING.",
      "Test with very short sleep and low steps → score below 60 and zone DRAINING with appropriate negative factors.",
      "Test with high resting HR vs baseline → recovery component penalises.",
      "Test red-flag scenarios (elevated temp, low SpO2) → additional negative points and factors.",
      "Test daily_focus_logic returns appropriate component and message for different negative patterns."
    ],
    "integration_tests": [
      "POST /api/health/daily-summary for a test user, run calculate_flomentum_for_day, then GET /api/flomentum/today and verify response matches expectations.",
      "Simulate a full week of data and verify /api/flomentum/weekly response, including whatHelped, whatHeldBack and focusNextWeek."
    ]
  }
}
