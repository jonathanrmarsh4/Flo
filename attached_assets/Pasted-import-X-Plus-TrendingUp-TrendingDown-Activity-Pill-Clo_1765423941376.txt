import { X, Plus, TrendingUp, TrendingDown, Activity, Pill, Clock, Target, Calendar, ChevronRight, AlertCircle, CheckCircle, Sparkles, MessageSquare, Edit2, Trash2, Moon, Zap, Smile, Dumbbell, ScanBarcode, ChevronLeft } from 'lucide-react';
import { useState } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, ReferenceArea } from 'recharts';
import { N1ExperimentWizard } from './N1ExperimentWizard';

interface InterventionsScreenProps {
  isDark: boolean;
  onClose: () => void;
}

interface Intervention {
  id: string;
  name: string;
  type: 'supplement' | 'medication' | 'lifestyle';
  dosage: string;
  frequency: string;
  startDate: string;
  endDate?: string;
  duration: number; // days
  status: 'active' | 'completed' | 'paused';
  goals: string[];
  trackingMetrics: {
    subjective: string[];
    objective: string[];
  };
  baselineData?: any;
  results?: {
    improved: string[];
    noChange: string[];
    declined: string[];
  };
}

// Common supplements database for autocomplete
const commonSupplements = [
  'Vitamin D3', 'Magnesium Glycinate', 'Omega-3 Fish Oil', 'Vitamin B12', 
  'Vitamin C', 'Zinc', 'Creatine Monohydrate', 'L-Theanine', 'Ashwagandha',
  'Rhodiola Rosea', 'CoQ10', 'Curcumin', 'NAD+', 'NMN', 'Berberine',
  'Alpha-GPC', 'Lions Mane', 'Bacopa Monnieri', 'Ginkgo Biloba',
  'Probiotics', 'Melatonin', 'Glycine', 'Taurine', 'GABA', ' 5-HTP',
  'SAMe', 'Glutathione', 'Alpha Lipoic Acid', 'Resveratrol', 'Quercetin'
];

const subjectiveMetrics = [
  'Energy Level', 'Mental Clarity', 'Focus', 'Mood', 'Sleep Quality',
  'Digestion', 'Recovery', 'Motivation', 'Stress Level', 'Appetite',
  'Joint Pain', 'Muscle Soreness', 'Anxiety', 'Calmness', 'Alertness'
];

const objectiveMetrics = [
  'HRV', 'Resting Heart Rate', 'Sleep Duration', 'Deep Sleep %',
  'REM Sleep %', 'Average Glucose', 'Glucose Variability', 
  'Time in Range', 'VO2 Max', 'Weight', 'Body Fat %',
  'Steps', 'Active Minutes', 'Calories Burned'
];

// Mock active interventions
const mockInterventions: Intervention[] = [
  {
    id: '1',
    name: 'Magnesium Glycinate',
    type: 'supplement',
    dosage: '400mg',
    frequency: 'Once daily (before bed)',
    startDate: 'Nov 15, 2024',
    duration: 30,
    status: 'active',
    goals: ['Sleep Quality', 'Recovery', 'Stress Level'],
    trackingMetrics: {
      subjective: ['Sleep Quality', 'Recovery', 'Stress Level', 'Muscle Soreness'],
      objective: ['HRV', 'Sleep Duration', 'Deep Sleep %', 'Resting Heart Rate']
    },
    baselineData: {
      hrv: 58,
      sleepDuration: 6.8,
      deepSleep: 18,
      sleepQuality: 6.2
    },
    results: {
      improved: ['Sleep Quality', 'Deep Sleep %', 'Recovery'],
      noChange: ['Stress Level'],
      declined: []
    }
  },
  {
    id: '2',
    name: 'L-Theanine',
    type: 'supplement',
    dosage: '200mg',
    frequency: 'Twice daily (morning & afternoon)',
    startDate: 'Dec 1, 2024',
    duration: 14,
    status: 'active',
    goals: ['Focus', 'Calmness', 'Anxiety'],
    trackingMetrics: {
      subjective: ['Focus', 'Mental Clarity', 'Anxiety', 'Calmness'],
      objective: ['HRV', 'Resting Heart Rate']
    },
    baselineData: {
      hrv: 62,
      restingHR: 58,
      focus: 6.5,
      anxiety: 5.8
    }
  }
];

// Generate mock daily tracking data
const generateDailyData = (intervention: Intervention, includeProjection: boolean = false) => {
  const data = [];
  const daysElapsed = Math.min(
    Math.floor((new Date().getTime() - new Date(intervention.startDate).getTime()) / (1000 * 60 * 60 * 24)),
    intervention.duration
  );
  
  // Define success targets for each metric
  const successTargets = {
    sleepQuality: 8.5,
    focus: 8.8,
    energy: 8.2,
    hrv: 66,
    deepSleep: 24
  };
  
  for (let i = 0; i <= daysElapsed; i++) {
    const date = new Date(intervention.startDate);
    date.setDate(date.getDate() + i);
    
    // Simulate improving trend for subjective metrics
    const baseScore = 6.5;
    const improvement = (i / intervention.duration) * 2; // gradual improvement
    const noise = (Math.random() - 0.5) * 0.8;
    
    data.push({
      day: i + 1,
      date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      sleepQuality: Math.min(10, baseScore + improvement + noise),
      focus: Math.min(10, baseScore + improvement * 1.2 + noise),
      energy: Math.min(10, baseScore + improvement * 0.8 + noise),
      hrv: 58 + (i / intervention.duration) * 8 + Math.random() * 4,
      deepSleep: 18 + (i / intervention.duration) * 6 + Math.random() * 2,
      isProjection: false
    });
  }
  
  // Add projection point at end of trial if requested
  if (includeProjection && daysElapsed < intervention.duration) {
    const endDate = new Date(intervention.startDate);
    endDate.setDate(endDate.getDate() + intervention.duration);
    
    data.push({
      day: intervention.duration,
      date: endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      sleepQuality: successTargets.sleepQuality,
      focus: successTargets.focus,
      energy: successTargets.energy,
      hrv: successTargets.hrv,
      deepSleep: successTargets.deepSleep,
      isProjection: true
    });
  }
  
  return data;
};

export function InterventionsScreen({ isDark, onClose }: InterventionsScreenProps) {
  const [showNewInterventionModal, setShowNewInterventionModal] = useState(false);
  const [selectedIntervention, setSelectedIntervention] = useState<Intervention | null>(null);
  const [showDailyCheck, setShowDailyCheck] = useState(false);
  
  // Chart interaction state
  const [selectedMetric, setSelectedMetric] = useState<string | null>(null);

  const CustomTooltip = ({ active, payload }: any) => {
    if (active && payload && payload.length) {
      const isProjection = payload[0]?.payload?.isProjection;
      return (
        <div className={`backdrop-blur-xl rounded-lg border p-3 shadow-lg ${
          isDark ? 'bg-slate-900/95 border-white/20' : 'bg-white/95 border-gray-300'
        }`}>
          <p className={`text-xs mb-2 ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
            {isProjection ? 'Target by ' : ''}{payload[0].payload.date}
          </p>
          {payload.map((entry: any, index: number) => (
            <p key={index} className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
              <span className="font-medium">{entry.name}:</span> {entry.value.toFixed(1)}
              {isProjection && <span className={`text-xs ml-1 ${isDark ? 'text-green-400' : 'text-green-600'}`}>(goal)</span>}
            </p>
          ))}
        </div>
      );
    }
    return null;
  };

  if (selectedIntervention) {
    const dailyData = generateDailyData(selectedIntervention, selectedMetric !== null);
    const actualDaysElapsed = Math.min(
      Math.floor((new Date().getTime() - new Date(selectedIntervention.startDate).getTime()) / (1000 * 60 * 60 * 24)),
      selectedIntervention.duration
    );
    const daysElapsed = actualDaysElapsed;
    const daysRemaining = selectedIntervention.duration - daysElapsed;
    const progressPercent = (daysElapsed / selectedIntervention.duration) * 100;

    return (
      <div className={`fixed inset-0 z-50 overflow-y-auto ${
        isDark 
          ? 'bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900' 
          : 'bg-gradient-to-br from-blue-50 via-teal-50 to-cyan-50'
      }`}>
        {/* Header */}
        <header className={`sticky top-0 z-10 backdrop-blur-xl border-b transition-colors ${
          isDark ? 'bg-white/5 border-white/10' : 'bg-white/70 border-black/10'
        }`}>
          <div className="px-4 py-3">
            <div className="flex items-center justify-between">
              <button
                onClick={() => setSelectedIntervention(null)}
                className={`p-2 rounded-lg transition-colors ${
                  isDark ? 'hover:bg-white/10' : 'hover:bg-black/5'
                }`}
              >
                <X className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-gray-600'}`} />
              </button>
              <h1 className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
                Experiment Details
              </h1>
              <div className="w-9" /> {/* Spacer */}
            </div>
          </div>
        </header>

        <main className="px-4 py-6 pb-24 max-w-4xl mx-auto">
          {/* Intervention Header */}
          <div className={`backdrop-blur-xl rounded-2xl border p-5 mb-6 ${
            isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
          }`}>
            <div className="flex items-start justify-between mb-4">
              <div>
                <h2 className={`text-xl mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {selectedIntervention.name}
                </h2>
                <p className={`text-sm ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  {selectedIntervention.dosage} â€¢ {selectedIntervention.frequency}
                </p>
              </div>
              <div className={`px-3 py-1 rounded-full text-xs ${
                isDark ? 'bg-cyan-500/20 text-cyan-300 border border-cyan-500/30' : 'bg-cyan-100 text-cyan-900 border border-cyan-300'
              }`}>
                Active
              </div>
            </div>

            {/* Progress Bar */}
            <div className="mb-4">
              <div className="flex justify-between text-xs mb-2">
                <span className={isDark ? 'text-white/60' : 'text-gray-600'}>
                  Day {daysElapsed} of {selectedIntervention.duration}
                </span>
                <span className={isDark ? 'text-white/60' : 'text-gray-600'}>
                  {daysRemaining} days remaining
                </span>
              </div>
              <div className={`h-2 rounded-full overflow-hidden ${
                isDark ? 'bg-white/10' : 'bg-black/10'
              }`}>
                <div 
                  className="h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500"
                  style={{ width: `${progressPercent}%` }}
                />
              </div>
            </div>

            {/* Goals */}
            <div>
              <p className={`text-xs uppercase tracking-wide mb-2 ${
                isDark ? 'text-white/50' : 'text-gray-500'
              }`}>
                Tracking For
              </p>
              <div className="flex flex-wrap gap-2">
                {selectedIntervention.goals.map(goal => (
                  <span 
                    key={goal}
                    className={`px-3 py-1 rounded-full text-xs ${
                      isDark ? 'bg-purple-500/10 text-purple-300 border border-purple-500/30' : 'bg-purple-50 text-purple-900 border border-purple-200'
                    }`}
                  >
                    {goal}
                  </span>
                ))}
              </div>
            </div>
          </div>

          {/* Daily Check-In Button */}
          <button
            onClick={() => setShowDailyCheck(true)}
            className={`w-full backdrop-blur-xl rounded-xl border p-4 mb-6 transition-all ${
              isDark 
                ? 'bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border-cyan-500/30 hover:from-cyan-500/20 hover:to-blue-500/20' 
                : 'bg-gradient-to-r from-cyan-50 to-blue-50 border-cyan-300 hover:from-cyan-100 hover:to-blue-100'
            }`}
          >
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className={`p-3 rounded-lg ${
                  isDark ? 'bg-cyan-500/20' : 'bg-cyan-100'
                }`}>
                  <CheckCircle className={`w-5 h-5 ${
                    isDark ? 'text-cyan-400' : 'text-cyan-600'
                  }`} />
                </div>
                <div className="text-left">
                  <h3 className={`text-sm font-medium ${
                    isDark ? 'text-white' : 'text-gray-900'
                  }`}>
                    Complete Today's Check-In
                  </h3>
                  <p className={`text-xs ${
                    isDark ? 'text-white/60' : 'text-gray-600'
                  }`}>
                    Log how you're feeling â€¢ 2 min
                  </p>
                </div>
              </div>
              <ChevronRight className={`w-5 h-5 ${
                isDark ? 'text-white/40' : 'text-gray-400'
              }`} />
            </div>
          </button>

          {/* Trend Charts */}
          <div className="space-y-6">
            {/* Combined Metrics Chart with Dual Y-Axes */}
            <div className={`backdrop-blur-xl rounded-xl border p-4 ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
            }`}>
              <div className="flex items-center justify-between mb-4">
                <h3 className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  Metrics Trend
                </h3>
                {selectedMetric && (
                  <button
                    onClick={() => setSelectedMetric(null)}
                    className={`text-xs px-2 py-1 rounded ${
                      isDark ? 'bg-white/10 text-white/70 hover:bg-white/20' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    Show All
                  </button>
                )}
              </div>
              <div style={{ width: '100%', height: '320px', minHeight: '320px' }}>
                <ResponsiveContainer width="100%" height={320}>
                  <LineChart data={dailyData} margin={{ top: 5, right: 30, left: -20, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke={isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'} />
                    <XAxis 
                      dataKey="day" 
                      stroke={isDark ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)'}
                      tick={{ fill: isDark ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)', fontSize: 11 }}
                    />
                    {/* Left Y-Axis for Subjective Metrics (0-10) */}
                    <YAxis 
                      yAxisId="left"
                      domain={[0, 10]}
                      stroke={isDark ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)'}
                      tick={{ fill: isDark ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)', fontSize: 11 }}
                      label={{ value: 'Subjective (1-10)', angle: -90, position: 'insideLeft', style: { fill: isDark ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)', fontSize: 10 } }}
                    />
                    {/* Right Y-Axis for Objective Metrics */}
                    <YAxis 
                      yAxisId="right"
                      orientation="right"
                      stroke={isDark ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)'}
                      tick={{ fill: isDark ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)', fontSize: 11 }}
                      label={{ value: 'Objective', angle: 90, position: 'insideRight', style: { fill: isDark ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)', fontSize: 10 } }}
                    />
                    <Tooltip content={<CustomTooltip />} />
                    <ReferenceLine yAxisId="left" y={7} stroke={isDark ? 'rgba(16, 185, 129, 0.3)' : 'rgba(16, 185, 129, 0.4)'} strokeDasharray="3 3" />
                    
                    {/* Subjective Metrics - Left Axis */}
                    <Line 
                      yAxisId="left" 
                      type="monotone" 
                      dataKey="sleepQuality" 
                      stroke="#8b5cf6" 
                      strokeWidth={selectedMetric === 'sleepQuality' ? 3 : 2}
                      strokeOpacity={!selectedMetric || selectedMetric === 'sleepQuality' ? 1 : 0.2}
                      dot={false}
                      name="Sleep Quality"
                      connectNulls
                    />
                    <Line 
                      yAxisId="left" 
                      type="monotone" 
                      dataKey="focus" 
                      stroke="#06b6d4" 
                      strokeWidth={selectedMetric === 'focus' ? 3 : 2}
                      strokeOpacity={!selectedMetric || selectedMetric === 'focus' ? 1 : 0.2}
                      dot={false}
                      name="Focus"
                      connectNulls
                    />
                    <Line 
                      yAxisId="left" 
                      type="monotone" 
                      dataKey="energy" 
                      stroke="#10b981" 
                      strokeWidth={selectedMetric === 'energy' ? 3 : 2}
                      strokeOpacity={!selectedMetric || selectedMetric === 'energy' ? 1 : 0.2}
                      dot={false}
                      name="Energy"
                      connectNulls
                    />
                    
                    {/* Objective Metrics - Right Axis */}
                    <Line 
                      yAxisId="right" 
                      type="monotone" 
                      dataKey="hrv" 
                      stroke="#ec4899" 
                      strokeWidth={selectedMetric === 'hrv' ? 3 : 2}
                      strokeOpacity={!selectedMetric || selectedMetric === 'hrv' ? 1 : 0.2}
                      dot={false}
                      name="HRV (ms)"
                      connectNulls
                    />
                    <Line 
                      yAxisId="right" 
                      type="monotone" 
                      dataKey="deepSleep" 
                      stroke="#f59e0b" 
                      strokeWidth={selectedMetric === 'deepSleep' ? 3 : 2}
                      strokeOpacity={!selectedMetric || selectedMetric === 'deepSleep' ? 1 : 0.2}
                      dot={false}
                      name="Deep Sleep %"
                      connectNulls
                    />
                  </LineChart>
                </ResponsiveContainer>
              </div>
              <div className="space-y-2 mt-4">
                <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'} mb-2`}>
                  {selectedMetric 
                    ? 'Click the metric again or "Show All" to view all metrics' 
                    : 'Click any metric below to focus on it and see success target projection'}
                </p>
                <div className="flex items-center gap-4 text-xs flex-wrap">
                  <span className={`font-medium ${isDark ? 'text-white/70' : 'text-gray-700'}`}>Subjective:</span>
                  <button
                    onClick={() => setSelectedMetric(selectedMetric === 'sleepQuality' ? null : 'sleepQuality')}
                    className={`flex items-center gap-2 transition-opacity ${
                      !selectedMetric || selectedMetric === 'sleepQuality' ? 'opacity-100' : 'opacity-40'
                    } hover:opacity-100`}
                  >
                    <div className="w-6 h-0.5 bg-purple-500"></div>
                    <span className={isDark ? 'text-white/60' : 'text-gray-600'}>Sleep Quality</span>
                  </button>
                  <button
                    onClick={() => setSelectedMetric(selectedMetric === 'focus' ? null : 'focus')}
                    className={`flex items-center gap-2 transition-opacity ${
                      !selectedMetric || selectedMetric === 'focus' ? 'opacity-100' : 'opacity-40'
                    } hover:opacity-100`}
                  >
                    <div className="w-6 h-0.5 bg-cyan-500"></div>
                    <span className={isDark ? 'text-white/60' : 'text-gray-600'}>Focus</span>
                  </button>
                  <button
                    onClick={() => setSelectedMetric(selectedMetric === 'energy' ? null : 'energy')}
                    className={`flex items-center gap-2 transition-opacity ${
                      !selectedMetric || selectedMetric === 'energy' ? 'opacity-100' : 'opacity-40'
                    } hover:opacity-100`}
                  >
                    <div className="w-6 h-0.5 bg-green-500"></div>
                    <span className={isDark ? 'text-white/60' : 'text-gray-600'}>Energy</span>
                  </button>
                </div>
                <div className="flex items-center gap-4 text-xs flex-wrap">
                  <span className={`font-medium ${isDark ? 'text-white/70' : 'text-gray-700'}`}>Objective:</span>
                  <button
                    onClick={() => setSelectedMetric(selectedMetric === 'hrv' ? null : 'hrv')}
                    className={`flex items-center gap-2 transition-opacity ${
                      !selectedMetric || selectedMetric === 'hrv' ? 'opacity-100' : 'opacity-40'
                    } hover:opacity-100`}
                  >
                    <div className="w-6 h-0.5 bg-pink-500"></div>
                    <span className={isDark ? 'text-white/60' : 'text-gray-600'}>HRV (ms)</span>
                  </button>
                  <button
                    onClick={() => setSelectedMetric(selectedMetric === 'deepSleep' ? null : 'deepSleep')}
                    className={`flex items-center gap-2 transition-opacity ${
                      !selectedMetric || selectedMetric === 'deepSleep' ? 'opacity-100' : 'opacity-40'
                    } hover:opacity-100`}
                  >
                    <div className="w-6 h-0.5 bg-amber-500"></div>
                    <span className={isDark ? 'text-white/60' : 'text-gray-600'}>Deep Sleep %</span>
                  </button>
                </div>
              </div>
            </div>

            {/* AI Insights */}
            {selectedIntervention.results && (
              <div className={`backdrop-blur-xl rounded-xl border p-4 ${
                isDark ? 'bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border-cyan-500/20' : 'bg-gradient-to-br from-cyan-50 to-blue-50 border-cyan-200'
              }`}>
                <div className="flex items-start gap-3">
                  <div className={`p-2 rounded-lg ${isDark ? 'bg-cyan-500/20' : 'bg-cyan-100'}`}>
                    <Sparkles className={`w-5 h-5 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`} />
                  </div>
                  <div className="flex-1">
                    <h3 className={`text-sm mb-2 ${isDark ? 'text-cyan-300' : 'text-cyan-900'}`}>
                      AI Analysis (Day {daysElapsed})
                    </h3>
                    <p className={`text-xs leading-relaxed mb-3 ${isDark ? 'text-white/80' : 'text-gray-700'}`}>
                      Based on {daysElapsed} days of data, we're seeing positive trends in sleep quality (+18%) and deep sleep percentage (+22%). Your HRV has improved by 6ms on average. These changes correlate strongly with your magnesium supplementation timing (before bed).
                    </p>
                    
                    {/* Results Grid */}
                    <div className="space-y-2">
                      {selectedIntervention.results.improved.length > 0 && (
                        <div>
                          <p className={`text-xs font-medium mb-1 flex items-center gap-1 ${isDark ? 'text-green-400' : 'text-green-700'}`}>
                            <TrendingUp className="w-3 h-3" />
                            Improved
                          </p>
                          <div className="flex flex-wrap gap-1">
                            {selectedIntervention.results.improved.map(metric => (
                              <span key={metric} className={`text-xs px-2 py-0.5 rounded-full ${
                                isDark ? 'bg-green-500/20 text-green-300' : 'bg-green-100 text-green-800'
                              }`}>
                                {metric}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                      
                      {selectedIntervention.results.noChange.length > 0 && (
                        <div>
                          <p className={`text-xs font-medium mb-1 ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                            No Significant Change
                          </p>
                          <div className="flex flex-wrap gap-1">
                            {selectedIntervention.results.noChange.map(metric => (
                              <span key={metric} className={`text-xs px-2 py-0.5 rounded-full ${
                                isDark ? 'bg-white/10 text-white/60' : 'bg-gray-100 text-gray-600'
                              }`}>
                                {metric}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </main>

        {/* Daily Check-In Modal */}
        {showDailyCheck && (
          <div className="fixed inset-0 z-60 flex items-center justify-center p-4 bg-black/50">
            <div className={`w-full max-w-md backdrop-blur-xl rounded-2xl border p-6 ${
              isDark ? 'bg-slate-900 border-white/20' : 'bg-white border-gray-300'
            }`}>
              <div className="flex items-center justify-between mb-4">
                <h2 className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  Day {daysElapsed} Check-In
                </h2>
                <button onClick={() => setShowDailyCheck(false)}>
                  <X className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-gray-600'}`} />
                </button>
              </div>

              <div className={`p-3 rounded-lg mb-4 ${isDark ? 'bg-blue-500/10' : 'bg-blue-50'}`}>
                <p className={`text-xs ${isDark ? 'text-blue-300' : 'text-blue-900'}`}>
                  ðŸ’¡ Objective metrics (HRV, sleep, etc.) are automatically tracked from your connected devices. Only rate how you feel below:
                </p>
              </div>

              <div className="space-y-4">
                {/* Only show subjective metrics that need daily input */}
                {selectedIntervention.trackingMetrics.subjective.map(metric => (
                  <div key={metric}>
                    <label className={`text-sm mb-2 block ${isDark ? 'text-white/80' : 'text-gray-700'}`}>
                      How would you rate your <span className="font-medium">{metric}</span> today?
                    </label>
                    <div className="flex items-center gap-3">
                      <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>0</span>
                      <input
                        type="range"
                        min="0"
                        max="10"
                        defaultValue="5"
                        className="flex-1"
                      />
                      <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>10</span>
                    </div>
                    <div className="flex justify-between text-xs mt-1">
                      <span className={isDark ? 'text-white/40' : 'text-gray-500'}>Poor</span>
                      <span className={isDark ? 'text-white/40' : 'text-gray-500'}>Excellent</span>
                    </div>
                  </div>
                ))}

                <button
                  onClick={() => {
                    console.log('Saving daily check-in');
                    // Placeholder: Save to database
                    setShowDailyCheck(false);
                  }}
                  className="w-full py-3 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-medium mt-2"
                >
                  Save Check-In
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className={`fixed inset-0 z-50 overflow-y-auto ${
      isDark 
        ? 'bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900' 
        : 'bg-gradient-to-br from-blue-50 via-teal-50 to-cyan-50'
    }`}>
      {/* Header */}
      <header className={`sticky top-0 z-10 backdrop-blur-xl border-b transition-colors ${
        isDark ? 'bg-white/5 border-white/10' : 'bg-white/70 border-black/10'
      }`}>
        <div className="px-4 py-3">
          <div className="flex items-center justify-between">
            <button
              onClick={onClose}
              className={`p-2 rounded-lg transition-colors ${
                isDark ? 'hover:bg-white/10' : 'hover:bg-black/5'
              }`}
            >
              <X className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-gray-600'}`} />
            </button>
            <h1 className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Interventions
            </h1>
            <button
              onClick={() => setShowNewInterventionModal(true)}
              className={`p-2 rounded-lg transition-colors ${
                isDark ? 'hover:bg-white/10' : 'hover:bg-black/5'
              }`}
            >
              <Plus className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-gray-600'}`} />
            </button>
          </div>
        </div>
      </header>

      <main className="px-4 py-6 pb-24">
        {/* Introduction */}
        <button
          onClick={() => setShowNewInterventionModal(true)}
          className={`w-full backdrop-blur-xl rounded-2xl border p-5 mb-6 transition-all text-left ${
            isDark ? 'bg-gradient-to-br from-purple-500/10 to-cyan-500/10 border-purple-500/20 hover:from-purple-500/15 hover:to-cyan-500/15' : 'bg-gradient-to-br from-purple-50 to-cyan-50 border-purple-200 hover:from-purple-100 hover:to-cyan-100'
          }`}
        >
          <div className="flex items-start gap-3">
            <div className={`p-2 rounded-lg ${isDark ? 'bg-purple-500/20' : 'bg-purple-100'}`}>
              <Activity className={`w-5 h-5 ${isDark ? 'text-purple-400' : 'text-purple-600'}`} />
            </div>
            <div className="flex-1">
              <h2 className={`text-sm mb-2 ${isDark ? 'text-purple-300' : 'text-purple-900'}`}>
                N-of-1 Experiments
              </h2>
              <p className={`text-xs ${isDark ? 'text-white/80' : 'text-gray-700'} leading-relaxed mb-2`}>
                Track supplements, medications, and lifestyle changes to discover what actually works for you. We'll combine your biomarkers, wearable data, and subjective feedback to show cause-and-effect relationships.
              </p>
              <p className={`text-xs ${isDark ? 'text-purple-300' : 'text-purple-700'} font-medium`}>
                Tap to start a new experiment â†’
              </p>
            </div>
          </div>
        </button>

        {/* Active Interventions */}
        {mockInterventions.length > 0 && (
          <div className="mb-6">
            <div className="flex items-center justify-between mb-3">
              <h3 className={`text-sm ${isDark ? 'text-white/80' : 'text-gray-700'}`}>
                Active Experiments ({mockInterventions.length})
              </h3>
              <button
                onClick={() => setShowNewInterventionModal(true)}
                className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                  isDark 
                    ? 'bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-lg shadow-cyan-500/25' 
                    : 'bg-gradient-to-r from-cyan-400 to-blue-400 text-white shadow-lg'
                }`}
              >
                + New Experiment
              </button>
            </div>
            <div className="space-y-3">
              {mockInterventions.map(intervention => {
                const daysElapsed = Math.min(
                  Math.floor((new Date().getTime() - new Date(intervention.startDate).getTime()) / (1000 * 60 * 60 * 24)),
                  intervention.duration
                );
                const progressPercent = (daysElapsed / intervention.duration) * 100;

                return (
                  <button
                    key={intervention.id}
                    onClick={() => setSelectedIntervention(intervention)}
                    className={`w-full backdrop-blur-xl rounded-xl border p-4 transition-all text-left ${
                      isDark 
                        ? 'bg-white/5 border-white/10 hover:bg-white/10' 
                        : 'bg-white/60 border-black/10 hover:bg-white/80'
                    }`}
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-3">
                        <div className={`p-2 rounded-lg ${
                          isDark ? 'bg-cyan-500/20' : 'bg-cyan-100'
                        }`}>
                          <Pill className={`w-4 h-4 ${
                            isDark ? 'text-cyan-400' : 'text-cyan-600'
                          }`} />
                        </div>
                        <div>
                          <h4 className={`text-sm font-medium ${
                            isDark ? 'text-white' : 'text-gray-900'
                          }`}>
                            {intervention.name}
                          </h4>
                          <p className={`text-xs ${
                            isDark ? 'text-white/60' : 'text-gray-600'
                          }`}>
                            {intervention.dosage} â€¢ {intervention.frequency}
                          </p>
                        </div>
                      </div>
                      <ChevronRight className={`w-5 h-5 ${
                        isDark ? 'text-white/40' : 'text-gray-400'
                      }`} />
                    </div>

                    <div className="mb-3">
                      <div className="flex justify-between text-xs mb-1">
                        <span className={isDark ? 'text-white/60' : 'text-gray-600'}>
                          Day {daysElapsed} of {intervention.duration}
                        </span>
                        <span className={isDark ? 'text-white/60' : 'text-gray-600'}>
                          {Math.round(progressPercent)}%
                        </span>
                      </div>
                      <div className={`h-1.5 rounded-full overflow-hidden ${
                        isDark ? 'bg-white/10' : 'bg-black/10'
                      }`}>
                        <div 
                          className="h-full bg-gradient-to-r from-cyan-500 to-blue-500"
                          style={{ width: `${progressPercent}%` }}
                        />
                      </div>
                    </div>

                    <div className="flex flex-wrap gap-1">
                      {intervention.goals.slice(0, 3).map(goal => (
                        <span 
                          key={goal}
                          className={`px-2 py-0.5 rounded-full text-xs ${
                            isDark ? 'bg-purple-500/10 text-purple-300' : 'bg-purple-50 text-purple-900'
                          }`}
                        >
                          {goal}
                        </span>
                      ))}
                      {intervention.goals.length > 3 && (
                        <span className={`px-2 py-0.5 rounded-full text-xs ${
                          isDark ? 'bg-white/10 text-white/60' : 'bg-gray-100 text-gray-600'
                        }`}>
                          +{intervention.goals.length - 3}
                        </span>
                      )}
                    </div>
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {/* Empty State */}
        {mockInterventions.length === 0 && (
          <div className={`backdrop-blur-xl rounded-2xl border p-8 text-center ${
            isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
          }`}>
            <div className={`w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center ${
              isDark ? 'bg-purple-500/10' : 'bg-purple-50'
            }`}>
              <Pill className={`w-8 h-8 ${isDark ? 'text-purple-400' : 'text-purple-600'}`} />
            </div>
            <h3 className={`text-base mb-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              No Active Experiments
            </h3>
            <p className={`text-sm mb-4 ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
              Start tracking a supplement or lifestyle change to discover what works for you
            </p>
            <button
              onClick={() => setShowNewInterventionModal(true)}
              className="px-6 py-2 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 text-white text-sm font-medium"
            >
              Start First Experiment
            </button>
          </div>
        )}
      </main>

      {/* New N-of-1 Experiment Wizard */}
      {showNewInterventionModal && (
        <N1ExperimentWizard
          isDark={isDark}
          onClose={() => setShowNewInterventionModal(false)}
          onComplete={(config) => {
            console.log('Experiment created:', config);
            setShowNewInterventionModal(false);
          }}
        />
      )}
    </div>
  );
}