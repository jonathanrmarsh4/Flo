{
  "file": "01_user_insights_schema.json",
  "description": "Shared user_insights store that both GPT-based Insights and Grok-based Chat can read from and write to. This MUST NOT block the existing insights or chat pipelines; it's an additive memory layer.",
  "entities": {
    "tables": {
      "user_insights": {
        "description": "Human-readable health insights, observations and notes about a user. Generated by GPT (insights job), summarisation jobs, or chat.",
        "columns": {
          "id": {
            "type": "uuid",
            "primary_key": true,
            "default": "generated"
          },
          "user_id": {
            "type": "uuid",
            "nullable": false,
            "index": true,
            "description": "Foreign key to users table."
          },
          "text": {
            "type": "text",
            "nullable": false,
            "description": "Natural language insight or note about the user's health, behaviour, or patterns."
          },
          "source": {
            "type": "enum",
            "values": [
              "gpt_insights_job",
              "chat_brain_update",
              "chat_summary_job",
              "manual"
            ],
            "default": "gpt_insights_job",
            "description": "Which subsystem created this insight. Used for debugging and evolution."
          },
          "tags": {
            "type": "text[]",
            "nullable": false,
            "default": [],
            "description": "Short keywords like ['lipids', 'sleep', 'trend-worse', 'training-load'] to help filter and retrieve."
          },
          "importance": {
            "type": "integer",
            "nullable": false,
            "default": 3,
            "description": "1-5 where 5 = critical / high impact. Used to prioritise what we pass into chat."
          },
          "status": {
            "type": "enum",
            "values": [
              "active",
              "resolved",
              "dismissed"
            ],
            "default": "active",
            "description": "Whether this insight is still relevant. Do NOT delete rows; change status instead."
          },
          "created_at": {
            "type": "timestamptz",
            "nullable": false,
            "default": "now()"
          },
          "updated_at": {
            "type": "timestamptz",
            "nullable": false,
            "default": "now()",
            "on_update": "now()"
          }
        },
        "indexes": [
          {
            "name": "idx_user_insights_user_id_created_at",
            "columns": [
              "user_id",
              "created_at"
            ],
            "desc": true
          },
          {
            "name": "idx_user_insights_user_id_status",
            "columns": [
              "user_id",
              "status"
            ]
          }
        ]
      }
    },
    "vector_indexes": {
      "user_insights_embedding": {
        "description": "Vector index over user_insights.text so we can RAG the most relevant insights into chat.",
        "index_name": "user_insights_embedding",
        "dimension": 1536,
        "vector_type": "float32",
        "backing_store": "pgvector_or_external",
        "fields": {
          "embedding": "vector",
          "metadata": {
            "user_id": "uuid",
            "insight_id": "uuid",
            "importance": "integer",
            "tags": "text[]",
            "created_at": "timestamptz"
          }
        }
      }
    }
  },
  "non_blocking_principles": [
    "Do not change existing tables or pipelines; this schema is additive.",
    "All writes to user_insights are asynchronous or side-effect only; they must not block current GPT Insights or Grok chat response times.",
    "Chat retrieval should be limited (e.g. <= 10-15 insights per turn) to avoid latency spikes."
  ]
}
