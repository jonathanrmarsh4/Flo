import { useState } from 'react';
import { Droplet, Activity, Apple, Gauge, TrendingUp, TrendingDown, AlertCircle, Footprints, Dumbbell, Heart, Battery, Waves, ChevronRight, Home, Lightbulb, Moon, Plus, Edit2, Play, Square, Clock, Sparkles, Trophy, Flame } from 'lucide-react';
import { FloIcon } from './FloLogo';
import { SleepDetailsModal } from './SleepDetailsModal';
import { MacrosWeekView } from './MacrosWeekView';
import { MorningBriefing } from './MorningBriefing';
import { CGMScreen } from './CGMScreen';
import { RecoveryTab } from './RecoveryTab';
import { TodaysMealsCard } from './TodaysMealsCard';
import { DailyMealBreakdownModal } from './DailyMealBreakdownModal';

type TabType = 'activity' | 'recovery' | 'nutrition' | 'glucose';

interface LoggedMeal {
  id: string;
  meal: string;
  dateTime: Date;
  items: Array<{
    id: string;
    name: string;
    confidence: 'high' | 'medium' | 'low';
    portion: string;
    calories: number;
    protein: number;
    carbs: number;
    fats: number;
    thumbnail?: string;
  }>;
}

interface ActivityScreenProps {
  isDark: boolean;
  onClose: () => void;
  onNavigateToDashboard?: () => void;
  onNavigateToLabs?: () => void;
  onNavigateToActions?: () => void;
  onOpenAddModal?: () => void;
  onTabChange?: (tab: TabType) => void;
  onOpenFoodLogging?: () => void;
  loggedMeals?: LoggedMeal[];
}

export function ActivityScreen({ isDark, onClose, onNavigateToDashboard, onNavigateToLabs, onNavigateToActions, onOpenAddModal, onTabChange, onOpenFoodLogging, loggedMeals = [] }: ActivityScreenProps) {
  const [activeTab, setActiveTab] = useState<TabType>('activity');
  const [showMorningBriefing, setShowMorningBriefing] = useState(false);

  const handleTabChange = (tab: TabType) => {
    setActiveTab(tab);
    if (onTabChange) {
      onTabChange(tab);
    }
  };

  // Show full CGMScreen when glucose tab is active
  if (activeTab === 'glucose') {
    return (
      <div className="fixed inset-0 z-50 overflow-y-auto">
        <CGMScreen isDark={isDark} onBack={() => handleTabChange('activity')} />
      </div>
    );
  }

  return (
    <div className={`fixed inset-0 z-50 ${
      isDark 
        ? 'bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900' 
        : 'bg-gradient-to-br from-blue-50 via-teal-50 to-cyan-50'
    }`}>
      {/* Header */}
      <header className={`sticky top-0 z-50 backdrop-blur-xl border-b transition-colors ${
        isDark ? 'bg-white/5 border-white/10' : 'bg-white/70 border-black/10'
      }`}>
        <div className="px-4 py-3">
          <div>
            <h1 className={`text-xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Activity
            </h1>
            <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Track your health journey
            </p>
          </div>
        </div>

        {/* Tabs */}
        <div className="px-4 pb-2">
          <div className="flex gap-2 overflow-x-auto">
            <TabButton
              icon={<Activity className="w-4 h-4" />}
              label="Activity"
              isActive={activeTab === 'activity'}
              onClick={() => handleTabChange('activity')}
              isDark={isDark}
            />
            <TabButton
              icon={<Flame className="w-4 h-4" />}
              label="Recovery"
              isActive={activeTab === 'recovery'}
              onClick={() => handleTabChange('recovery')}
              isDark={isDark}
            />
            <TabButton
              icon={<Apple className="w-4 h-4" />}
              label="Nutrition"
              isActive={activeTab === 'nutrition'}
              onClick={() => handleTabChange('nutrition')}
              isDark={isDark}
            />
            <TabButton
              icon={<Gauge className="w-4 h-4" />}
              label="Glucose"
              isActive={activeTab === 'glucose'}
              onClick={() => handleTabChange('glucose')}
              isDark={isDark}
            />
          </div>
        </div>
      </header>

      {/* Content */}
      <main className="overflow-y-auto px-4 py-6 pb-32" style={{ height: 'calc(100vh - 140px)' }}>
        <div className="max-w-2xl mx-auto">
          {/* Morning Briefing Test Button */}
          <button
            onClick={() => setShowMorningBriefing(true)}
            className={`w-full mb-4 p-4 rounded-2xl border transition-all ${
              isDark 
                ? 'bg-gradient-to-r from-purple-500/20 to-pink-500/20 border-purple-500/30 hover:from-purple-500/30 hover:to-pink-500/30' 
                : 'bg-gradient-to-r from-purple-100 to-pink-100 border-purple-300 hover:from-purple-200 hover:to-pink-200'
            }`}
          >
            <div className="flex items-center justify-between">
              <div className="text-left">
                <div className={`text-sm mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  Morning Briefing
                </div>
                <div className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  Tap to view your daily briefing
                </div>
              </div>
              <Sparkles className={`w-6 h-6 ${isDark ? 'text-purple-400' : 'text-purple-600'}`} />
            </div>
          </button>

          {activeTab === 'activity' && <ActivityTabContent isDark={isDark} />}
          {activeTab === 'recovery' && <RecoveryTab isDark={isDark} />}
          {activeTab === 'nutrition' && <NutritionTabContent isDark={isDark} loggedMeals={loggedMeals} />}
          {activeTab === 'glucose' && <GlucoseTabContent isDark={isDark} />}
        </div>
      </main>

      {/* Bottom Navigation */}
      <nav
        className={`fixed bottom-0 left-0 right-0 z-50 backdrop-blur-xl border-t transition-colors ${
          isDark
            ? 'bg-white/5 border-white/10'
            : 'bg-white/70 border-black/10'
        }`}
      >
        <div className="grid grid-cols-5 items-center px-2 py-3">
          <button
            onClick={onNavigateToDashboard}
            className="flex flex-col items-center gap-1 px-2 py-2"
          >
            <Home
              className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-gray-600'}`}
            />
            <span
              className={`text-[10px] ${isDark ? 'text-white/70' : 'text-gray-600'}`}
            >
              Dashboard
            </span>
          </button>

          <button
            onClick={onNavigateToLabs}
            className="flex flex-col items-center gap-1 px-2 py-2"
          >
            <Droplet
              className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-gray-600'}`}
            />
            <span
              className={`text-[10px] ${isDark ? 'text-white/70' : 'text-gray-600'}`}
            >
              Labs
            </span>
          </button>

          <button
            onClick={() => {
              console.log('ActivityScreen Flō button clicked, activeTab:', activeTab);
              if (activeTab === 'nutrition' && onOpenFoodLogging) {
                console.log('Opening food logging from ActivityScreen');
                onOpenFoodLogging();
              } else if (onOpenAddModal) {
                onOpenAddModal();
              }
            }}
            className="flex flex-col items-center gap-1 px-2 py-2 -mt-2"
          >
            <div className="w-12 h-12 rounded-full bg-gradient-to-r from-teal-500 via-cyan-500 to-blue-500 flex items-center justify-center shadow-xl shadow-cyan-500/30 pointer-events-none">
              <FloIcon size={28} className="text-white pointer-events-none" />
            </div>
            <span
              className={`text-[10px] mt-1 ${isDark ? 'text-white/70' : 'text-gray-600'}`}
            >
              {activeTab === 'nutrition' ? 'Log' : 'Add'}
            </span>
          </button>

          <button
            className="flex flex-col items-center gap-1 px-2 py-2"
          >
            <Activity
              className={`w-5 h-5 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`}
            />
            <span
              className={`text-[10px] ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`}
            >
              Activity
            </span>
          </button>

          <button
            onClick={onNavigateToActions}
            className="flex flex-col items-center gap-1 px-2 py-2"
          >
            <Lightbulb
              className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-gray-600'}`}
            />
            <span
              className={`text-[10px] ${isDark ? 'text-white/70' : 'text-gray-600'}`}
            >
              Actions
            </span>
          </button>
        </div>
      </nav>

      {/* Morning Briefing Modal */}
      {showMorningBriefing && (
        <MorningBriefing 
          isDark={isDark}
          onClose={() => setShowMorningBriefing(false)}
          userName="Alex"
          onLaunchVoiceChat={() => {
            setShowMorningBriefing(false);
            // TODO: Launch your voice chat component/screen here
            console.log('Launching voice chat for morning briefing...');
            alert('Voice chat would launch here! (Not yet implemented)');
          }}
        />
      )}
    </div>
  );
}

interface TabButtonProps {
  icon: React.ReactNode;
  label: string;
  isActive: boolean;
  onClick: () => void;
  isDark: boolean;
}

function TabButton({ icon, label, isActive, onClick, isDark }: TabButtonProps) {
  return (
    <button
      onClick={onClick}
      className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm transition-all ${
        isActive
          ? isDark
            ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30'
            : 'bg-cyan-100 text-cyan-700 border border-cyan-300'
          : isDark
            ? 'bg-white/5 text-white/60 border border-white/10 hover:bg-white/10'
            : 'bg-white/40 text-gray-600 border border-black/10 hover:bg-white/60'
      }`}
    >
      {icon}
      <span>{label}</span>
    </button>
  );
}

// Activity Tab Content
function ActivityTabContent({ isDark }: { isDark: boolean }) {
  const [showActivityDetails, setShowActivityDetails] = useState(false);
  const [showWorkoutDetails, setShowWorkoutDetails] = useState(false);
  const [showSleepDetails, setShowSleepDetails] = useState(false);
  
  // Mock data
  const steps = 7420;
  const stepsGoal = 10000;
  const stepsPercent = (steps / stepsGoal) * 100;
  
  const distance = 5.8; // km
  const activeEnergy = 342; // kcal
  const exerciseMinutes = 48;
  const exerciseGoal = 30;
  const standHours = 9;
  const flightsClimbed = 12;
  
  // Workouts data
  const workoutsToday = 2;
  const workoutsDuration = 63; // minutes
  const workoutsEnergy = 412; // kcal
  const lastWorkout = {
    type: 'Run',
    distance: 5.2,
    avgHeartRate: 145,
    elevation: 120
  };
  
  // Cardio Fitness data
  const vo2Max = 44;
  const vo2Level = 'Good';
  const restingHeartRate = 58;
  const sixMinWalk = 620; // meters
  const vo2Trend: 'up' | 'stable' | 'down' = 'up';
  
  // Recovery & Strain data
  const hrv = 72; // ms
  const hrvBaseline = 68;
  const hrvStatus: 'recovered' | 'ok' | 'strained' = hrv >= hrvBaseline + 5 ? 'recovered' : hrv < hrvBaseline - 5 ? 'strained' : 'ok';
  const rhrStatus = 'Normal';
  
  // Movement Quality data
  const movementQuality: 'stable' | 'watch' | 'attention' = 'stable';
  const movementScore = 87; // out of 100
  const movementDelta = 3; // vs last week
  const walkingSpeed = 5.2; // km/h
  const stepLength = 74; // cm
  const doubleSupport = 28.4; // %
  const asymmetry = 2.1; // %
  
  // Sleep data
  const sleepScore = 82; // Flo Sleep Index out of 100
  const sleepDuration = 7.5; // hours
  const sleepQuality: 'excellent' | 'good' | 'fair' | 'poor' = 'good';
  const deepSleep = 1.8; // hours
  const remSleep = 2.1; // hours
  
  return (
    <div className="space-y-4">
      {/* Tile 1 - Today's Activity */}
      <button 
        onClick={() => setShowActivityDetails(true)}
        className={`w-full backdrop-blur-xl rounded-3xl border p-6 transition-all text-left ${
          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-white/60 border-black/10 hover:bg-white/80'
        }`}
      >
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            <Footprints className={`w-5 h-5 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`} />
            <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
              Today's Activity
            </h3>
          </div>
          <ChevronRight className={`w-5 h-5 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
        </div>
        
        {/* Progress Ring with Steps */}
        <div className="flex items-center gap-6 mb-4">
          <div className="relative w-28 h-28">
            <svg className="w-28 h-28 -rotate-90" viewBox="0 0 100 100">
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke={isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}
                strokeWidth="8"
              />
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke="url(#steps-gradient)"
                strokeWidth="8"
                strokeLinecap="round"
                strokeDasharray={`${stepsPercent * 2.64} 264`}
              />
              <defs>
                <linearGradient id="steps-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stopColor="#06b6d4" />
                  <stop offset="100%" stopColor="#3b82f6" />
                </linearGradient>
              </defs>
            </svg>
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="text-center">
                <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {steps.toLocaleString()}
                </div>
                <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                  steps
                </div>
              </div>
            </div>
          </div>
          
          <div className="flex-1">
            <div className={`text-sm mb-1 ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
              Goal: {stepsGoal.toLocaleString()}
            </div>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              {Math.round(stepsPercent)}% complete
            </div>
          </div>
        </div>
        
        {/* Exercise Minutes Bar */}
        <div className="mb-4">
          <div className="flex items-center justify-between mb-1">
            <span className={`text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
              Exercise
            </span>
            <span className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              {exerciseMinutes}/{exerciseGoal} min
            </span>
          </div>
          <div className={`h-1.5 rounded-full overflow-hidden ${
            isDark ? 'bg-white/10' : 'bg-gray-200'
          }`}>
            <div 
              className="h-full bg-gradient-to-r from-green-400 to-green-500"
              style={{ width: `${Math.min((exerciseMinutes / exerciseGoal) * 100, 100)}%` }}
            />
          </div>
        </div>
        
        {/* Secondary Metrics */}
        <div className="grid grid-cols-3 gap-2">
          <div className={`text-center p-2 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Distance</div>
            <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>{distance} km</div>
          </div>
          <div className={`text-center p-2 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Energy</div>
            <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>{activeEnergy} cal</div>
          </div>
          <div className={`text-center p-2 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Stand</div>
            <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>{standHours} hrs</div>
          </div>
        </div>
        
        {flightsClimbed > 0 && (
          <div className={`mt-3 text-xs text-center ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
            {flightsClimbed} flights climbed
          </div>
        )}
      </button>
      
      {/* Tile 2 - Workouts */}
      <button 
        onClick={() => setShowWorkoutDetails(true)}
        className={`w-full backdrop-blur-xl rounded-3xl border p-6 transition-all text-left ${
          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-white/60 border-black/10 hover:bg-white/80'
        }`}
      >
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            <Dumbbell className={`w-5 h-5 ${isDark ? 'text-purple-400' : 'text-purple-600'}`} />
            <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
              Workouts
            </h3>
          </div>
          <ChevronRight className={`w-5 h-5 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
        </div>
        
        <div className="mb-4">
          <div className={`text-3xl mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
            {workoutsToday} workouts · {workoutsDuration} min
          </div>
          <div className={`text-sm ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
            {workoutsEnergy} cal burned
          </div>
        </div>
        
        {/* Last Workout */}
        <div className={`p-3 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
          <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
            Last workout
          </div>
          <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
            {lastWorkout.distance} km {lastWorkout.type} · {lastWorkout.avgHeartRate} bpm avg
          </div>
          {lastWorkout.elevation > 0 && (
            <div className={`inline-flex items-center gap-1 mt-1 px-2 py-0.5 rounded-full text-xs ${
              isDark ? 'bg-orange-500/20 text-orange-400' : 'bg-orange-100 text-orange-700'
            }`}>
              <TrendingUp className="w-3 h-3" />
              +{lastWorkout.elevation} m
            </div>
          )}
        </div>
      </button>
      
      {/* Tile 3 - Cardio Fitness */}
      <button 
        className={`w-full backdrop-blur-xl rounded-3xl border p-6 transition-all text-left ${
          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-white/60 border-black/10 hover:bg-white/80'
        }`}
      >
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            <Heart className={`w-5 h-5 ${isDark ? 'text-red-400' : 'text-red-600'}`} />
            <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
              Cardio Fitness
            </h3>
          </div>
          <ChevronRight className={`w-5 h-5 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
        </div>
        
        <div className="flex items-baseline gap-2 mb-3">
          <span className={`text-4xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
            {vo2Max}
          </span>
          <span className={`text-lg ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
            ml/kg/min
          </span>
          <span className={`ml-2 px-3 py-1 rounded-full text-xs ${
            isDark ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700'
          }`}>
            {vo2Level}
          </span>
        </div>
        
        <div className="grid grid-cols-2 gap-4 mb-3">
          <div>
            <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Resting HR (7d avg)
            </div>
            <div className={`text-xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
              {restingHeartRate} bpm
            </div>
          </div>
          <div>
            <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              6-min walk
            </div>
            <div className={`text-xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
              {sixMinWalk} m
            </div>
          </div>
        </div>
        
        {/* 30-day trend indicator */}
        <div className={`flex items-center gap-2 text-sm ${
          vo2Trend === 'up' ? isDark ? 'text-green-400' : 'text-green-600' :
          vo2Trend === 'down' ? isDark ? 'text-red-400' : 'text-red-600' :
          isDark ? 'text-white/50' : 'text-gray-500'
        }`}>
          {vo2Trend === 'up' && <TrendingUp className="w-4 h-4" />}
          {vo2Trend === 'stable' && <span className="w-4 h-0.5 bg-current"></span>}
          {vo2Trend === 'down' && <TrendingDown className="w-4 h-4" />}
          <span className="text-xs">
            {vo2Trend === 'up' ? 'Improving' : vo2Trend === 'down' ? 'Declining' : 'Stable'} (30d)
          </span>
        </div>
      </button>
      
      {/* Tile 4 - Recovery & Strain */}
      <button 
        className={`w-full backdrop-blur-xl rounded-3xl border p-6 transition-all text-left ${
          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-white/60 border-black/10 hover:bg-white/80'
        }`}
      >
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            <Battery className={`w-5 h-5 ${isDark ? 'text-green-400' : 'text-green-600'}`} />
            <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
              Recovery & Strain
            </h3>
          </div>
          <ChevronRight className={`w-5 h-5 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
        </div>
        
        <div className="flex items-baseline gap-2 mb-3">
          <span className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
            HRV:
          </span>
          <span className={`text-4xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
            {hrv}
          </span>
          <span className={`text-lg ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
            ms
          </span>
          <span className={`ml-2 px-3 py-1 rounded-full text-xs ${
            hrvStatus === 'recovered' 
              ? isDark ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700'
              : hrvStatus === 'strained'
                ? isDark ? 'bg-red-500/20 text-red-400' : 'bg-red-100 text-red-700'
                : isDark ? 'bg-yellow-500/20 text-yellow-400' : 'bg-yellow-100 text-yellow-700'
          }`}>
            {hrvStatus === 'recovered' ? 'Recovered' : hrvStatus === 'strained' ? 'Strained' : 'OK'}
          </span>
        </div>
        
        <div className={`mb-4 text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
          Resting HR: {rhrStatus}
        </div>
        
        {/* Traffic light style indicator */}
        <div className="flex items-center gap-2">
          <div className={`w-3 h-3 rounded-full ${
            hrvStatus === 'recovered' ? 'bg-green-500' :
            hrvStatus === 'strained' ? 'bg-red-500' : 'bg-yellow-500'
          }`}></div>
          <span className={`text-sm ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
            {hrvStatus === 'recovered' 
              ? 'Ready to push hard today' 
              : hrvStatus === 'strained'
                ? 'Consider taking it easier'
                : 'Normal recovery status'}
          </span>
        </div>
      </button>
      
      {/* Tile 5 - Movement Quality */}
      <button 
        className={`w-full backdrop-blur-xl rounded-3xl border p-6 transition-all text-left ${
          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-white/60 border-black/10 hover:bg-white/80'
        }`}
      >
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            <Waves className={`w-5 h-5 ${isDark ? 'text-blue-400' : 'text-blue-600'}`} />
            <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
              Movement Quality
            </h3>
          </div>
          <ChevronRight className={`w-5 h-5 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
        </div>
        
        <div className="flex items-center gap-4 mb-4">
          <div className="relative w-20 h-20">
            <svg className="w-20 h-20 -rotate-90" viewBox="0 0 100 100">
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke={isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}
                strokeWidth="8"
              />
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke={
                  movementQuality === 'stable' ? '#10b981' :
                  movementQuality === 'watch' ? '#f59e0b' : '#ef4444'
                }
                strokeWidth="8"
                strokeLinecap="round"
                strokeDasharray={`${movementScore * 2.64} 264`}
              />
            </svg>
            <div className="absolute inset-0 flex items-center justify-center">
              <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {movementScore}
              </div>
            </div>
          </div>
          
          <div className="flex-1">
            <div className={`mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Movement quality: 
              <span className={`ml-2 ${
                movementQuality === 'stable' ? isDark ? 'text-green-400' : 'text-green-600' :
                movementQuality === 'watch' ? isDark ? 'text-yellow-400' : 'text-yellow-600' :
                isDark ? 'text-red-400' : 'text-red-600'
              }`}>
                {movementQuality === 'stable' ? 'Stable' :
                 movementQuality === 'watch' ? 'Watch' : 'Needs attention'}
              </span>
            </div>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              {movementDelta > 0 ? '+' : ''}{movementDelta} vs last week
            </div>
          </div>
        </div>
        
        {/* Key metrics */}
        <div className="grid grid-cols-2 gap-3">
          <div className={`p-2 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Walking speed</div>
            <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>{walkingSpeed} km/h</div>
          </div>
          <div className={`p-2 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Step length</div>
            <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>{stepLength} cm</div>
          </div>
          <div className={`p-2 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Double support</div>
            <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>{doubleSupport}%</div>
          </div>
          <div className={`p-2 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Asymmetry</div>
            <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>{asymmetry}%</div>
          </div>
        </div>
      </button>
      
      {/* Tile 6 - Flō Sleep Index */}
      <button 
        onClick={() => setShowSleepDetails(true)}
        className={`w-full backdrop-blur-xl rounded-3xl border p-6 transition-all text-left ${
          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-white/60 border-black/10 hover:bg-white/80'
        }`}
      >
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            <Moon className={`w-5 h-5 ${isDark ? 'text-indigo-400' : 'text-indigo-600'}`} />
            <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
              Flō Sleep Index
            </h3>
          </div>
          <div className="flex items-center gap-2">
            <div className={`p-1.5 rounded-lg ${isDark ? 'bg-cyan-500/20' : 'bg-cyan-100'}`}>
              <Plus className={`w-4 h-4 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`} />
            </div>
            <ChevronRight className={`w-5 h-5 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
          </div>
        </div>
        
        <div className="flex items-center gap-4 mb-4">
          <div className="relative w-20 h-20">
            <svg className="w-20 h-20 -rotate-90" viewBox="0 0 100 100">
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke={isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}
                strokeWidth="8"
              />
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke={
                  sleepQuality === 'excellent' ? '#8b5cf6' :
                  sleepQuality === 'good' ? '#6366f1' :
                  sleepQuality === 'fair' ? '#f59e0b' : '#ef4444'
                }
                strokeWidth="8"
                strokeLinecap="round"
                strokeDasharray={`${(sleepScore / 100) * 264} 264`}
              />
            </svg>
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="text-center">
                <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {sleepScore}
                </div>
                <div className={`text-[10px] ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                  score
                </div>
              </div>
            </div>
          </div>
          
          <div className="flex-1">
            <div className={`text-3xl mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              {sleepDuration}h
            </div>
            <div className={`text-sm ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              last night
            </div>
            <div className={`inline-block mt-2 px-2 py-0.5 rounded-full text-xs ${
              sleepQuality === 'excellent' 
                ? isDark ? 'bg-purple-500/20 text-purple-400' : 'bg-purple-100 text-purple-700'
                : sleepQuality === 'good'
                ? isDark ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-100 text-indigo-700'
                : sleepQuality === 'fair'
                ? isDark ? 'bg-yellow-500/20 text-yellow-400' : 'bg-yellow-100 text-yellow-700'
                : isDark ? 'bg-red-500/20 text-red-400' : 'bg-red-100 text-red-700'
            }`}>
              {sleepQuality.charAt(0).toUpperCase() + sleepQuality.slice(1)}
            </div>
          </div>
        </div>
        
        <div className="grid grid-cols-2 gap-2">
          <div className={`text-center p-2 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>Deep Sleep</div>
            <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>{deepSleep}h</div>
          </div>
          <div className={`text-center p-2 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>REM Sleep</div>
            <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>{remSleep}h</div>
          </div>
        </div>
        
        <div className={`mt-3 text-xs text-center flex items-center justify-center gap-1 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`}>
          <Plus className="w-3 h-3" />
          <span>Tap to manually log sleep</span>
        </div>
      </button>

      {/* Activity Details Modal */}
      {showActivityDetails && (
        <ActivityDetailsModal 
          isDark={isDark} 
          onClose={() => setShowActivityDetails(false)} 
        />
      )}

      {/* Workout Details Modal */}
      {showWorkoutDetails && (
        <WorkoutDetailsModal 
          isDark={isDark} 
          onClose={() => setShowWorkoutDetails(false)} 
        />
      )}

      {/* Sleep Details Modal */}
      {showSleepDetails && (
        <SleepDetailsModal 
          isDark={isDark} 
          onClose={() => setShowSleepDetails(false)} 
        />
      )}
    </div>
  );
}

// Activity Details Modal Component
function ActivityDetailsModal({ isDark, onClose }: { isDark: boolean; onClose: () => void }) {
  // Mock 7-day activity data
  const weekData = [
    { day: 'Mon', date: 'Dec 2', steps: 8234, distance: 6.1, calories: 378, exercise: 42, standHours: 10 },
    { day: 'Tue', date: 'Dec 3', steps: 6891, distance: 5.2, calories: 315, exercise: 30, standHours: 8 },
    { day: 'Wed', date: 'Dec 4', steps: 10234, distance: 7.8, calories: 456, exercise: 55, standHours: 11 },
    { day: 'Thu', date: 'Dec 5', steps: 9123, distance: 6.9, calories: 401, exercise: 48, standHours: 9 },
    { day: 'Fri', date: 'Dec 6', steps: 11567, distance: 8.7, calories: 512, exercise: 62, standHours: 12 },
    { day: 'Sat', date: 'Dec 7', steps: 5234, distance: 4.1, calories: 278, exercise: 25, standHours: 7 },
    { day: 'Today', date: 'Dec 8', steps: 7420, distance: 5.8, calories: 342, exercise: 48, standHours: 9 },
  ];

  // Calculate weekly averages
  const avgSteps = Math.round(weekData.reduce((sum, day) => sum + day.steps, 0) / weekData.length);
  const avgDistance = (weekData.reduce((sum, day) => sum + day.distance, 0) / weekData.length).toFixed(1);
  const avgCalories = Math.round(weekData.reduce((sum, day) => sum + day.calories, 0) / weekData.length);
  const totalExercise = weekData.reduce((sum, day) => sum + day.exercise, 0);

  const maxSteps = Math.max(...weekData.map(d => d.steps));

  return (
    <div className="fixed inset-0 z-[100] flex items-end justify-center">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onClick={onClose}
      />
      
      {/* Modal */}
      <div className={`relative w-full max-w-lg rounded-t-3xl shadow-2xl max-h-[85vh] overflow-y-auto ${ 
        isDark ? 'bg-slate-900' : 'bg-white'
      }`}>
        {/* Header */}
        <div className={`sticky top-0 z-10 backdrop-blur-xl border-b ${
          isDark ? 'bg-slate-900/95 border-white/10' : 'bg-white/95 border-black/10'
        }`}>
          <div className="px-6 py-4">
            <div className="flex items-center justify-between">
              <div>
                <h2 className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  Activity Details
                </h2>
                <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                  Last 7 days
                </p>
              </div>
              <button
                onClick={onClose}
                className={`p-2 rounded-xl transition-colors ${
                  isDark ? 'hover:bg-white/10' : 'hover:bg-black/5'
                }`}
              >
                <span className={`text-2xl ${isDark ? 'text-white/70' : 'text-gray-600'}`}>×</span>
              </button>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="px-6 py-6 space-y-6">
          {/* Weekly Summary Cards */}
          <div className="grid grid-cols-2 gap-3">
            <div className={`p-4 rounded-2xl border ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
            }`}>
              <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                Avg Steps
              </div>
              <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {avgSteps.toLocaleString()}
              </div>
              <div className={`text-xs mt-1 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`}>
                per day
              </div>
            </div>

            <div className={`p-4 rounded-2xl border ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
            }`}>
              <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                Avg Distance
              </div>
              <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {avgDistance}
              </div>
              <div className={`text-xs mt-1 ${isDark ? 'text-green-400' : 'text-green-600'}`}>
                km/day
              </div>
            </div>

            <div className={`p-4 rounded-2xl border ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
            }`}>
              <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                Avg Calories
              </div>
              <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {avgCalories}
              </div>
              <div className={`text-xs mt-1 ${isDark ? 'text-orange-400' : 'text-orange-600'}`}>
                kcal/day
              </div>
            </div>

            <div className={`p-4 rounded-2xl border ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
            }`}>
              <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                Total Exercise
              </div>
              <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {totalExercise}
              </div>
              <div className={`text-xs mt-1 ${isDark ? 'text-purple-400' : 'text-purple-600'}`}>
                minutes
              </div>
            </div>
          </div>

          {/* 7-Day Activity Chart */}
          <div>
            <h3 className={`text-sm mb-3 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Daily Steps
            </h3>
            <div className="space-y-2">
              {weekData.map((day, index) => {
                const isToday = day.day === 'Today';
                const barPercent = (day.steps / maxSteps) * 100;
                
                return (
                  <div key={index} className="flex items-center gap-3">
                    <div className={`w-12 text-xs ${
                      isToday 
                        ? isDark ? 'text-cyan-400' : 'text-cyan-600'
                        : isDark ? 'text-white/50' : 'text-gray-500'
                    }`}>
                      {day.day}
                    </div>
                    <div className="flex-1">
                      <div className={`h-8 rounded-lg overflow-hidden ${
                        isDark ? 'bg-white/5' : 'bg-gray-100'
                      }`}>
                        <div 
                          className={`h-full flex items-center px-2 transition-all ${
                            isToday
                              ? 'bg-gradient-to-r from-cyan-500 to-blue-500'
                              : isDark 
                              ? 'bg-gradient-to-r from-cyan-500/50 to-blue-500/50'
                              : 'bg-gradient-to-r from-cyan-400/70 to-blue-400/70'
                          }`}
                          style={{ width: `${barPercent}%` }}
                        >
                          <span className={`text-xs ${
                            barPercent > 30 ? 'text-white' : ''
                          }`}>
                            {barPercent > 30 ? day.steps.toLocaleString() : ''}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div className={`w-16 text-xs text-right ${
                      isDark ? 'text-white/70' : 'text-gray-700'
                    }`}>
                      {barPercent <= 30 ? day.steps.toLocaleString() : ''}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Daily Breakdown Table */}
          <div>
            <h3 className={`text-sm mb-3 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Week Breakdown
            </h3>
            <div className={`rounded-2xl border overflow-hidden ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
            }`}>
              {/* Header */}
              <div className={`grid grid-cols-5 gap-2 p-3 border-b text-xs ${
                isDark ? 'bg-white/5 border-white/10 text-white/50' : 'bg-gray-100 border-gray-200 text-gray-500'
              }`}>
                <div>Day</div>
                <div className="text-right">Steps</div>
                <div className="text-right">Dist.</div>
                <div className="text-right">Cal.</div>
                <div className="text-right">Exer.</div>
              </div>
              
              {/* Rows */}
              {weekData.map((day, index) => {
                const isToday = day.day === 'Today';
                return (
                  <div 
                    key={index}
                    className={`grid grid-cols-5 gap-2 p-3 text-xs ${
                      index < weekData.length - 1 ? isDark ? 'border-b border-white/10' : 'border-b border-gray-200' : ''
                    } ${
                      isToday ? isDark ? 'bg-cyan-500/10' : 'bg-cyan-50' : ''
                    }`}
                  >
                    <div className={`${
                      isToday 
                        ? isDark ? 'text-cyan-400' : 'text-cyan-600'
                        : isDark ? 'text-white/70' : 'text-gray-700'
                    }`}>
                      {day.day}
                      <div className={`text-[10px] ${isDark ? 'text-white/40' : 'text-gray-400'}`}>
                        {day.date}
                      </div>
                    </div>
                    <div className={`text-right ${isDark ? 'text-white' : 'text-gray-900'}`}>
                      {day.steps.toLocaleString()}
                    </div>
                    <div className={`text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                      {day.distance}
                    </div>
                    <div className={`text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                      {day.calories}
                    </div>
                    <div className={`text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                      {day.exercise}m
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Key Insights */}
          <div className={`p-4 rounded-2xl border ${
            isDark ? 'bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border-cyan-500/20' : 'bg-gradient-to-br from-cyan-50 to-blue-50 border-cyan-200'
          }`}>
            <div className="flex items-start gap-3">
              <TrendingUp className={`w-5 h-5 mt-0.5 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`} />
              <div>
                <h4 className={`text-sm mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  Weekly Insights
                </h4>
                <p className={`text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                  You exceeded your step goal on 3 out of 7 days this week. Your most active day was Friday with 11,567 steps. Keep up the momentum!
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Workout Details Modal Component
function WorkoutDetailsModal({ isDark, onClose }: { isDark: boolean; onClose: () => void }) {
  // Mock 7-day workout data
  const weekData = [
    { 
      day: 'Mon', 
      date: 'Dec 2', 
      workouts: [
        { type: 'Run', duration: 35, distance: 5.2, calories: 312, avgHR: 145, intensity: 'Moderate' },
        { type: 'Strength', duration: 28, distance: 0, calories: 156, avgHR: 118, intensity: 'Light' }
      ]
    },
    { 
      day: 'Tue', 
      date: 'Dec 3', 
      workouts: [
        { type: 'Cycling', duration: 42, distance: 18.3, calories: 378, avgHR: 138, intensity: 'Moderate' }
      ]
    },
    { 
      day: 'Wed', 
      date: 'Dec 4', 
      workouts: [
        { type: 'HIIT', duration: 25, distance: 0, calories: 298, avgHR: 162, intensity: 'High' }
      ]
    },
    { 
      day: 'Thu', 
      date: 'Dec 5', 
      workouts: [
        { type: 'Yoga', duration: 45, distance: 0, calories: 142, avgHR: 95, intensity: 'Light' }
      ]
    },
    { 
      day: 'Fri', 
      date: 'Dec 6', 
      workouts: [
        { type: 'Run', duration: 48, distance: 7.8, calories: 456, avgHR: 152, intensity: 'Moderate' },
        { type: 'Strength', duration: 32, distance: 0, calories: 178, avgHR: 122, intensity: 'Moderate' }
      ]
    },
    { 
      day: 'Sat', 
      date: 'Dec 7', 
      workouts: [
        { type: 'Swimming', duration: 38, distance: 1.2, calories: 334, avgHR: 128, intensity: 'Moderate' }
      ]
    },
    { 
      day: 'Today', 
      date: 'Dec 8', 
      workouts: [
        { type: 'Run', duration: 42, distance: 6.5, calories: 385, avgHR: 148, intensity: 'Moderate' },
        { type: 'Pilates', duration: 21, distance: 0, calories: 112, avgHR: 102, intensity: 'Light' }
      ]
    },
  ];

  // Best week ever data (mock)
  const bestWeekData = {
    workouts: 15,
    duration: 425,
    calories: 3245,
    distance: 52.3,
    date: 'Week of Oct 15, 2024'
  };

  // Calculate weekly totals and averages
  const totalWorkouts = weekData.reduce((sum, day) => sum + day.workouts.length, 0);
  const totalDuration = weekData.reduce((sum, day) => 
    sum + day.workouts.reduce((s, w) => s + w.duration, 0), 0
  );
  const totalCalories = weekData.reduce((sum, day) => 
    sum + day.workouts.reduce((s, w) => s + w.calories, 0), 0
  );
  const totalDistance = weekData.reduce((sum, day) => 
    sum + day.workouts.reduce((s, w) => s + w.distance, 0), 0
  );
  const avgDuration = Math.round(totalDuration / totalWorkouts);
  const avgCaloriesPerWorkout = Math.round(totalCalories / totalWorkouts);

  // Workout type breakdown
  const workoutTypes: { [key: string]: number } = {};
  weekData.forEach(day => {
    day.workouts.forEach(workout => {
      workoutTypes[workout.type] = (workoutTypes[workout.type] || 0) + 1;
    });
  });

  // Calculate max for chart scaling
  const maxDailyDuration = Math.max(...weekData.map(d => 
    d.workouts.reduce((sum, w) => sum + w.duration, 0)
  ));

  // Workout type colors for stacked bars
  const workoutColors: { [key: string]: { bg: string; text: string } } = {
    'Run': { bg: 'bg-cyan-500', text: 'text-cyan-400' },
    'Strength': { bg: 'bg-purple-500', text: 'text-purple-400' },
    'HIIT': { bg: 'bg-red-500', text: 'text-red-400' },
    'Cycling': { bg: 'bg-blue-500', text: 'text-blue-400' },
    'Swimming': { bg: 'bg-teal-500', text: 'text-teal-400' },
    'Yoga': { bg: 'bg-green-500', text: 'text-green-400' },
    'Pilates': { bg: 'bg-pink-500', text: 'text-pink-400' }
  };

  return (
    <div className="fixed inset-0 z-[100] flex items-end justify-center">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onClick={onClose}
      />
      
      {/* Modal */}
      <div className={`relative w-full max-w-lg rounded-t-3xl shadow-2xl max-h-[85vh] overflow-y-auto ${ 
        isDark ? 'bg-slate-900' : 'bg-white'
      }`}>
        {/* Header */}
        <div className={`sticky top-0 z-10 backdrop-blur-xl border-b ${
          isDark ? 'bg-slate-900/95 border-white/10' : 'bg-white/95 border-black/10'
        }`}>
          <div className="px-6 py-4">
            <div className="flex items-center justify-between">
              <div>
                <h2 className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  Workout Details
                </h2>
                <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                  Last 7 days
                </p>
              </div>
              <button
                onClick={onClose}
                className={`p-2 rounded-xl transition-colors ${
                  isDark ? 'hover:bg-white/10' : 'hover:bg-black/5'
                }`}
              >
                <span className={`text-2xl ${isDark ? 'text-white/70' : 'text-gray-600'}`}>×</span>
              </button>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="px-6 py-6 space-y-6">
          {/* This Week vs Best Week Comparison */}
          <div className={`rounded-2xl border p-5 ${
            isDark 
              ? 'bg-gradient-to-br from-purple-500/10 to-pink-500/10 border-purple-500/30' 
              : 'bg-gradient-to-br from-purple-50 to-pink-50 border-purple-200'
          }`}>
            <div className="flex items-center justify-between mb-4">
              <div>
                <h3 className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  This Week vs Best Week
                </h3>
                <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                  Push yourself to beat your record!
                </p>
              </div>
              <Trophy className={`w-5 h-5 ${isDark ? 'text-yellow-400' : 'text-yellow-600'}`} />
            </div>
            
            <div className="grid grid-cols-2 gap-4">
              {/* This Week */}
              <div>
                <div className={`text-xs mb-2 ${isDark ? 'text-purple-400' : 'text-purple-600'}`}>
                  This Week
                </div>
                <div className="space-y-2">
                  <div className={`flex justify-between text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                    <span>Workouts:</span>
                    <span className={isDark ? 'text-white' : 'text-gray-900'}>{totalWorkouts}</span>
                  </div>
                  <div className={`flex justify-between text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                    <span>Duration:</span>
                    <span className={isDark ? 'text-white' : 'text-gray-900'}>{totalDuration}m</span>
                  </div>
                  <div className={`flex justify-between text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                    <span>Calories:</span>
                    <span className={isDark ? 'text-white' : 'text-gray-900'}>{totalCalories}</span>
                  </div>
                </div>
              </div>

              {/* Best Week */}
              <div>
                <div className={`text-xs mb-2 ${isDark ? 'text-yellow-400' : 'text-yellow-600'}`}>
                  Best Week 🏆
                </div>
                <div className="space-y-2">
                  <div className={`flex justify-between text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                    <span>Workouts:</span>
                    <span className={`${
                      totalWorkouts >= bestWeekData.workouts 
                        ? isDark ? 'text-green-400' : 'text-green-600'
                        : isDark ? 'text-white' : 'text-gray-900'
                    }`}>{bestWeekData.workouts}</span>
                  </div>
                  <div className={`flex justify-between text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                    <span>Duration:</span>
                    <span className={`${
                      totalDuration >= bestWeekData.duration 
                        ? isDark ? 'text-green-400' : 'text-green-600'
                        : isDark ? 'text-white' : 'text-gray-900'
                    }`}>{bestWeekData.duration}m</span>
                  </div>
                  <div className={`flex justify-between text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                    <span>Calories:</span>
                    <span className={`${
                      totalCalories >= bestWeekData.calories 
                        ? isDark ? 'text-green-400' : 'text-green-600'
                        : isDark ? 'text-white' : 'text-gray-900'
                    }`}>{bestWeekData.calories}</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Progress Message */}
            {totalWorkouts >= bestWeekData.workouts || totalDuration >= bestWeekData.duration ? (
              <div className={`mt-4 p-3 rounded-xl ${
                isDark ? 'bg-green-500/20 border border-green-500/30' : 'bg-green-50 border border-green-200'
              }`}>
                <p className={`text-xs ${isDark ? 'text-green-400' : 'text-green-700'}`}>
                  🎉 You&apos;re crushing it! New personal record!
                </p>
              </div>
            ) : (
              <div className={`mt-4 p-3 rounded-xl ${
                isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-gray-200'
              }`}>
                <p className={`text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                  Keep going! You need <span className={isDark ? 'text-purple-400' : 'text-purple-600'}>{bestWeekData.workouts - totalWorkouts} more workouts</span> to beat your best week
                </p>
              </div>
            )}
          </div>

          {/* Weekly Summary Cards */}
          <div className="grid grid-cols-2 gap-3">
            <div className={`p-4 rounded-2xl border ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
            }`}>
              <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                Total Workouts
              </div>
              <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {totalWorkouts}
              </div>
              <div className={`text-xs mt-1 ${isDark ? 'text-purple-400' : 'text-purple-600'}`}>
                this week
              </div>
            </div>

            <div className={`p-4 rounded-2xl border ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
            }`}>
              <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                Total Time
              </div>
              <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {totalDuration}
              </div>
              <div className={`text-xs mt-1 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`}>
                minutes
              </div>
            </div>

            <div className={`p-4 rounded-2xl border ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
            }`}>
              <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                Avg Duration
              </div>
              <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {avgDuration}
              </div>
              <div className={`text-xs mt-1 ${isDark ? 'text-blue-400' : 'text-blue-600'}`}>
                min/workout
              </div>
            </div>

            <div className={`p-4 rounded-2xl border ${
              isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
            }`}>
              <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                Total Calories
              </div>
              <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {totalCalories}
              </div>
              <div className={`text-xs mt-1 ${isDark ? 'text-orange-400' : 'text-orange-600'}`}>
                kcal
              </div>
            </div>
          </div>

          {/* Workout Type Breakdown */}
          <div>
            <h3 className={`text-sm mb-3 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Workout Types
            </h3>
            <div className="grid grid-cols-2 gap-2">
              {Object.entries(workoutTypes).map(([type, count]) => (
                <div 
                  key={type}
                  className={`p-3 rounded-xl border ${
                    isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
                  }`}
                >
                  <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                    {type}
                  </div>
                  <div className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
                    {count}× <span className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>sessions</span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Daily Duration Chart - Stacked by Workout Type */}
          <div>
            <h3 className={`text-sm mb-3 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Daily Workout Duration (Stacked)
            </h3>
            <div className="space-y-2">
              {weekData.map((day, index) => {
                const isToday = day.day === 'Today';
                const dayDuration = day.workouts.reduce((sum, w) => sum + w.duration, 0);
                const barPercent = dayDuration > 0 ? (dayDuration / maxDailyDuration) * 100 : 0;
                
                return (
                  <div key={index} className="flex items-center gap-3">
                    <div className={`w-12 text-xs ${
                      isToday 
                        ? isDark ? 'text-purple-400' : 'text-purple-600'
                        : isDark ? 'text-white/50' : 'text-gray-500'
                    }`}>
                      {day.day}
                    </div>
                    <div className="flex-1">
                      <div className={`h-8 rounded-lg overflow-hidden ${
                        isDark ? 'bg-white/5' : 'bg-gray-100'
                      }`}>
                        {dayDuration > 0 && (
                          <div 
                            className="h-full flex"
                            style={{ width: `${barPercent}%` }}
                          >
                            {/* Stacked workout segments */}
                            {day.workouts.map((workout, wIndex) => {
                              const segmentPercent = (workout.duration / dayDuration) * 100;
                              const color = workoutColors[workout.type] || { bg: 'bg-gray-500' };
                              return (
                                <div
                                  key={wIndex}
                                  className={`h-full flex items-center justify-center ${color.bg} ${
                                    isToday ? '' : 'opacity-70'
                                  }`}
                                  style={{ width: `${segmentPercent}%` }}
                                  title={`${workout.type}: ${workout.duration}min`}
                                >
                                  {segmentPercent > 20 && (
                                    <span className="text-[10px] text-white px-1">
                                      {workout.type}
                                    </span>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    </div>
                    <div className={`w-16 text-xs text-right ${
                      isDark ? 'text-white/70' : 'text-gray-700'
                    }`}>
                      {dayDuration} min
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Legend */}
            <div className="mt-3 flex flex-wrap gap-2">
              {Object.entries(workoutTypes).map(([type, _]) => {
                const color = workoutColors[type] || { bg: 'bg-gray-500', text: 'text-gray-400' };
                return (
                  <div key={type} className="flex items-center gap-1.5">
                    <div className={`w-3 h-3 rounded ${color.bg}`} />
                    <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                      {type}
                    </span>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Daily Workout Breakdown */}
          <div>
            <h3 className={`text-sm mb-3 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Workout Log
            </h3>
            <div className="space-y-2">
              {weekData.map((day, dayIndex) => {
                const isToday = day.day === 'Today';
                return (
                  <div 
                    key={dayIndex}
                    className={`rounded-2xl border overflow-hidden ${
                      isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
                    } ${
                      isToday ? isDark ? 'ring-1 ring-purple-500/50' : 'ring-1 ring-purple-400/50' : ''
                    }`}
                  >
                    {/* Day Header */}
                    <div className={`px-4 py-2 border-b ${
                      isDark ? 'bg-white/5 border-white/10' : 'bg-gray-100 border-gray-200'
                    }`}>
                      <div className="flex items-center justify-between">
                        <div>
                          <span className={`text-sm ${
                            isToday 
                              ? isDark ? 'text-purple-400' : 'text-purple-600'
                              : isDark ? 'text-white/70' : 'text-gray-700'
                          }`}>
                            {day.day}
                          </span>
                          <span className={`ml-2 text-xs ${isDark ? 'text-white/40' : 'text-gray-400'}`}>
                            {day.date}
                          </span>
                        </div>
                        <span className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                          {day.workouts.length} workout{day.workouts.length > 1 ? 's' : ''}
                        </span>
                      </div>
                    </div>
                    
                    {/* Workouts */}
                    <div className="divide-y divide-white/10">
                      {day.workouts.map((workout, workoutIndex) => (
                        <div key={workoutIndex} className="px-4 py-3">
                          <div className="flex items-start justify-between mb-2">
                            <div className="flex items-center gap-2">
                              <Dumbbell className={`w-4 h-4 ${
                                workout.intensity === 'High' 
                                  ? isDark ? 'text-red-400' : 'text-red-600'
                                  : workout.intensity === 'Moderate'
                                  ? isDark ? 'text-orange-400' : 'text-orange-600'
                                  : isDark ? 'text-green-400' : 'text-green-600'
                              }`} />
                              <span className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
                                {workout.type}
                              </span>
                            </div>
                            <span className={`px-2 py-0.5 rounded-full text-[10px] ${
                              workout.intensity === 'High'
                                ? isDark ? 'bg-red-500/20 text-red-400' : 'bg-red-100 text-red-700'
                                : workout.intensity === 'Moderate'
                                ? isDark ? 'bg-orange-500/20 text-orange-400' : 'bg-orange-100 text-orange-700'
                                : isDark ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700'
                            }`}>
                              {workout.intensity}
                            </span>
                          </div>
                          <div className="grid grid-cols-4 gap-2 text-xs">
                            <div>
                              <div className={`${isDark ? 'text-white/50' : 'text-gray-500'}`}>Duration</div>
                              <div className={`${isDark ? 'text-white/90' : 'text-gray-900'}`}>{workout.duration}m</div>
                            </div>
                            {workout.distance > 0 && (
                              <div>
                                <div className={`${isDark ? 'text-white/50' : 'text-gray-500'}`}>Distance</div>
                                <div className={`${isDark ? 'text-white/90' : 'text-gray-900'}`}>{workout.distance}km</div>
                              </div>
                            )}
                            <div>
                              <div className={`${isDark ? 'text-white/50' : 'text-gray-500'}`}>Calories</div>
                              <div className={`${isDark ? 'text-white/90' : 'text-gray-900'}`}>{workout.calories}</div>
                            </div>
                            <div>
                              <div className={`${isDark ? 'text-white/50' : 'text-gray-500'}`}>Avg HR</div>
                              <div className={`${isDark ? 'text-white/90' : 'text-gray-900'}`}>{workout.avgHR}</div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Key Insights */}
          <div className={`p-4 rounded-2xl border ${
            isDark ? 'bg-gradient-to-br from-purple-500/10 to-pink-500/10 border-purple-500/20' : 'bg-gradient-to-br from-purple-50 to-pink-50 border-purple-200'
          }`}>
            <div className="flex items-start gap-3">
              <TrendingUp className={`w-5 h-5 mt-0.5 ${isDark ? 'text-purple-400' : 'text-purple-600'}`} />
              <div>
                <h4 className={`text-sm mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  Weekly Insights
                </h4>
                <p className={`text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                  Great week! You completed {totalWorkouts} workouts totaling {totalDuration} minutes. Your most common activity was {Object.entries(workoutTypes).sort((a, b) => b[1] - a[1])[0][0]}. Keep maintaining this consistency!
                </p>
              </div>
            </div>
          </div>

          {/* Additional Stats */}
          <div className={`p-4 rounded-2xl border ${
            isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
          }`}>
            <h4 className={`text-sm mb-3 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Performance Metrics
            </h4>
            <div className="space-y-2 text-xs">
              <div className="flex items-center justify-between">
                <span className={`${isDark ? 'text-white/70' : 'text-gray-700'}`}>Avg Calories/Workout</span>
                <span className={`${isDark ? 'text-white' : 'text-gray-900'}`}>{avgCaloriesPerWorkout} kcal</span>
              </div>
              <div className="flex items-center justify-between">
                <span className={`${isDark ? 'text-white/70' : 'text-gray-700'}`}>Total Distance</span>
                <span className={`${isDark ? 'text-white' : 'text-gray-900'}`}>{totalDistance.toFixed(1)} km</span>
              </div>
              <div className="flex items-center justify-between">
                <span className={`${isDark ? 'text-white/70' : 'text-gray-700'}`}>Workout Frequency</span>
                <span className={`${isDark ? 'text-white' : 'text-gray-900'}`}>{(totalWorkouts / 7).toFixed(1)}× per day</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Nutrition Tab Content
function NutritionTabContent({ isDark, loggedMeals = [] }: { isDark: boolean; loggedMeals?: LoggedMeal[] }) {
  const [showMacrosDetails, setShowMacrosDetails] = useState(false);
  const [showDailyMealBreakdown, setShowDailyMealBreakdown] = useState(false);
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  
  // Get today's meals
  const getTodaysMeals = () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    return loggedMeals.filter(meal => {
      const mealDate = new Date(meal.dateTime);
      return mealDate >= today && mealDate < tomorrow;
    });
  };
  
  const todaysMeals = getTodaysMeals();
  
  // Calculate today's totals from logged meals
  const calculateTodaysTotals = () => {
    let calories = 0;
    let protein = 0;
    let carbs = 0;
    let fats = 0;
    
    todaysMeals.forEach(meal => {
      meal.items.forEach(item => {
        calories += item.calories || 0;
        protein += item.protein || 0;
        carbs += item.carbs || 0;
        fats += item.fats || 0;
      });
    });
    
    return { calories, protein, carbs, fats };
  };
  
  const todaysTotals = calculateTodaysTotals();
  
  // User profile for personalization
  const userProfile = {
    sex: 'male' as 'male' | 'female',
    age: 42,
    weight: 78, // kg
    activityLevel: 'active' as 'sedentary' | 'lightly_active' | 'active' | 'very_active',
    goal: 'maintain' as 'lose' | 'maintain' | 'gain'
  };
  
  // Calculate personalized targets
  const calculateTargets = () => {
    // Protein target: 1.2 g/kg for active adult
    const proteinTarget = userProfile.weight * 1.2; // 93.6g
    
    // BMR (Mifflin-St Jeor for males): 10*weight + 6.25*height - 5*age + 5
    // Simplified: using typical height assumptions
    const bmr = 10 * userProfile.weight + 6.25 * 175 - 5 * userProfile.age + 5; // ~1695
    
    // Activity multiplier
    const activityMultipliers = {
      sedentary: 1.2,
      lightly_active: 1.375,
      active: 1.55,
      very_active: 1.725
    };
    
    const tdee = bmr * activityMultipliers[userProfile.activityLevel]; // ~2627
    
    // Goal adjustment
    const goalAdjustments = {
      lose: 0.85,
      maintain: 1.0,
      gain: 1.15
    };
    
    const calorieTarget = tdee * goalAdjustments[userProfile.goal]; // 2627
    
    return {
      protein: Math.round(proteinTarget),
      calories: Math.round(calorieTarget),
      carbs: Math.round((calorieTarget * 0.45) / 4), // 45% of cals
      fats: Math.round((calorieTarget * 0.30) / 9), // 30% of cals
      water: userProfile.weight * 35 // ml/kg
    };
  };
  
  const targets = calculateTargets();
  
  // Today's intake - use real data from logged meals, fallback to mock
  const intake = {
    protein: todaysTotals.protein > 0 ? Math.round(todaysTotals.protein) : 88,
    calories: todaysTotals.calories > 0 ? Math.round(todaysTotals.calories) : 2420,
    carbs: todaysTotals.carbs > 0 ? Math.round(todaysTotals.carbs) : 285,
    fats: todaysTotals.fats > 0 ? Math.round(todaysTotals.fats) : 78,
    fiber: todaysTotals.carbs > 0 ? Math.round(todaysTotals.carbs * 0.1) : 28, // Estimate fiber as ~10% of carbs
    water: 2400, // ml - mock (not tracked in food logging yet)
    caffeine: 280, // mg - mock (not tracked in food logging yet)
    sodium: todaysTotals.calories > 0 ? Math.round(todaysTotals.calories * 0.8) : 2100, // Rough estimate
    sugar: todaysTotals.carbs > 0 ? Math.round(todaysTotals.carbs * 0.15) : 45 // Estimate sugar as ~15% of carbs
  };
  
  // Scoring functions
  const scoreNutrient = (actual: number, target: number, type: 'protein' | 'calories' | 'general') => {
    const percent = (actual / target) * 100;
    
    if (type === 'protein') {
      if (percent >= 90 && percent <= 130) return 'green';
      if ((percent >= 70 && percent < 90) || (percent > 130 && percent <= 150)) return 'amber';
      return 'red';
    } else if (type === 'calories') {
      if (percent >= 90 && percent <= 110) return 'green';
      if ((percent >= 80 && percent < 90) || (percent > 110 && percent <= 120)) return 'amber';
      return 'red';
    } else {
      if (percent >= 90 && percent <= 110) return 'green';
      if (percent >= 70 && percent < 90) return 'amber';
      return 'red';
    }
  };
  
  // Calculate scores
  const proteinScore = scoreNutrient(intake.protein, targets.protein, 'protein');
  const calorieScore = scoreNutrient(intake.calories, targets.calories, 'calories');
  
  // Micronutrient coverage (mock - would be calculated from RDAs)
  const microsCovered = 16;
  const microsTotal = 20;
  const lowMicros = ['Vitamin D', 'Folate', 'Omega-3', 'Magnesium'];
  
  // Overall nutrition score (0-100)
  const calculateNutritionScore = () => {
    let score = 0;
    // Protein (25 points)
    if (proteinScore === 'green') score += 25;
    else if (proteinScore === 'amber') score += 18;
    else score += 10;
    
    // Calories (25 points)
    if (calorieScore === 'green') score += 25;
    else if (calorieScore === 'amber') score += 18;
    else score += 10;
    
    // Micronutrient coverage (30 points)
    score += (microsCovered / microsTotal) * 30;
    
    // Fiber (10 points) - target ~30g
    if (intake.fiber >= 25) score += 10;
    else if (intake.fiber >= 18) score += 7;
    else score += 3;
    
    // Hydration (10 points)
    const waterPercent = (intake.water / targets.water) * 100;
    if (waterPercent >= 90) score += 10;
    else if (waterPercent >= 70) score += 6;
    else score += 2;
    
    return Math.round(score);
  };
  
  const nutritionScore = calculateNutritionScore();
  
  return (
    <div className="space-y-4">
      {/* Tile 1 - Nutrition Score */}
      <div className={`backdrop-blur-xl rounded-3xl border p-6 ${
        isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
      }`}>
        <div className="flex items-center gap-2 mb-4">
          <Apple className={`w-5 h-5 ${isDark ? 'text-green-400' : 'text-green-600'}`} />
          <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
            Today's Nutrition
          </h3>
        </div>
        
        <div className="flex items-center gap-6 mb-4">
          <div className="relative w-28 h-28">
            <svg className="w-28 h-28 -rotate-90" viewBox="0 0 100 100">
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke={isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}
                strokeWidth="8"
              />
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke="url(#nutrition-gradient)"
                strokeWidth="8"
                strokeLinecap="round"
                strokeDasharray={`${nutritionScore * 2.64} 264`}
              />
              <defs>
                <linearGradient id="nutrition-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stopColor="#10b981" />
                  <stop offset="100%" stopColor="#059669" />
                </linearGradient>
              </defs>
            </svg>
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="text-center">
                <div className={`text-3xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {nutritionScore}
                </div>
                <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                  score
                </div>
              </div>
            </div>
          </div>
          
          <div className="flex-1">
            <div className={`text-sm mb-2 ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
              {nutritionScore >= 85 ? 'Excellent nutrition today!' :
               nutritionScore >= 70 ? 'Good nutrition balance' :
               nutritionScore >= 55 ? 'Room for improvement' :
               'Focus on hitting your targets'}
            </div>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Personalised for {userProfile.age}yr {userProfile.sex}, {userProfile.weight}kg
            </div>
          </div>
        </div>
      </div>
      
      {/* Today's Meals Card - Component */}
      <TodaysMealsCard
        isDark={isDark}
        todaysMeals={todaysMeals}
        todaysTotals={todaysTotals}
        onMealClick={(date) => {
          setSelectedDate(date);
          setShowDailyMealBreakdown(true);
        }}
      />
      
      {/* OLD CODE BELOW - IGNORE */}
      {false && (
        <div>{/* Today's Meals Card OLD CODE */}</div>
      )}
      {/* OLD CODE ABOVE - IGNORE */}
      {/* MEALS CARD REPLACEMENT */}
      <div className={`backdrop-blur-xl rounded-3xl border p-6 ${\n        isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'\n      }`}>\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center gap-2\">\n            <Apple className={`w-5 h-5 ${isDark ? 'text-purple-400' : 'text-purple-600'}`} />\n            <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>\n              Today's Meals\n            </h3>\n          </div>\n          <div className={`text-sm ${isDark ? 'text-white/60' : 'text-gray-600'}`}>\n            {todaysMeals.length} {todaysMeals.length === 1 ? 'meal' : 'meals'}\n          </div>\n        </div>\n        \n        {todaysMeals.length === 0 ? (\n          <div className={`text-center py-8 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>\n            <p className=\"text-sm\">No meals logged today</p>\n            <p className=\"text-xs mt-1\">Tap the Flō button to log your first meal</p>\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {todaysMeals.map((meal) => {\n              const mealTotals = meal.items.reduce((acc, item) => ({\n                calories: acc.calories + (item.calories || 0),\n                protein: acc.protein + (item.protein || 0),\n                carbs: acc.carbs + (item.carbs || 0),\n                fats: acc.fats + (item.fats || 0)\n              }), { calories: 0, protein: 0, carbs: 0, fats: 0 });\n              \n              return (\n                <button\n                  key={meal.id}\n                  onClick={() => {\n                    setSelectedDate(new Date(meal.dateTime));\n                    setShowDailyMealBreakdown(true);\n                  }}\n                  className={`w-full p-4 rounded-xl transition-all text-left ${\n                    isDark ? 'bg-white/5 hover:bg-white/10' : 'bg-black/5 hover:bg-black/10'\n                  }`}\n                >\n                  <div className=\"flex items-start justify-between mb-2\">\n                    <div>\n                      <div className={`text-sm mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                        {meal.meal}\n                      </div>\n                      <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>\n                        {new Date(meal.dateTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}\n                      </div>\n                    </div>\n                    <div className={`text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>\n                      {Math.round(mealTotals.calories)} cal\n                    </div>\n                  </div>\n                  <div className=\"space-y-1\">\n                    {meal.items.map((item) => (\n                      <div key={item.id} className={`text-xs flex items-center justify-between ${\n                        isDark ? 'text-white/60' : 'text-gray-600'\n                      }`}>\n                        <span>{item.name} ({item.portion})</span>\n                        <span>{item.calories} cal</span>\n                      </div>\n                    ))}\n                  </div>\n                  <div className={`mt-2 pt-2 border-t flex gap-4 text-xs ${\n                    isDark ? 'border-white/10 text-white/50' : 'border-black/10 text-gray-500'\n                  }`}>\n                    <span>P: {Math.round(mealTotals.protein)}g</span>\n                    <span>C: {Math.round(mealTotals.carbs)}g</span>\n                    <span>F: {Math.round(mealTotals.fats)}g</span>\n                  </div>\n                </button>\n              );\n            })}\n            \n            {/* Daily Summary */}\n            <div className={`mt-4 pt-4 border-t flex items-center justify-between ${\n              isDark ? 'border-white/10' : 'border-black/10'\n            }`}>\n              <div className={`text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>\n                Today's Total\n              </div>\n              <div className=\"flex gap-4 text-sm\">\n                <div className={isDark ? 'text-white' : 'text-gray-900'}>\n                  {Math.round(todaysTotals.calories)} cal\n                </div>\n                <div className={`${isDark ? 'text-white/60' : 'text-gray-600'}`}>\n                  P: {Math.round(todaysTotals.protein)}g\n                </div>\n                <div className={`${isDark ? 'text-white/60' : 'text-gray-600'}`}>\n                  C: {Math.round(todaysTotals.carbs)}g\n                </div>\n                <div className={`${isDark ? 'text-white/60' : 'text-gray-600'}`}>\n                  F: {Math.round(todaysTotals.fats)}g\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>
      
      {/* Tile 2 - Macros */}
      <button 
        onClick={() => setShowMacrosDetails(true)}
        className={`w-full backdrop-blur-xl rounded-3xl border p-6 transition-all text-left ${
          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-white/60 border-black/10 hover:bg-white/80'
        }`}
      >
        <div className="flex items-center justify-between mb-4">
          <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
            Macros
          </h3>
          <ChevronRight className={`w-5 h-5 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
        </div>
        
        {/* Protein */}
        <div className="mb-4">
          <div className="flex items-center justify-between mb-2">
            <span className={`text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
              Protein
            </span>
            <div className="flex items-baseline gap-1">
              <span className={`${
                proteinScore === 'green' ? isDark ? 'text-green-400' : 'text-green-600' :
                proteinScore === 'amber' ? isDark ? 'text-yellow-400' : 'text-yellow-600' :
                isDark ? 'text-red-400' : 'text-red-600'
              }`}>
                {intake.protein}g
              </span>
              <span className={`text-xs ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
                / {targets.protein}g
              </span>
            </div>
          </div>
          <div className={`h-2 rounded-full overflow-hidden ${
            isDark ? 'bg-white/10' : 'bg-gray-200'
          }`}>
            <div 
              className={`h-full ${
                proteinScore === 'green' ? 'bg-gradient-to-r from-green-400 to-green-500' :
                proteinScore === 'amber' ? 'bg-gradient-to-r from-yellow-400 to-yellow-500' :
                'bg-gradient-to-r from-red-400 to-red-500'
              }`}
              style={{ width: `${Math.min((intake.protein / targets.protein) * 100, 100)}%` }}
            />
          </div>
          <div className={`text-xs mt-1 ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
            {Math.round((intake.protein / targets.protein) * 100)}% of target (1.2g/kg)
          </div>
        </div>
        
        {/* Calories */}
        <div className="mb-4">
          <div className="flex items-center justify-between mb-2">
            <span className={`text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
              Calories
            </span>
            <div className="flex items-baseline gap-1">
              <span className={`${
                calorieScore === 'green' ? isDark ? 'text-green-400' : 'text-green-600' :
                calorieScore === 'amber' ? isDark ? 'text-yellow-400' : 'text-yellow-600' :
                isDark ? 'text-red-400' : 'text-red-600'
              }`}>
                {intake.calories}
              </span>
              <span className={`text-xs ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
                / {targets.calories}
              </span>
            </div>
          </div>
          <div className={`h-2 rounded-full overflow-hidden ${
            isDark ? 'bg-white/10' : 'bg-gray-200'
          }`}>
            <div 
              className={`h-full ${
                calorieScore === 'green' ? 'bg-gradient-to-r from-cyan-400 to-cyan-500' :
                calorieScore === 'amber' ? 'bg-gradient-to-r from-yellow-400 to-yellow-500' :
                'bg-gradient-to-r from-red-400 to-red-500'
              }`}
              style={{ width: `${Math.min((intake.calories / targets.calories) * 100, 100)}%` }}
            />
          </div>
          <div className={`text-xs mt-1 ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
            {Math.round((intake.calories / targets.calories) * 100)}% of TDEE
          </div>
        </div>
        
        {/* Carbs & Fats Grid */}
        <div className="grid grid-cols-2 gap-3">
          <div className={`p-3 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Carbs
            </div>
            <div className="flex items-baseline gap-1">
              <span className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {intake.carbs}g
              </span>
              <span className={`text-xs ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
                / {targets.carbs}g
              </span>
            </div>
          </div>
          <div className={`p-3 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Fats
            </div>
            <div className="flex items-baseline gap-1">
              <span className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {intake.fats}g
              </span>
              <span className={`text-xs ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
                / {targets.fats}g
              </span>
            </div>
          </div>
        </div>
      </button>
      
      {/* Tile 3 - Micronutrient Coverage */}
      <button 
        className={`w-full backdrop-blur-xl rounded-3xl border p-6 transition-all text-left ${
          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-white/60 border-black/10 hover:bg-white/80'
        }`}
      >
        <div className="flex items-center justify-between mb-4">
          <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
            Micronutrient Coverage
          </h3>
          <ChevronRight className={`w-5 h-5 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
        </div>
        
        <div className="flex items-center gap-4 mb-4">
          <div className="relative w-20 h-20">
            <svg className="w-20 h-20 -rotate-90" viewBox="0 0 100 100">
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke={isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}
                strokeWidth="8"
              />
              <circle
                cx="50"
                cy="50"
                r="42"
                fill="none"
                stroke={
                  (microsCovered / microsTotal) >= 0.8 ? '#10b981' :
                  (microsCovered / microsTotal) >= 0.6 ? '#f59e0b' : '#ef4444'
                }
                strokeWidth="8"
                strokeLinecap="round"
                strokeDasharray={`${(microsCovered / microsTotal) * 264} 264`}
              />
            </svg>
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="text-center">
                <div className={`text-xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {microsCovered}/{microsTotal}
                </div>
              </div>
            </div>
          </div>
          
          <div className="flex-1">
            <div className={`text-sm mb-1 ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
              {Math.round((microsCovered / microsTotal) * 100)}% of targets hit
            </div>
            <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Age + sex adjusted RDAs
            </div>
          </div>
        </div>
        
        {lowMicros.length > 0 && (
          <div className={`p-3 rounded-xl ${isDark ? 'bg-orange-500/10' : 'bg-orange-50'}`}>
            <div className={`text-xs mb-1 ${isDark ? 'text-orange-400' : 'text-orange-700'}`}>
              Low or borderline:
            </div>
            <div className={`text-sm ${isDark ? 'text-orange-300' : 'text-orange-800'}`}>
              {lowMicros.join(', ')}
            </div>
          </div>
        )}
      </button>
      
      {/* Tile 4 - Hydration */}
      <div className={`backdrop-blur-xl rounded-3xl border p-6 ${
        isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
      }`}>
        <div className="flex items-center gap-2 mb-4">
          <Droplet className={`w-5 h-5 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`} />
          <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
            Hydration
          </h3>
        </div>
        
        <div className="flex items-baseline gap-2 mb-3">
          <span className={`text-4xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
            {(intake.water / 1000).toFixed(1)}
          </span>
          <span className={`text-lg ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
            L
          </span>
          <span className={`text-sm ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
            / {(targets.water / 1000).toFixed(1)}L
          </span>
        </div>
        
        <div className={`h-2 rounded-full overflow-hidden mb-2 ${
          isDark ? 'bg-white/10' : 'bg-gray-200'
        }`}>
          <div 
            className="h-full bg-gradient-to-r from-cyan-400 to-blue-500"
            style={{ width: `${Math.min((intake.water / targets.water) * 100, 100)}%` }}
          />
        </div>
        
        <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
          Target: {Math.round(targets.water / userProfile.weight)} ml/kg body weight
        </div>
      </div>
      
      {/* Tile 5 - Metabolic Load */}
      <button 
        className={`w-full backdrop-blur-xl rounded-3xl border p-6 transition-all text-left ${
          isDark ? 'bg-white/5 border-white/10 hover:bg-white/10' : 'bg-white/60 border-black/10 hover:bg-white/80'
        }`}
      >
        <div className="flex items-center justify-between mb-4">
          <h3 className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
            Metabolic Load
          </h3>
          <ChevronRight className={`w-5 h-5 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
        </div>
        
        <div className="grid grid-cols-3 gap-3">
          {/* Caffeine */}
          <div className={`p-3 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Caffeine
            </div>
            <div className={`text-lg mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              {intake.caffeine}
            </div>
            <div className={`text-xs ${
              intake.caffeine < 400 
                ? isDark ? 'text-green-400' : 'text-green-600'
                : isDark ? 'text-orange-400' : 'text-orange-600'
            }`}>
              {intake.caffeine < 300 ? 'Moderate' : intake.caffeine < 400 ? 'High' : 'Very high'}
            </div>
          </div>
          
          {/* Sodium */}
          <div className={`p-3 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Sodium
            </div>
            <div className={`text-lg mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              {intake.sodium}
            </div>
            <div className={`text-xs ${
              intake.sodium <= 2300 
                ? isDark ? 'text-green-400' : 'text-green-600'
                : isDark ? 'text-orange-400' : 'text-orange-600'
            }`}>
              {intake.sodium <= 2300 ? 'Within limit' : 'Above limit'}
            </div>
          </div>
          
          {/* Sugar */}
          <div className={`p-3 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Sugar
            </div>
            <div className={`text-lg mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              {intake.sugar}g
            </div>
            <div className={`text-xs ${
              intake.sugar <= 50 
                ? isDark ? 'text-green-400' : 'text-green-600'
                : isDark ? 'text-orange-400' : 'text-orange-600'
            }`}>
              {intake.sugar <= 50 ? 'Moderate' : 'High'}
            </div>
          </div>
        </div>
        
        <div className={`mt-3 text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
          Guidelines: Caffeine &lt;400mg, Sodium &lt;2,300mg, Added sugar &lt;50g
        </div>
      </button>

      {/* Macros Details Modal */}
      {showMacrosDetails && (
        <MacrosDetailsModal 
          isDark={isDark} 
          onClose={() => setShowMacrosDetails(false)}
          intake={intake}
          targets={targets}
          loggedMeals={loggedMeals}
        />
      )}
      
      {/* Daily Meal Breakdown Modal */}
      {showDailyMealBreakdown && selectedDate && (
        <DailyMealBreakdownModal
          isDark={isDark}
          onClose={() => {
            setShowDailyMealBreakdown(false);
            setSelectedDate(null);
          }}
          date={selectedDate}
          loggedMeals={loggedMeals}
        />
      )}
    </div>
  );
}

// Macros Details Modal Component
function MacrosDetailsModal({ 
  isDark, 
  onClose, 
  intake, 
  targets,
  loggedMeals = []
}: { 
  isDark: boolean; 
  onClose: () => void;
  intake: any;
  targets: any;
  loggedMeals?: LoggedMeal[];
}) {
  const [timeView, setTimeView] = useState<'day' | 'week'>('day');
  const [showDailyBreakdown, setShowDailyBreakdown] = useState(false);
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  
  // Handle day click from week view
  const handleDayClick = (dateStr: string) => {
    // Parse the date string (format: "Dec 19")
    const today = new Date();
    const [month, day] = dateStr.split(' ');
    const monthIndex = new Date(`${month} 1, ${today.getFullYear()}`).getMonth();
    const clickedDate = new Date(today.getFullYear(), monthIndex, parseInt(day));
    
    setSelectedDate(clickedDate);
    setShowDailyBreakdown(true);
  };
  
  // Calculate weekData from logged meals
  const calculateWeekData = () => {
    const today = new Date();
    const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const weekData = [];
    
    for (let i = 6; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      date.setHours(0, 0, 0, 0);
      
      const nextDate = new Date(date);
      nextDate.setDate(nextDate.getDate() + 1);
      
      // Filter meals for this day
      const dayMeals = loggedMeals.filter(meal => {
        const mealDate = new Date(meal.dateTime);
        return mealDate >= date && mealDate < nextDate;
      });
      
      // Calculate totals for the day
      let calories = 0;
      let protein = 0;
      let carbs = 0;
      let fat = 0;
      
      dayMeals.forEach(meal => {
        meal.items.forEach(item => {
          calories += item.calories || 0;
          protein += item.protein || 0;
          carbs += item.carbs || 0;
          fat += item.fats || 0;
        });
      });
      
      const dayName = i === 0 ? 'Today' : weekDays[date.getDay()];
      const dateStr = `${date.toLocaleDateString('en-US', { month: 'short' })} ${date.getDate()}`;
      
      weekData.push({
        day: dayName,
        date: dateStr,
        calories: Math.round(calories),
        carbs: Math.round(carbs),
        protein: Math.round(protein),
        fat: Math.round(fat),
        satFat: Math.round(fat * 0.3), // Estimate saturated fat as ~30% of total fat
        sodium: Math.round(calories * 0.8), // Rough estimate
        cholesterol: Math.round(protein * 2.5), // Rough estimate
        fiber: Math.round(carbs * 0.1) // Rough estimate
      });
    }
    
    return weekData;
  };
  
  const weekData = loggedMeals.length > 0 ? calculateWeekData() : [
    { 
      day: 'Mon', 
      date: 'Dec 2',
      calories: 2380,
      carbs: 272,
      protein: 92,
      fat: 76,
      satFat: 18,
      sodium: 2050,
      cholesterol: 245,
      fiber: 26
    },
    { 
      day: 'Tue', 
      date: 'Dec 3',
      calories: 2510,
      carbs: 298,
      protein: 85,
      fat: 82,
      satFat: 22,
      sodium: 2180,
      cholesterol: 268,
      fiber: 24
    },
    { 
      day: 'Wed', 
      date: 'Dec 4',
      calories: 2290,
      carbs: 265,
      protein: 88,
      fat: 71,
      satFat: 16,
      sodium: 1920,
      cholesterol: 230,
      fiber: 29
    },
    { 
      day: 'Thu', 
      date: 'Dec 5',
      calories: 2450,
      carbs: 285,
      protein: 90,
      fat: 79,
      satFat: 19,
      sodium: 2100,
      cholesterol: 252,
      fiber: 27
    },
    { 
      day: 'Fri', 
      date: 'Dec 6',
      calories: 2620,
      carbs: 310,
      protein: 95,
      fat: 85,
      satFat: 24,
      sodium: 2250,
      cholesterol: 285,
      fiber: 23
    },
    { 
      day: 'Sat', 
      date: 'Dec 7',
      calories: 2340,
      carbs: 268,
      protein: 86,
      fat: 74,
      satFat: 17,
      sodium: 2020,
      cholesterol: 238,
      fiber: 28
    },
    { 
      day: 'Today', 
      date: 'Dec 8',
      calories: intake.calories,
      carbs: intake.carbs,
      protein: intake.protein,
      fat: intake.fats,
      satFat: 20,
      sodium: intake.sodium,
      cholesterol: 255,
      fiber: intake.fiber
    },
  ];

  // Calculate macro percentages for today
  const todayData = weekData[weekData.length - 1];
  const proteinCals = todayData.protein * 4;
  const carbsCals = todayData.carbs * 4;
  const fatCals = todayData.fat * 9;
  const totalMacroCals = proteinCals + carbsCals + fatCals;
  
  const proteinPercent = Math.round((proteinCals / totalMacroCals) * 100);
  const carbsPercent = Math.round((carbsCals / totalMacroCals) * 100);
  const fatPercent = Math.round((fatCals / totalMacroCals) * 100);

  // Find max for scaling chart
  const maxCalories = Math.max(...weekData.map(d => d.calories));

  // Data to display based on timeView
  const displayData = timeView === 'day' ? [todayData] : weekData;

  return (
    <div className="fixed inset-0 z-[100] flex items-end justify-center">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onClick={onClose}
      />
      
      {/* Modal */}
      <div className={`relative w-full max-w-lg rounded-t-3xl shadow-2xl max-h-[85vh] overflow-y-auto ${ 
        isDark ? 'bg-slate-900' : 'bg-white'
      }`}>
        {/* Header */}
        <div className={`sticky top-0 z-10 backdrop-blur-xl border-b ${
          isDark ? 'bg-slate-900/95 border-white/10' : 'bg-white/95 border-black/10'
        }`}>
          <div className="px-6 py-4">
            <div className="flex items-center justify-between mb-3">
              <div>
                <h2 className={`text-lg ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  Macros Details
                </h2>
                <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                  Nutrition breakdown
                </p>
              </div>
              <button
                onClick={onClose}
                className={`p-2 rounded-xl transition-colors ${
                  isDark ? 'hover:bg-white/10' : 'hover:bg-black/5'
                }`}
              >
                <span className={`text-2xl ${isDark ? 'text-white/70' : 'text-gray-600'}`}>×</span>
              </button>
            </div>

            {/* Time View Toggle */}
            <div className={`flex gap-2 p-1 rounded-xl ${
              isDark ? 'bg-white/5' : 'bg-gray-100'
            }`}>
              <button
                onClick={() => setTimeView('day')}
                className={`flex-1 px-3 py-1.5 rounded-lg text-xs transition-all ${
                  timeView === 'day'
                    ? isDark 
                      ? 'bg-purple-500 text-white' 
                      : 'bg-purple-600 text-white'
                    : isDark 
                      ? 'text-white/60 hover:text-white/80' 
                      : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                Today
              </button>
              <button
                onClick={() => setTimeView('week')}
                className={`flex-1 px-3 py-1.5 rounded-lg text-xs transition-all ${
                  timeView === 'week'
                    ? isDark 
                      ? 'bg-purple-500 text-white' 
                      : 'bg-purple-600 text-white'
                    : isDark 
                      ? 'text-white/60 hover:text-white/80' 
                      : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                7 Days
              </button>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="px-6 py-6 space-y-6">
          {/* Macro Split - Today Only */}
          {timeView === 'day' && (
            <div className={`rounded-2xl border p-5 ${
              isDark 
                ? 'bg-gradient-to-br from-purple-500/10 to-pink-500/10 border-purple-500/30' 
                : 'bg-gradient-to-br from-purple-50 to-pink-50 border-purple-200'
            }`}>
              <h3 className={`text-sm mb-4 ${isDark ? 'text-white' : 'text-gray-900'}`}>
                Macro Split
              </h3>
              
              <div className="grid grid-cols-3 gap-3 mb-4">
                <div className={`p-4 rounded-xl text-center ${
                  isDark ? 'bg-white/5' : 'bg-white'
                }`}>
                  <div className={`text-2xl mb-1 ${isDark ? 'text-purple-400' : 'text-purple-600'}`}>
                    {proteinPercent}%
                  </div>
                  <div className={`text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                    Protein
                  </div>
                  <div className={`text-xs mt-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                    {todayData.protein}g
                  </div>
                </div>

                <div className={`p-4 rounded-xl text-center ${
                  isDark ? 'bg-white/5' : 'bg-white'
                }`}>
                  <div className={`text-2xl mb-1 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`}>
                    {carbsPercent}%
                  </div>
                  <div className={`text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                    Carbs
                  </div>
                  <div className={`text-xs mt-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                    {todayData.carbs}g
                  </div>
                </div>

                <div className={`p-4 rounded-xl text-center ${
                  isDark ? 'bg-white/5' : 'bg-white'
                }`}>
                  <div className={`text-2xl mb-1 ${isDark ? 'text-orange-400' : 'text-orange-600'}`}>
                    {fatPercent}%
                  </div>
                  <div className={`text-xs ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                    Fat
                  </div>
                  <div className={`text-xs mt-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                    {todayData.fat}g
                  </div>
                </div>
              </div>

              {/* Visual bar */}
              <div className="h-3 rounded-full overflow-hidden flex">
                <div 
                  className="bg-purple-500"
                  style={{ width: `${proteinPercent}%` }}
                />
                <div 
                  className="bg-cyan-500"
                  style={{ width: `${carbsPercent}%` }}
                />
                <div 
                  className="bg-orange-500"
                  style={{ width: `${fatPercent}%` }}
                />
              </div>
            </div>
          )}

          {/* Stacked Chart */}
          <div>
            <div className="flex items-center justify-between mb-3">
              <h3 className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {timeView === 'day' ? 'Today\'s Breakdown' : 'Weekly Trend'}
              </h3>
              {timeView === 'week' && (
                <span className={`text-xs ${isDark ? 'text-white/40' : 'text-gray-400'}`}>
                  Tap a day to view details
                </span>
              )}
            </div>
            
            {timeView === 'week' && (
              <MacrosWeekView 
                weekData={weekData}
                maxCalories={maxCalories}
                isDark={isDark}
                onDayClick={handleDayClick}
              />
            )}
            
            {timeView === 'day' && (
            <div className="space-y-3">
              {displayData.map((day, index) => {
                const isToday = day.day === 'Today';
                const totalCals = day.calories;
                const barPercent = (totalCals / maxCalories) * 100;
                
                // Calculate actual widths based on max value for better visibility
                const maxValue = Math.max(
                  ...displayData.map(d => Math.max(
                    d.carbs, d.protein, d.fat, d.satFat, d.fiber, d.sodium / 10, d.cholesterol / 10
                  ))
                );

                return (
                  <div key={index}>
                    <div className="mb-4">
                      <div className={`flex items-center justify-between mb-2 text-xs ${
                        isToday 
                          ? isDark ? 'text-purple-400' : 'text-purple-600'
                          : isDark ? 'text-white/50' : 'text-gray-500'
                      }`}>
                        <span>{day.day}</span>
                        <span className={isDark ? 'text-white/70' : 'text-gray-700'}>{totalCals} cal</span>
                      </div>
                      
                      <div className="space-y-1.5">
                        <div className="flex items-center gap-2">
                          <div className={`w-16 text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                            Carbs
                          </div>
                          <div className="flex-1">
                            <div className={`h-4 rounded-full overflow-hidden ${
                              isDark ? 'bg-white/5' : 'bg-gray-100'
                            }`}>
                              <div 
                                className={`h-full bg-cyan-500 ${isToday ? '' : 'opacity-70'}`}
                                style={{ width: `${(day.carbs / maxValue) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className={`w-12 text-xs text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                            {day.carbs}g
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          <div className={`w-16 text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                            Protein
                          </div>
                          <div className="flex-1">
                            <div className={`h-4 rounded-full overflow-hidden ${
                              isDark ? 'bg-white/5' : 'bg-gray-100'
                            }`}>
                              <div 
                                className={`h-full bg-purple-500 ${isToday ? '' : 'opacity-70'}`}
                                style={{ width: `${(day.protein / maxValue) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className={`w-12 text-xs text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                            {day.protein}g
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          <div className={`w-16 text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                            Fat
                          </div>
                          <div className="flex-1">
                            <div className={`h-4 rounded-full overflow-hidden ${
                              isDark ? 'bg-white/5' : 'bg-gray-100'
                            }`}>
                              <div 
                                className={`h-full bg-orange-500 ${isToday ? '' : 'opacity-70'}`}
                                style={{ width: `${(day.fat / maxValue) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className={`w-12 text-xs text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                            {day.fat}g
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          <div className={`w-16 text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                            Sat Fat
                          </div>
                          <div className="flex-1">
                            <div className={`h-4 rounded-full overflow-hidden ${
                              isDark ? 'bg-white/5' : 'bg-gray-100'
                            }`}>
                              <div 
                                className={`h-full bg-red-500 ${isToday ? '' : 'opacity-70'}`}
                                style={{ width: `${(day.satFat / maxValue) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className={`w-12 text-xs text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                            {day.satFat}g
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          <div className={`w-16 text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                            Sodium
                          </div>
                          <div className="flex-1">
                            <div className={`h-4 rounded-full overflow-hidden ${
                              isDark ? 'bg-white/5' : 'bg-gray-100'
                            }`}>
                              <div 
                                className={`h-full bg-pink-500 ${isToday ? '' : 'opacity-70'}`}
                                style={{ width: `${((day.sodium / 10) / maxValue) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className={`w-12 text-xs text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                            {day.sodium}mg
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          <div className={`w-16 text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                            Cholesterol
                          </div>
                          <div className="flex-1">
                            <div className={`h-4 rounded-full overflow-hidden ${
                              isDark ? 'bg-white/5' : 'bg-gray-100'
                            }`}>
                              <div 
                                className={`h-full bg-yellow-500 ${isToday ? '' : 'opacity-70'}`}
                                style={{ width: `${((day.cholesterol / 10) / maxValue) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className={`w-12 text-xs text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                            {day.cholesterol}mg
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          <div className={`w-16 text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                            Fiber
                          </div>
                          <div className="flex-1">
                            <div className={`h-4 rounded-full overflow-hidden ${
                              isDark ? 'bg-white/5' : 'bg-gray-100'
                            }`}>
                              <div 
                                className={`h-full bg-green-500 ${isToday ? '' : 'opacity-70'}`}
                                style={{ width: `${(day.fiber / maxValue) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className={`w-12 text-xs text-right ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                            {day.fiber}g
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
            )}

            {/* Legend - Today view only */}
            {timeView === 'day' && (
            <div className="mt-4 grid grid-cols-2 gap-2">
              <div className="flex items-center gap-1.5">
                <div className="w-3 h-3 rounded bg-cyan-500" />
                <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  Carbohydrates
                </span>
              </div>
              <div className="flex items-center gap-1.5">
                <div className="w-3 h-3 rounded bg-purple-500" />
                <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  Protein
                </span>
              </div>
              <div className="flex items-center gap-1.5">
                <div className="w-3 h-3 rounded bg-orange-500" />
                <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  Fat
                </span>
              </div>
              <div className="flex items-center gap-1.5">
                <div className="w-3 h-3 rounded bg-red-500" />
                <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  Saturated Fat
                </span>
              </div>
              <div className="flex items-center gap-1.5">
                <div className="w-3 h-3 rounded bg-pink-500" />
                <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  Sodium
                </span>
              </div>
              <div className="flex items-center gap-1.5">
                <div className="w-3 h-3 rounded bg-yellow-500" />
                <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  Cholesterol
                </span>
              </div>
              <div className="flex items-center gap-1.5">
                <div className="w-3 h-3 rounded bg-green-500" />
                <span className={`text-xs ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  Fiber
                </span>
              </div>
            </div>
            )}
          </div>

          {/* Weekly Summary - Week View Only */}
          {timeView === 'week' && (
            <div className="grid grid-cols-2 gap-3">
              <div className={`p-4 rounded-2xl border ${
                isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
              }`}>
                <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                  Avg Calories
                </div>
                <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {Math.round(weekData.reduce((sum, d) => sum + d.calories, 0) / weekData.length)}
                </div>
                <div className={`text-xs mt-1 ${isDark ? 'text-cyan-400' : 'text-cyan-600'}`}>
                  per day
                </div>
              </div>

              <div className={`p-4 rounded-2xl border ${
                isDark ? 'bg-white/5 border-white/10' : 'bg-gray-50 border-gray-200'
              }`}>
                <div className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                  Avg Protein
                </div>
                <div className={`text-2xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {Math.round(weekData.reduce((sum, d) => sum + d.protein, 0) / weekData.length)}g
                </div>
                <div className={`text-xs mt-1 ${isDark ? 'text-purple-400' : 'text-purple-600'}`}>
                  per day
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
      
      {/* Daily Meal Breakdown Modal */}
      {showDailyBreakdown && selectedDate && (
        <DailyMealBreakdownModal
          isDark={isDark}
          onClose={() => {
            setShowDailyBreakdown(false);
            setSelectedDate(null);
          }}
          date={selectedDate}
          loggedMeals={loggedMeals}
        />
      )}
    </div>
  );
}

// Daily Meal Breakdown Modal Component - NOW IN SEPARATE FILE
/* OLD VERSION - COMMENTED OUT
function DailyMealBreakdownModal_OLD({
  isDark,
  onClose,
  date,
  loggedMeals
}: {
  isDark: boolean;
  onClose: () => void;
  date: Date;
  loggedMeals: LoggedMeal[];
}) {
  // Filter meals for the selected date
  const selectedDate = new Date(date);
  selectedDate.setHours(0, 0, 0, 0);
  const nextDate = new Date(selectedDate);
  nextDate.setDate(nextDate.getDate() + 1);
  
  const dayMeals = loggedMeals.filter(meal => {
    const mealDate = new Date(meal.dateTime);
    return mealDate >= selectedDate && mealDate < nextDate;
  });
  
  // Calculate totals
  const totals = dayMeals.reduce((acc, meal) => {
    meal.items.forEach(item => {
      acc.calories += item.calories || 0;
      acc.protein += item.protein || 0;
      acc.carbs += item.carbs || 0;
      acc.fats += item.fats || 0;
    });
    return acc;
  }, { calories: 0, protein: 0, carbs: 0, fats: 0 });
  
  const isToday = selectedDate.toDateString() === new Date().toDateString();
  const dateStr = isToday ? 'Today' : selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
  
  return (
    <div className="fixed inset-0 z-[100] flex items-end justify-center">
      {/* Backdrop */}
      <div 
        className={`absolute inset-0 ${isDark ? 'bg-black/60' : 'bg-black/40'} backdrop-blur-sm`}
        onClick={onClose}
      />
      
      {/* Modal */}
      <div 
        className={`relative w-full max-w-2xl rounded-t-3xl border-t border-x overflow-hidden ${
          isDark ? 'bg-slate-900 border-white/10' : 'bg-gray-50 border-black/10'
        }`}
        style={{ maxHeight: '90vh' }}
      >
        {/* Header */}
        <div className={`sticky top-0 z-10 backdrop-blur-xl border-b px-6 py-4 ${
          isDark ? 'bg-slate-900/95 border-white/10' : 'bg-gray-50/95 border-black/10'
        }`}>
          <div className=\"flex items-center justify-between\">
            <div>
              <h2 className={`text-xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {dateStr}
              </h2>
              <p className={`text-sm mt-1 ${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                {dayMeals.length} {dayMeals.length === 1 ? 'meal' : 'meals'} logged
              </p>
            </div>
            <button
              onClick={onClose}
              className={`p-2 rounded-xl transition-colors ${
                isDark ? 'hover:bg-white/10' : 'hover:bg-black/5'
              }`}
            >
              <X className={`w-6 h-6 ${isDark ? 'text-white' : 'text-gray-900'}`} />
            </button>
          </div>
        </div>
        
        {/* Content */}
        <div className=\"overflow-y-auto px-6 py-4\" style={{ maxHeight: 'calc(90vh - 180px)' }}>
          {dayMeals.length === 0 ? (
            <div className={`text-center py-12 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              <Apple className={`w-12 h-12 mx-auto mb-3 ${isDark ? 'text-white/30' : 'text-gray-400'}`} />
              <p className=\"text-sm\">No meals logged for this day</p>
            </div>
          ) : (
            <div className=\"space-y-4\">
              {dayMeals.map((meal) => {
                const mealTotals = meal.items.reduce((acc, item) => ({
                  calories: acc.calories + (item.calories || 0),
                  protein: acc.protein + (item.protein || 0),
                  carbs: acc.carbs + (item.carbs || 0),
                  fats: acc.fats + (item.fats || 0)
                }), { calories: 0, protein: 0, carbs: 0, fats: 0 });
                
                return (
                  <div
                    key={meal.id}
                    className={`backdrop-blur-xl rounded-2xl border p-5 ${
                      isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
                    }`}
                  >
                    <div className=\"flex items-start justify-between mb-3\">
                      <div>
                        <h3 className={`text-base mb-1 ${isDark ? 'text-white' : 'text-gray-900'}`}>
                          {meal.meal}
                        </h3>
                        <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                          {new Date(meal.dateTime).toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit' 
                          })}
                        </p>
                      </div>
                      <div className={`text-base ${isDark ? 'text-white' : 'text-gray-900'}`}>
                        {Math.round(mealTotals.calories)} cal
                      </div>
                    </div>
                    
                    {/* Food Items */}
                    <div className=\"space-y-2 mb-3\">
                      {meal.items.map((item) => (
                        <div
                          key={item.id}
                          className={`p-3 rounded-xl ${isDark ? 'bg-white/5' : 'bg-black/5'}`}
                        >
                          <div className=\"flex items-start justify-between mb-2\">
                            <div className=\"flex-1\">
                              <div className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
                                {item.name}
                              </div>
                              <div className={`text-xs mt-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                                {item.portion}
                              </div>
                            </div>
                            <div className={`text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                              {item.calories} cal
                            </div>
                          </div>
                          <div className={`flex gap-4 text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                            <span>Protein: {item.protein}g</span>
                            <span>Carbs: {item.carbs}g</span>
                            <span>Fat: {item.fats}g</span>
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    {/* Meal Totals */}
                    <div className={`pt-3 border-t flex justify-between ${
                      isDark ? 'border-white/10' : 'border-black/10'
                    }`}>
                      <span className={`text-sm ${isDark ? 'text-white/70' : 'text-gray-700'}`}>
                        Meal Total
                      </span>
                      <div className=\"flex gap-3 text-sm\">
                        <span className={isDark ? 'text-white/60' : 'text-gray-600'}>
                          P: {Math.round(mealTotals.protein)}g
                        </span>
                        <span className={isDark ? 'text-white/60' : 'text-gray-600'}>
                          C: {Math.round(mealTotals.carbs)}g
                        </span>
                        <span className={isDark ? 'text-white/60' : 'text-gray-600'}>
                          F: {Math.round(mealTotals.fats)}g
                        </span>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
        
        {/* Footer - Daily Summary */}
        {dayMeals.length > 0 && (
          <div className={`sticky bottom-0 backdrop-blur-xl border-t px-6 py-4 ${
            isDark ? 'bg-slate-900/95 border-white/10' : 'bg-gray-50/95 border-black/10'
          }`}>
            <div className=\"flex items-center justify-between\">
              <div className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
                Daily Total
              </div>
              <div className=\"flex gap-4\">
                <div className={`${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {Math.round(totals.calories)} cal
                </div>
                <div className={`${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  P: {Math.round(totals.protein)}g
                </div>
                <div className={`${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  C: {Math.round(totals.carbs)}g
                </div>
                <div className={`${isDark ? 'text-white/60' : 'text-gray-600'}`}>
                  F: {Math.round(totals.fats)}g
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
END OF OLD VERSION */

// Glucose Monitoring Tab Content
function GlucoseTabContent({ isDark }: { isDark: boolean }) {
  const [timeRange, setTimeRange] = useState<'day' | '7d' | '14d'>('day');
  
  // Mock data for demonstration
  const currentGlucose = 98;
  const glucoseStatus: 'low' | 'normal' | 'high' = currentGlucose < 70 ? 'low' : currentGlucose > 140 ? 'high' : 'normal';
  
  // Time in range data
  const timeInRangeToday = 87; // percentage
  const timeInRange7d = 82; // percentage
  
  // Daily average
  const avgToday = 102;
  const minToday = 72;
  const maxToday = 145;
  
  // Lows and Highs
  const lowsToday = { count: 1, minutes: 23 };
  const highsToday = { count: 2, minutes: 87 };
  
  // Generate mock trend data
  const generateTrendData = (range: 'day' | '7d' | '14d') => {
    const points = range === 'day' ? 24 : range === '7d' ? 168 : 336;
    const data = [];
    for (let i = 0; i < points; i++) {
      const baseValue = 95 + Math.sin(i / 4) * 15;
      const noise = (Math.random() - 0.5) * 20;
      data.push({
        value: Math.max(60, Math.min(180, baseValue + noise)),
        time: i
      });
    }
    return data;
  };
  
  const trendData = generateTrendData(timeRange);
  
  return (
    <div className="space-y-4">
      {/* Hero - Current Glucose */}
      <div className={`backdrop-blur-xl rounded-3xl border p-6 ${
        isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
      }`}>
        <div className="text-center">
          <p className={`text-xs mb-2 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
            Right Now
          </p>
          <div className="flex items-baseline justify-center gap-2 mb-3">
            <span className={`text-6xl ${
              glucoseStatus === 'low' ? 'text-orange-500' :
              glucoseStatus === 'high' ? 'text-red-500' :
              isDark ? 'text-green-400' : 'text-green-600'
            }`}>
              {currentGlucose}
            </span>
            <span className={`text-xl ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
              mg/dL
            </span>
          </div>
          <div className={`inline-flex items-center gap-2 px-4 py-2 rounded-full ${
            glucoseStatus === 'low' ? 'bg-orange-500/20 text-orange-500' :
            glucoseStatus === 'high' ? 'bg-red-500/20 text-red-500' :
            isDark ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700'
          }`}>
            {glucoseStatus === 'low' && <TrendingDown className="w-4 h-4" />}
            {glucoseStatus === 'high' && <TrendingUp className="w-4 h-4" />}
            {glucoseStatus === 'normal' && <Gauge className="w-4 h-4" />}
            <span className="text-sm font-medium">
              {glucoseStatus === 'low' ? 'Below Range' : 
               glucoseStatus === 'high' ? 'Above Range' : 'In Range'}
            </span>
          </div>
        </div>
      </div>
      
      {/* Time in Range */}
      <div className={`backdrop-blur-xl rounded-3xl border p-5 ${
        isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
      }`}>
        <h3 className={`text-sm mb-4 ${isDark ? 'text-white' : 'text-gray-900'}`}>
          Time in Range
        </h3>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <p className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Today
            </p>
            <div className="flex items-baseline gap-1">
              <span className={`text-3xl ${isDark ? 'text-green-400' : 'text-green-600'}`}>
                {timeInRangeToday}
              </span>
              <span className={`text-lg ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
                %
              </span>
            </div>
            <div className={`mt-2 h-2 rounded-full overflow-hidden ${
              isDark ? 'bg-white/10' : 'bg-gray-200'
            }`}>
              <div 
                className="h-full bg-gradient-to-r from-green-400 to-green-500"
                style={{ width: `${timeInRangeToday}%` }}
              />
            </div>
          </div>
          
          <div>
            <p className={`text-xs mb-1 ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              7 Days
            </p>
            <div className="flex items-baseline gap-1">
              <span className={`text-3xl ${isDark ? 'text-green-400' : 'text-green-600'}`}>
                {timeInRange7d}
              </span>
              <span className={`text-lg ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
                %
              </span>
            </div>
            <div className={`mt-2 h-2 rounded-full overflow-hidden ${
              isDark ? 'bg-white/10' : 'bg-gray-200'
            }`}>
              <div 
                className="h-full bg-gradient-to-r from-green-400 to-green-500"
                style={{ width: `${timeInRange7d}%` }}
              />
            </div>
          </div>
        </div>
      </div>
      
      {/* Daily Average */}
      <div className={`backdrop-blur-xl rounded-3xl border p-5 ${
        isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
      }`}>
        <h3 className={`text-sm mb-4 ${isDark ? 'text-white' : 'text-gray-900'}`}>
          Daily Average
        </h3>
        <div className="flex items-end gap-2 mb-3">
          <span className={`text-4xl ${isDark ? 'text-white' : 'text-gray-900'}`}>
            {avgToday}
          </span>
          <span className={`text-lg mb-1 ${isDark ? 'text-white/40' : 'text-gray-500'}`}>
            mg/dL
          </span>
        </div>
        <div className="flex items-center justify-between">
          <div>
            <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Min
            </p>
            <p className={`text-xl ${isDark ? 'text-orange-400' : 'text-orange-600'}`}>
              {minToday}
            </p>
          </div>
          <div className={`flex-1 mx-4 h-1 rounded-full ${
            isDark ? 'bg-white/10' : 'bg-gray-200'
          }`}>
            <div className="h-full bg-gradient-to-r from-orange-400 via-green-400 to-red-400 rounded-full" />
          </div>
          <div>
            <p className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
              Max
            </p>
            <p className={`text-xl ${isDark ? 'text-red-400' : 'text-red-600'}`}>
              {maxToday}
            </p>
          </div>
        </div>
      </div>
      
      {/* Lows and Highs */}
      <div className="grid grid-cols-2 gap-4">
        {/* Lows */}
        <div className={`backdrop-blur-xl rounded-3xl border p-5 ${
          isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
        }`}>
          <div className="flex items-center gap-2 mb-3">
            <TrendingDown className="w-4 h-4 text-orange-500" />
            <h3 className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Lows
            </h3>
          </div>
          <div className="mb-3">
            <div className="flex items-baseline gap-1">
              <span className={`text-3xl ${isDark ? 'text-orange-400' : 'text-orange-600'}`}>
                {lowsToday.count}
              </span>
              <span className={`text-sm ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                events
              </span>
            </div>
          </div>
          <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
            {lowsToday.minutes} mins below range
          </div>
        </div>
        
        {/* Highs */}
        <div className={`backdrop-blur-xl rounded-3xl border p-5 ${
          isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
        }`}>
          <div className="flex items-center gap-2 mb-3">
            <TrendingUp className="w-4 h-4 text-red-500" />
            <h3 className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Highs
            </h3>
          </div>
          <div className="mb-3">
            <div className="flex items-baseline gap-1">
              <span className={`text-3xl ${isDark ? 'text-red-400' : 'text-red-600'}`}>
                {highsToday.count}
              </span>
              <span className={`text-sm ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
                events
              </span>
            </div>
          </div>
          <div className={`text-xs ${isDark ? 'text-white/50' : 'text-gray-500'}`}>
            {highsToday.minutes} mins above range
          </div>
        </div>
      </div>
      
      {/* Trend Chart */}
      <div className={`backdrop-blur-xl rounded-3xl border p-5 ${
        isDark ? 'bg-white/5 border-white/10' : 'bg-white/60 border-black/10'
      }`}>
        <div className="flex items-center justify-between mb-4">
          <h3 className={`text-sm ${isDark ? 'text-white' : 'text-gray-900'}`}>
            Trend
          </h3>
          <div className="flex gap-2">
            <button
              onClick={() => setTimeRange('day')}
              className={`px-3 py-1 rounded-full text-xs transition-all ${
                timeRange === 'day'
                  ? isDark
                    ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30'
                    : 'bg-cyan-100 text-cyan-700 border border-cyan-300'
                  : isDark
                    ? 'bg-white/5 text-white/50 border border-white/10'
                    : 'bg-white/40 text-gray-600 border border-black/10'
              }`}
            >
              Day
            </button>
            <button
              onClick={() => setTimeRange('7d')}
              className={`px-3 py-1 rounded-full text-xs transition-all ${
                timeRange === '7d'
                  ? isDark
                    ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30'
                    : 'bg-cyan-100 text-cyan-700 border border-cyan-300'
                  : isDark
                    ? 'bg-white/5 text-white/50 border border-white/10'
                    : 'bg-white/40 text-gray-600 border border-black/10'
              }`}
            >
              7D
            </button>
            <button
              onClick={() => setTimeRange('14d')}
              className={`px-3 py-1 rounded-full text-xs transition-all ${
                timeRange === '14d'
                  ? isDark
                    ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30'
                    : 'bg-cyan-100 text-cyan-700 border border-cyan-300'
                  : isDark
                    ? 'bg-white/5 text-white/50 border border-white/10'
                    : 'bg-white/40 text-gray-600 border border-black/10'
              }`}
            >
              14D
            </button>
          </div>
        </div>
        
        <GlucoseTrendChart 
          data={trendData}
          isDark={isDark}
          timeRange={timeRange}
        />
      </div>
    </div>
  );
}

interface GlucoseTrendChartProps {
  data: Array<{ value: number; time: number }>;
  isDark: boolean;
  timeRange: 'day' | '7d' | '14d';
}

function GlucoseTrendChart({ data, isDark, timeRange }: GlucoseTrendChartProps) {
  const chartWidth = 320;
  const chartHeight = 160;
  const padding = { top: 20, bottom: 30, left: 0, right: 0 };
  const innerHeight = chartHeight - padding.top - padding.bottom;
  
  const minValue = 60;
  const maxValue = 180;
  const valueRange = maxValue - minValue;
  
  // Target range
  const targetMin = 70;
  const targetMax = 140;
  
  const points = data.map((d, index) => {
    const x = (index / Math.max(data.length - 1, 1)) * chartWidth;
    const y = padding.top + (1 - (d.value - minValue) / valueRange) * innerHeight;
    const inRange = d.value >= targetMin && d.value <= targetMax;
    return { x, y, value: d.value, inRange };
  });
  
  const targetMinY = padding.top + (1 - (targetMin - minValue) / valueRange) * innerHeight;
  const targetMaxY = padding.top + (1 - (targetMax - minValue) / valueRange) * innerHeight;
  
  return (
    <div className="w-full">
      <svg width="100%" height={chartHeight} viewBox={`0 0 ${chartWidth} ${chartHeight}`} className="overflow-visible">
        <defs>
          <linearGradient id="glucose-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stopColor="#10b981" stopOpacity="0.2" />
            <stop offset="100%" stopColor="#10b981" stopOpacity="0.05" />
          </linearGradient>
        </defs>
        
        {/* Target range band */}
        <rect
          x={0}
          y={targetMaxY}
          width={chartWidth}
          height={targetMinY - targetMaxY}
          fill="url(#glucose-gradient)"
          rx={4}
        />
        
        {/* Target range lines */}
        <line
          x1={0}
          y1={targetMaxY}
          x2={chartWidth}
          y2={targetMaxY}
          stroke="#10b981"
          strokeWidth={1}
          strokeDasharray="4 4"
          opacity={0.4}
        />
        <line
          x1={0}
          y1={targetMinY}
          x2={chartWidth}
          y2={targetMinY}
          stroke="#10b981"
          strokeWidth={1}
          strokeDasharray="4 4"
          opacity={0.4}
        />
        
        {/* Gradient fill under curve */}
        <defs>
          <linearGradient id="area-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stopColor="#06b6d4" stopOpacity="0.3" />
            <stop offset="100%" stopColor="#06b6d4" stopOpacity="0.05" />
          </linearGradient>
        </defs>
        
        <path
          d={`
            M 0 ${chartHeight - padding.bottom}
            L ${points.map(p => `${p.x} ${p.y}`).join(' L ')}
            L ${chartWidth} ${chartHeight - padding.bottom}
            Z
          `}
          fill="url(#area-gradient)"
        />
        
        {/* Line */}
        <path
          d={`M ${points.map(p => `${p.x} ${p.y}`).join(' L ')}`}
          fill="none"
          stroke="#06b6d4"
          strokeWidth={2}
          strokeLinecap="round"
          strokeLinejoin="round"
        />
        
        {/* Y-axis labels */}
        <text
          x={chartWidth - 5}
          y={padding.top - 5}
          className={`text-[10px] ${isDark ? 'fill-white/40' : 'fill-gray-500'}`}
          textAnchor="end"
        >
          {maxValue}
        </text>
        <text
          x={chartWidth - 5}
          y={chartHeight - padding.bottom + 12}
          className={`text-[10px] ${isDark ? 'fill-white/40' : 'fill-gray-500'}`}
          textAnchor="end"
        >
          {minValue}
        </text>
      </svg>
      
      {/* Legend */}
      <div className="flex items-center justify-center gap-4 mt-4 text-xs">
        <div className="flex items-center gap-1.5">
          <div className="w-3 h-3 rounded-full bg-green-500"></div>
          <span className={isDark ? 'text-white/50' : 'text-gray-500'}>
            Target: {targetMin}-{targetMax} mg/dL
          </span>
        </div>
      </div>
    </div>
  );
}