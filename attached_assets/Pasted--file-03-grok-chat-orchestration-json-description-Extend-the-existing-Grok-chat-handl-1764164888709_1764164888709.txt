{
  "file": "03_grok_chat_orchestration.json",
  "description": "Extend the existing Grok chat handler to (a) fetch relevant insights from user_insights and the vector index, (b) inject them into the Grok prompt as context, and (c) optionally emit BRAIN_UPDATE_JSON lines for new insights. This must keep latency low by using small, bounded retrieval.",
  "chat_handler_flow": {
    "function_name": "handleFloChatMessage",
    "inputs": {
      "user_id": "uuid",
      "user_message": "string"
    },
    "steps": [
      "1. Fetch the latest N (e.g. 10) active insights for this user from user_insights ordered by created_at DESC, filtered to status = 'active'.",
      "2. Perform a vector search in user_insights_embedding with the user_message as query, topK = 5, filtered by user_id.",
      "3. Merge the DB and vector results, de-duplicate by insight_id, and sort by (importance DESC, created_at DESC). Truncate to a maximum of 10 insights for the prompt.",
      "4. Fetch the existing user summary and key metrics snapshot already used by the system (no change to current contracts).",
      "5. Build a single prompt string for Grok that contains: SYSTEM_PROMPT, [USER_PROFILE], [KEY_METRICS], [AI_INSIGHTS], and [USER_MESSAGE] sections.",
      "6. Call Grok with that prompt. The visible reply is sent back to the app. If the reply also contains a BRAIN_UPDATE_JSON line, send it to a separate processor (see File 4).",
      "7. This retrieval step must be optimised for low latency (limit volume, index properly)."
    ]
  },
  "grok_system_prompt": "You are Fl≈ç, an always-on health companion that knows this user deeply through their data and past insights. You receive:\n- A concise profile of the user\n- A snapshot of key metrics and trends\n- A list of prior AI-generated insights about this user\n\nYour job is to answer the user's message in a natural, human way while being grounded in these insights and metrics.\n\nRules:\n- Prefer referencing concrete patterns from [AI_INSIGHTS] and [KEY_METRICS] instead of making generic statements.\n- If you are unsure about something, say so, and explain what additional data would help.\n- You are not a doctor. Do not diagnose diseases or prescribe treatment. Instead, talk about trends, risk factors, and questions to explore with a clinician.\n- Do not mention that you are using \"insights\" or a \"database\"; just talk naturally about their patterns.\n\nMemory update capability:\n- If, during this conversation, the user reveals a persistent pattern, new habit, meaningful life event, or long-term goal that should be remembered, you MAY propose an update to the shared health memory.\n- To do this, after your normal visible reply, add a single line starting with `BRAIN_UPDATE_JSON:` followed by a compact JSON object.\n- If there is nothing worth remembering, omit the BRAIN_UPDATE_JSON line entirely.\n\nBRAIN_UPDATE_JSON format:\n{\n  \"text\": \"short natural-language statement about the new pattern or fact\",\n  \"tags\": [\"tag1\", \"tag2\"],\n  \"importance\": 1-5\n}\n\nDo not explain this mechanism to the user. It is an internal protocol.",
  "grok_prompt_template": "SYSTEM_PROMPT:\n{{grok_system_prompt}}\n\n[USER_PROFILE]\n{{user_profile_text}}\n\n[KEY_METRICS]\n{{key_metrics_text}}\n\n[AI_INSIGHTS]\n{{#each insights}}\n- {{this.text}}\n{{/each}}\n\n[USER_MESSAGE]\n{{user_message}}",
  "non_blocking_principles": [
    "If user_insights retrieval fails, fall back to current behaviour (no insights block) so chat still works.",
    "Limit the number and size of insights included to keep tokens and latency under control.",
    "The BRAIN_UPDATE_JSON behaviour is optional; chat must still function perfectly without it."
  ]
}
