# Flō - AI-Powered Health Insights Platform

## Overview
Flō is a mobile-first health analytics platform that leverages AI to analyze blood work, calculate biological age, and deliver personalized health recommendations. It provides a dashboard with four intelligent tiles summarizing lab results, diagnostic studies, and HealthKit data into actionable health scores. The platform tracks health metrics over time, integrates OpenAI's GPT models for insights, and Apple HealthKit for real-time wellness data across 26 types. Key features include user authentication, comprehensive profiles, admin tools, and billing via Stripe and Apple Pay. The core purpose is to provide trusted, clear, and actionable health information.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### UI/UX Decisions
The platform features an Apple Human Interface Guidelines-inspired design, focusing on a mobile-first, content-focused minimalist aesthetic with 44pt touch targets. It uses Shadcn/ui (Radix UI primitives) with custom theming and Tailwind CSS for components and styling.

### Technical Implementations
**Frontend:** Built with React and TypeScript using Vite, leveraging TanStack Query for server state management and Wouter for client-side routing. It includes features like biomarker insights modals, comprehensive AI-powered health reports, PDF upload for blood work parsing, an admin dashboard, mobile authentication (Apple Sign-In, Email/Password), DEXA scan display, and native iOS HealthKit integration with automatic background syncing for 26 data types. The dashboard features the new **Flōmentum tile** displaying daily health momentum scores with circular gauge visualization and zone badges. A dedicated Flōmentum screen provides detailed daily/weekly insights with factor breakdowns and personalized focus recommendations. **HealthKit sync includes robust React Query cache invalidation** using predicate-based matching with `refetchType: 'active'` to immediately refresh all health-related queries after sync completes. The invalidation predicate uses `Array.prototype.some()` to check all segments of multi-part query keys (e.g., `['/api/dashboard', 'overview']`), ensuring dashboard tiles refresh correctly. **A 4-second delay before cache invalidation** ensures the Swift background upload completes before queries refetch, preventing stale data. The `refetchType: 'active'` parameter forces immediate refetch of active queries even with `staleTime: Infinity`, ensuring the UI always displays current metrics without requiring manual refresh. The iOS app now performs **periodic 15-minute syncs** while open (silent background updates) in addition to the initial sync on app launch (with notification). **HealthKit authorization is requested via `HKHealthStore.requestAuthorization` on first sync** in HealthSyncPlugin.swift, ensuring iOS shows the permission prompt and authorization status changes from notDetermined (0) to authorized (1), enabling data collection.

**Backend:** Developed with Express.js and TypeScript, providing a RESTful API. It features a unified authentication system supporting both web (Replit Auth OIDC) and mobile (JWT) authentication, file storage via pre-signed URLs to GCS, and implements the PhenoAge biological age calculation. The backend includes a robust blood work extraction pipeline using GPT-4o with a custom normalizer, AI integration for insights, and admin endpoints. **Biomarker scoring uses a comprehensive alias mapping system** to handle different lab naming conventions (e.g., "Glucose" vs "Fasting Glucose" vs "Glucose (Fasting)", "LDL" vs "LDL Cholesterol"), ensuring consistent score calculation regardless of which variant appears on different labs' reports. It also features a sophisticated HealthKit Readiness System, a Comprehensive Sleep Tracking System, and the new **Flōmentum Momentum Scoring System**. All three systems use iOS-side normalization, backend baseline calculation, and AI-powered scoring based on personalized baselines. The Flōmentum system calculates a 0-100 daily score based on sleep (±12 pts), activity (±16 pts), recovery (±12 pts), and red flags (-16 pts), with weekly aggregation running via cron (Monday 03:00 UTC). **The /api/healthkit/daily-metrics endpoint automatically triggers Flōmentum scoring when iOS syncs HealthKit data**, mapping userDailyMetrics fields to Flōmentum metrics and syncing to health_daily_metrics for consistency. **HealthKit data normalization uses HKStatisticsQuery with .separateBySource for deduplication, selecting the primary source (highest count) per device type to prevent double-counting from multiple sources (steps, exercise minutes)**. **Sleep tracking queries from previous day noon to current day 6PM to capture full overnight sleep sessions** (sleep typically starts the evening before the wake date). **Exercise minutes collection uses the same source deduplication strategy as steps, preventing double-counting when multiple apps track the same workout.** Sleep processing merges overlapping HealthKit intervals to calculate accurate stage durations, with proper bedtime/waketime formatting. Memory management ensures strong self capture in async HealthKit callbacks to prevent premature deallocation. All production code utilizes structured error logging. **Apple Push Notifications (APNs) integration** provides real-time delivery of biomarker alerts even when the app is closed. The system uses token-based authentication with `.p8` keys, device token management stored in PostgreSQL, immediate push delivery via `apns2` library when notification triggers fire, batch notification support, fallback to database logging, and admin-configurable APNs credentials (team ID, key ID, bundle ID). iOS device tokens are registered on app launch and managed through dedicated endpoints.

**Data Storage:** The project uses PostgreSQL (Neon serverless) with Drizzle ORM. The schema includes tables for users, sessions, profiles, blood work, AI analysis results, diagnostic studies, body fat reference ranges, HealthKit samples, normalized HealthKit daily metrics, HealthKit metric baselines, daily readiness scores, sleep metrics, **Flōmentum tables (user_settings, health_daily_metrics, flomentum_daily, flomentum_weekly, health_baselines)**, push notification management (deviceTokens, apnsConfiguration, notificationTriggers, notificationLogs), billing information, and audit logs.

**Admin User Management:** Implements Role-Based Access Control (RBAC) with `free`, `premium`, and `admin` roles. The admin dashboard provides user management (search, filter, inline editing, deletion), system overview metrics, AI API usage tracking, and audit logs, with strict security measures.

**Billing & Payments:** Integrates Stripe for credit/debit card processing and Apple Pay, with dedicated database tables for customers, subscriptions, and payments.

**Logging System:** Production-safe structured logging is implemented server-side and client-side, with environment-aware configurations.

## External Dependencies

### Third-Party Services
- **Replit Platform Services:** Replit Auth, Replit AI Integrations (OpenAI proxy), Replit Object Storage (GCS-compatible).
- **Neon:** Serverless PostgreSQL database.
- **Google Cloud Storage:** For object storage.
- **Stripe:** Payment processing.
- **OpenAI:** GPT-4o and GPT-5 models.

### Key Technologies/Libraries
- **Frontend:** `@tanstack/react-query`, `wouter`, `@radix-ui/*`, `tailwindcss`, `react-hook-form`, `zod`, `date-fns`, `@capacitor/*`, `capacitor-secure-storage-plugin`, `@healthpilot/healthkit`.
- **Backend:** `express`, `drizzle-orm`, `@neondatabase/serverless`, `passport`, `openid-client`, `express-session`, `connect-pg-simple`, `@google-cloud/storage`, `openai`, `jose`, `jsonwebtoken`, `pdf-parse`, `apns2`.