# Flō - AI-Powered Health Insights Platform

## Overview
Flō is a mobile-first health analytics platform that leverages AI to analyze blood work, calculate biological age, and deliver personalized health recommendations. It provides a dashboard with four intelligent tiles summarizing lab results, diagnostic studies, and HealthKit data into actionable health scores. The platform tracks health metrics over time, integrates OpenAI's GPT models for insights, and Apple HealthKit for real-time wellness data across 26 types. Key features include user authentication, comprehensive profiles, admin tools, billing via Stripe and Apple Pay, and **Flō Oracle** - a Grok-powered voice chat coach providing real-time health insights. The core purpose is to provide trusted, clear, and actionable health information.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### UI/UX Decisions
The platform features an Apple Human Interface Guidelines-inspired design, focusing on a mobile-first, content-focused minimalist aesthetic with 44pt touch targets. It uses Shadcn/ui (Radix UI primitives) with custom theming and Tailwind CSS for components and styling.

### Technical Implementations
**Frontend:** Built with React and TypeScript using Vite, leveraging TanStack Query for server state management and Wouter for client-side routing. It includes features like biomarker insights modals, comprehensive AI-powered health reports, PDF upload for blood work parsing, an admin dashboard, mobile authentication (Apple Sign-In, Email/Password), DEXA scan display, native iOS HealthKit integration with automatic background syncing for 26 data types, and **Flō Oracle voice chat** (accessible via Dashboard "Add" button, using ElevenLabs Conversational AI platform for natural voice conversations with 16kHz PCM audio encoding, WebSocket protocol with JSON message format, and audio queue management). The dashboard features the new **Flōmentum tile** displaying daily health momentum scores with circular gauge visualization and zone badges. A dedicated Flōmentum screen provides detailed daily/weekly insights with factor breakdowns and personalized focus recommendations. **HealthKit sync includes robust React Query cache invalidation** using predicate-based matching with `refetchType: 'active'` to immediately refresh all health-related queries after sync completes. The invalidation predicate uses `Array.prototype.some()` to check all segments of multi-part query keys (e.g., `['/api/dashboard', 'overview']`), ensuring dashboard tiles refresh correctly. **A 4-second delay before cache invalidation** ensures the Swift background upload completes before queries refetch, preventing stale data. The `refetchType: 'active'` parameter forces immediate refetch of active queries even with `staleTime: Infinity`, ensuring the UI always displays current metrics without requiring manual refresh. The iOS app now performs **periodic 15-minute syncs** while open (silent background updates) in addition to the initial sync on app launch (with notification). **HealthKit authorization is requested via `HKHealthStore.requestAuthorization` on first sync** in HealthSyncPlugin.swift, ensuring iOS shows the permission prompt and authorization status changes from notDetermined (0) to authorized (1), enabling data collection.

**Backend:** Developed with Express.js and TypeScript, providing a RESTful API. It features a unified authentication system supporting both web (Replit Auth OIDC) and mobile (JWT) authentication, file storage via pre-signed URLs to GCS, and implements the PhenoAge biological age calculation. The backend includes a robust blood work extraction pipeline using GPT-4o with a custom normalizer, AI integration for insights, admin endpoints, and **Flō Oracle integration** (Grok-powered chat using xAI's grok-3-mini model with comprehensive health context injection and multi-layer safety guardrails). **ElevenLabs integration** provides natural voice conversations through a custom OpenAI-compatible bridge endpoint (`/api/elevenlabs/llm/chat/completions`) that receives ElevenLabs requests, injects full health context, forwards to Grok, and returns responses for text-to-speech. Agent ID stored server-side with user-scoped signed WebSocket URLs for secure connections. **Biomarker scoring uses a comprehensive alias mapping system** to handle different lab naming conventions (e.g., "Glucose" vs "Fasting Glucose" vs "Glucose (Fasting)", "LDL" vs "LDL Cholesterol"), ensuring consistent score calculation regardless of which variant appears on different labs' reports. It also features a sophisticated HealthKit Readiness System, a Comprehensive Sleep Tracking System, and the new **Flōmentum Momentum Scoring System**. All three systems use iOS-side normalization, backend baseline calculation, and AI-powered scoring based on personalized baselines. The Flōmentum system calculates a 0-100 daily score based on sleep (±12 pts), activity (±16 pts), recovery (±12 pts), and red flags (-16 pts), with weekly aggregation running via cron (Monday 03:00 UTC). **The /api/healthkit/daily-metrics endpoint automatically triggers Flōmentum scoring when iOS syncs HealthKit data**. **Flōmentum sleep data is queried from the sleep_nights table** (which processes all sleep stages: deep, REM, core) rather than relying on sleepHours from iOS normalized metrics (which only captures "in bed" samples and may be null for Apple Watch users without in-bed tracking). **The /api/healthkit/sleep-samples endpoint recalculates Flōmentum scores after sleep data is processed**, ensuring scores include sleep metrics even though sleep uploads arrive after daily metrics. **HealthKit data normalization uses HKStatisticsQuery with .separateBySource for deduplication, selecting the primary source (highest count) per device type to prevent double-counting from multiple sources (steps, exercise minutes)**. **Sleep tracking queries from previous day noon to current day 6PM to capture full overnight sleep sessions** (sleep typically starts the evening before the wake date). **Exercise minutes collection uses the same source deduplication strategy as steps, preventing double-counting when multiple apps track the same workout.** Sleep processing merges overlapping HealthKit intervals to calculate accurate stage durations, with proper bedtime/waketime formatting. Memory management ensures strong self capture in async HealthKit callbacks to prevent premature deallocation. All production code utilizes structured error logging. **Apple Push Notifications (APNs) integration** provides real-time delivery of biomarker alerts even when the app is closed. The system uses token-based authentication with `.p8` keys, device token management stored in PostgreSQL, immediate push delivery via `apns2` library when notification triggers fire, batch notification support, fallback to database logging, and admin-configurable APNs credentials (team ID, key ID, bundle ID). iOS device tokens are registered on app launch and managed through dedicated endpoints.

**Data Storage:** The project uses PostgreSQL (Neon serverless) with Drizzle ORM. The schema includes tables for users, sessions, profiles, blood work, AI analysis results, diagnostic studies, body fat reference ranges, HealthKit samples, normalized HealthKit daily metrics, HealthKit metric baselines, daily readiness scores, sleep metrics, **Flōmentum tables (user_settings, health_daily_metrics, flomentum_daily, flomentum_weekly, health_baselines)**, **RAG Insights tables (insight_cards for discovered patterns with categories/confidence scores, health_embeddings table in Supabase with pgvector support for 1536-dimensional semantic search)**, push notification management (deviceTokens, apnsConfiguration, notificationTriggers, notificationLogs), billing information, and audit logs.

**RAG Insights System:** Production-ready intelligent pattern detection using Retrieval-Augmented Generation. **Vectorization**: Syncs blood work and HealthKit data to Supabase as OpenAI embeddings (text-embedding-3-small, 1536 dimensions) with idempotent processing to avoid duplicate costs. **Correlation Engine**: SQL-based Pearson correlation analysis runs nightly (3:00 AM UTC) via `insightsScheduler` to discover patterns like "HRV improves 15% when sleep >7.5h for 5+ nights" with confidence scoring (60-100%). **Insight Cards**: Categorized patterns (Sleep, Activity, Biomarkers, Recovery) stored in `insight_cards` table with supporting data and date ranges. **Flō Oracle Integration**: Top 5 most confident insights automatically injected into conversation context via `getRelevantInsights()`, enabling natural, data-driven health coaching. **API Endpoints**: `POST /api/insights/generate` (manual trigger), `GET /api/insights` (fetch with filters), `DELETE /api/insights/:id` (soft delete), `POST /api/embeddings/sync` (vectorize new data). **Performance**: Sub-millisecond vector search via IVFFlat index, deterministic pattern detection, ~$0.00014/month embedding costs per active user. See `RAG_INSIGHTS_SYSTEM.md` for complete documentation.

**Admin User Management:** Implements Role-Based Access Control (RBAC) with `free`, `premium`, and `admin` roles. The admin dashboard provides user management (search, filter, inline editing, deletion), system overview metrics, AI API usage tracking, and audit logs, with strict security measures.

**Billing & Payments:** Integrates Stripe for credit/debit card processing and Apple Pay, with dedicated database tables for customers, subscriptions, and payments.

**Logging System:** Production-safe structured logging is implemented server-side and client-side, with environment-aware configurations.

## External Dependencies

### Third-Party Services
- **Replit Platform Services:** Replit Auth, Replit AI Integrations (OpenAI proxy), Replit Object Storage (GCS-compatible).
- **Neon:** Serverless PostgreSQL database.
- **Supabase:** PostgreSQL with pgvector extension for RAG-powered semantic health data search (1536-dimensional embeddings with IVFFlat similarity index).
- **Google Cloud Storage:** For object storage.
- **Stripe:** Payment processing.
- **OpenAI:** GPT-4o and GPT-5 models for health insights and biomarker analysis, text-embedding-3-small for RAG vectorization (~$0.00014/month per user).
- **xAI (Grok):** grok-3-mini model for Flō Oracle conversational health coaching with RAG-injected insight context.
- **ElevenLabs:** Conversational AI platform for natural voice interactions with Flō Oracle.

### Key Technologies/Libraries
- **Frontend:** `@tanstack/react-query`, `wouter`, `@radix-ui/*`, `tailwindcss`, `react-hook-form`, `zod`, `date-fns`, `@capacitor/*`, `capacitor-secure-storage-plugin`, `@healthpilot/healthkit`.
- **Backend:** `express`, `drizzle-orm`, `@neondatabase/serverless`, `passport`, `openid-client`, `express-session`, `connect-pg-simple`, `@google-cloud/storage`, `openai`, `jose`, `jsonwebtoken`, `pdf-parse`, `apns2`.